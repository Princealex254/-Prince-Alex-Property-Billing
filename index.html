<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Property Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-primary {
            background: var(--primary-gradient);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-warning {
            background: var(--warning-gradient);
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(67, 233, 123, 0.4);
        }

        .btn-danger {
            background: var(--secondary-gradient);
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.4);
        }

        /* Custom styles for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 48rem;
            transform: scale(1);
            opacity: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
            background: var(--primary-gradient);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(229, 231, 235, 0.5);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: rgba(249, 250, 251, 0.5);
        }

        .loading-spinner {
            border-top-color: #667eea;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sidebar-gradient {
            background: var(--dark-gradient);
        }

        /* Scrollable Sidebar */
        #sidebar {
            overflow-y: auto;
            overflow-x: hidden;
        }

        #sidebar::-webkit-scrollbar {
            width: 6px;
        }

        #sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        #sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Ensure navigation takes full height and is scrollable */
        #sidebar nav {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            margin-right: -8px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .table-modern {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e2e8f0;
        }

        .dark-mode .glass-effect {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark-mode .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark-mode .table-modern {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .floating-action {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 40;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 60;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-gradient);
        }

        .notification.error {
            background: var(--secondary-gradient);
        }

        .notification.info {
            background: var(--primary-gradient);
        }

        /* Enhanced Form Styles */
        .form-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .dark-mode .form-label {
            color: #d1d5db;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .dark-mode .form-input {
            background: rgba(31, 41, 55, 0.8);
            border-color: #4b5563;
            color: #f9fafb;
        }

        .dark-mode .form-input:focus {
            border-color: #60a5fa;
            background: rgba(31, 41, 55, 0.95);
        }

        .form-select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .dark-mode .form-select {
            background: rgba(31, 41, 55, 0.8);
            border-color: #4b5563;
            color: #f9fafb;
        }

        .dark-mode .form-select:focus {
            border-color: #60a5fa;
            background: rgba(31, 41, 55, 0.95);
        }

        .form-textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            resize: vertical;
            min-height: 120px;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .dark-mode .form-textarea {
            background: rgba(31, 41, 55, 0.8);
            border-color: #4b5563;
            color: #f9fafb;
        }

        .dark-mode .form-textarea:focus {
            border-color: #60a5fa;
            background: rgba(31, 41, 55, 0.95);
        }

        .form-button {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .form-button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .form-button-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .form-button-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.3);
        }

        .form-button-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(240, 147, 251, 0.4);
        }

        .form-button-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .form-button-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(79, 172, 254, 0.4);
        }

        .form-button-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .form-button-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .form-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .form-subtitle {
            color: #6b7280;
            font-size: 16px;
        }

        .dark-mode .form-subtitle {
            color: #9ca3af;
        }

        .form-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            opacity: 0.8;
        }

        .form-help-text {
            font-size: 14px;
            color: #6b7280;
            margin-top: 8px;
            font-style: italic;
        }

        .dark-mode .form-help-text {
            color: #9ca3af;
        }

        .form-error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }

        .form-error::before {
            content: "⚠";
            margin-right: 8px;
        }

        .form-success {
            color: #10b981;
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }

        .form-success::before {
            content: "✓";
            margin-right: 8px;
        }

        .form-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .form-loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-floating-label {
            position: relative;
        }

        .form-floating-label .form-input {
            padding-top: 24px;
            padding-bottom: 8px;
        }

        .form-floating-label .form-label {
            position: absolute;
            top: 16px;
            left: 20px;
            transition: all 0.3s ease;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 0 8px;
            border-radius: 4px;
        }

        .form-floating-label .form-input:focus + .form-label,
        .form-floating-label .form-input:not(:placeholder-shown) + .form-label {
            top: -8px;
            font-size: 12px;
            color: #3b82f6;
        }

        .dark-mode .form-floating-label .form-label {
            background: rgba(31, 41, 55, 0.9);
        }

        /* Scrollable Forms */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding: 0 1rem;
            scroll-behavior: smooth;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .dark-mode .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .modal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
        }

        .dark-mode .modal-body::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Hamburger Menu Positioning */
        .menu-toggle-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            padding: 0.75rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .menu-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .dark-mode .menu-toggle-btn {
            background: rgba(31, 41, 55, 0.8);
            border-color: rgba(75, 85, 99, 0.3);
        }

        .dark-mode .menu-toggle-btn:hover {
            background: rgba(31, 41, 55, 0.9);
        }

        /* Show hamburger menu on large screens when sidebar is closed */
        @media (min-width: 1024px) {
            .menu-toggle-btn {
                display: block !important;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .menu-toggle-btn {
                top: 0.5rem;
                left: 0.5rem;
                padding: 0.5rem;
            }
        }

        /* Ensure modal content doesn't overflow */
        .modal-content {
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            flex-shrink: 0;
        }

        .modal-footer {
            flex-shrink: 0;
            margin-top: auto;
        }
    </style>
</head>
<body class="font-inter antialiased min-h-screen" id="body">
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="fixed top-4 right-4 z-50 p-3 rounded-full glass-effect hover:scale-110 transition-all duration-300 shadow-lg">
        <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
        </svg>
        <svg id="moonIcon" class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
    </button>

    <div id="app">
        <!-- Content will be dynamically loaded here by JavaScript -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="text-center glass-effect p-8 rounded-2xl">
                <div class="loading-spinner rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mx-auto"></div>
                <p class="mt-6 text-xl font-semibold gradient-text">Loading Property Management System...</p>
                <div class="mt-4 flex justify-center space-x-1">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="module">
        // Lucide Icons (as SVG strings for direct embedding)
        const icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            Users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            Building: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9.5 16h5"/><path d="M9.5 12h5"/><path d="M9.5 8h5"/><path d="M12 22V2"/></svg>`,
            Receipt: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2h-2.5a2 2 0 0 1-2-2H6.5a2 2 0 0 1-2 2H4Z"/><path d="M18 6H8"/><path d="M18 10H8"/><path d="M18 14H8"/><path d="M18 18H8"/></svg>`,
            PlusCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
            Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            LogOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            HomeIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`, // Reusing Home for HomeIcon
            Wallet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h12a2 2 0 0 0 2-2v-3"/><path d="M22 7V4a1 1 0 0 0-1-1H3a2 2 0 0 0 0 4h18a1 1 0 0 0 1-1Z"/></svg>`,
            Search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            DollarSign: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            Menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            Wrench: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wrench"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            AlertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`,
            Clock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>`,
            Download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            Upload: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`,
            Settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
            BarChart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`,
            Bell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>`,
            Archive: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>`
        };


        // Global State
        let user = { displayName: "Admin" };
        let userId = "local-user-for-testing";
        let currentPage = 'dashboard';
        let properties = [];
        let tenants = [];
        let bills = [];
        let payments = [];
        let leases = []; // New: Lease agreements
        let maintenanceRequests = []; // New: Maintenance requests
        let expenses = []; // New: Property expenses
        let notifications = []; // New: System notifications
        let documents = []; // New: Document storage
        let waterMeterReadings = []; // New: Water meter readings
        let activeTab = 'summary';
        let billingTenantSearchQuery = '';
        let selectedPropertyForBillingFilter = '';
        let billingHistoryFilterMonth = new Date().toISOString().substring(0, 7);
        let selectedPropertyForFinanceFilter = '';
        let isSidebarOpen = false;
        let propertyTenantSearchQueries = {};
        let isDarkMode = false;
        let charts = {}; // Store chart instances
        let currentView = 'dashboard'; // New: Current view tracking

        // Kenyan Rental Management Constants
        const houseTypes = ['Apartment', 'Bungalow', 'Mansionette', 'Commercial Space', 'Shop', 'Studio', 'Single Room', 'Self-Contained'];
        const leaseTypes = ['Monthly', 'Quarterly', 'Semi-Annual', 'Annual'];
        const maintenanceCategories = ['Plumbing', 'Electrical', 'Structural', 'Security', 'Cleaning', 'Landscaping', 'HVAC', 'Other'];
        const expenseCategories = ['Maintenance', 'Utilities', 'Insurance', 'Taxes', 'Legal', 'Marketing', 'Administrative', 'Repairs', 'Renovations'];
        const notificationTypes = ['Payment Due', 'Lease Expiry', 'Maintenance Request', 'Payment Received', 'System Alert'];
        const documentTypes = ['Lease Agreement', 'ID Copy', 'Payment Receipt', 'Maintenance Report', 'Insurance Document', 'Other'];
        const WATER_PRICE_PER_UNIT = 200;
        const SECURITY_DEPOSIT_MULTIPLIER = 2; // Usually 2 months rent
        const PENALTY_RATE = 0.05; // 5% penalty for late payments
        const GARBAGE_COLLECTION_FEE = 150; // Monthly garbage collection fee
        const WATER_METER_READING_INTERVAL = 30; // Days between meter readings

        // --- Modern Utility Functions ---
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, duration);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.getElementById('body');
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (isDarkMode) {
                body.classList.add('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                body.classList.remove('dark-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
            
            localStorage.setItem('darkMode', isDarkMode);
            renderDashboardPage(); // Re-render to apply dark mode styles
        }

        function initializeDarkMode() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                toggleDarkMode();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-KE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function createChart(canvasId, config) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            return new Chart(ctx, config);
        }


        // --- Local Storage Functions ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function saveToLocalStorage() {
            const data = {
                properties,
                tenants,
                bills,
                payments,
                leases,
                maintenanceRequests,
                expenses,
                notifications,
                documents,
                waterMeterReadings,
                lastBackup: new Date().toISOString()
            };
            
            localStorage.setItem('rentalData', JSON.stringify(data));
            
            // Also save individual arrays for backward compatibility
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('tenants', JSON.stringify(tenants));
            localStorage.setItem('bills', JSON.stringify(bills));
            localStorage.setItem('payments', JSON.stringify(payments));
        }

        function loadFromLocalStorage() {
            try {
                // Try to load from new consolidated storage first
                const rentalData = localStorage.getItem('rentalData');
                if (rentalData) {
                    const data = JSON.parse(rentalData);
                    properties = data.properties || [];
                    tenants = data.tenants || [];
                    bills = data.bills || [];
                    payments = data.payments || [];
                    leases = data.leases || [];
                    maintenanceRequests = data.maintenanceRequests || [];
                    expenses = data.expenses || [];
                    notifications = data.notifications || [];
                    documents = data.documents || [];
                    waterMeterReadings = data.waterMeterReadings || [];
                } else {
                    // Fallback to individual storage for backward compatibility
                    properties = JSON.parse(localStorage.getItem('properties')) || [];
                    tenants = JSON.parse(localStorage.getItem('tenants')) || [];
                    bills = JSON.parse(localStorage.getItem('bills')) || [];
                    payments = JSON.parse(localStorage.getItem('payments')) || [];
                    leases = [];
                    maintenanceRequests = [];
                    expenses = [];
                    notifications = [];
                    documents = [];
                    waterMeterReadings = [];
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
                // Clear corrupted data if parsing fails
                properties = [];
                tenants = [];
                bills = [];
                payments = [];
                leases = [];
                maintenanceRequests = [];
                expenses = [];
                notifications = [];
                documents = [];
                waterMeterReadings = [];
                saveToLocalStorage(); // Save empty arrays to clear corrupted data
                showModal("Data Error", "Corrupted local storage data detected and cleared. Please try adding data again.");
            }
        }

        // Backup and Restore Functions
        function exportData() {
            const data = {
                properties,
                tenants,
                bills,
                payments,
                leases,
                maintenanceRequests,
                expenses,
                notifications,
                documents,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rental-data-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.version && data.properties) {
                        properties = data.properties || [];
                        tenants = data.tenants || [];
                        bills = data.bills || [];
                        payments = data.payments || [];
                        leases = data.leases || [];
                        maintenanceRequests = data.maintenanceRequests || [];
                        expenses = data.expenses || [];
                        notifications = data.notifications || [];
                        documents = data.documents || [];
                        
                        saveToLocalStorage();
                        showNotification('Data imported successfully!', 'success');
                        renderDashboardPage(); // Refresh the interface
                    } else {
                        showNotification('Invalid backup file format', 'error');
                    }
                } catch (error) {
                    showNotification('Error importing data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Enhanced Modal Functions
        function showModal(title, content, type = 'alert', onConfirm = null) {
            const appDiv = document.getElementById('app');
            if (!appDiv) {
                console.error('App div not found');
                return;
            }

            let modalOverlay = document.querySelector('.modal-overlay');

            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                appDiv.appendChild(modalOverlay);
            }

            const contentElement = typeof content === 'string' ? `<p class="text-gray-700 dark:text-gray-300">${content}</p>` : content.outerHTML || '';

            modalOverlay.innerHTML = `
                <div class="modal-content max-w-2xl">
                    <div class="modal-header">
                        <h3 class="text-2xl font-bold text-white">${title}</h3>
                        <button class="text-white hover:text-gray-200 transition duration-200 modal-close-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${contentElement}
                    </div>
                    <div class="modal-footer">
                        ${type === 'confirm' ? `
                            <button class="form-button form-button-secondary modal-cancel-btn">
                                Cancel
                            </button>
                            <button class="form-button form-button-primary modal-confirm-btn">
                                Confirm
                            </button>
                        ` : `
                            <button class="form-button form-button-primary modal-close-btn">
                                OK
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            // Ensure modal is visible
            modalOverlay.style.display = 'flex';
            modalOverlay.style.opacity = '1';
            modalOverlay.style.visibility = 'visible';

            if (typeof content !== 'string') {
                const modalBody = modalOverlay.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = '';
                    modalBody.appendChild(content);
                }
            }

            const closeModal = () => {
                modalOverlay.style.display = 'none';
                modalOverlay.style.opacity = '0';
                modalOverlay.style.visibility = 'hidden';
                modalOverlay.innerHTML = '';
            };

            const closeBtn = modalOverlay.querySelector('.modal-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }

            if (type === 'confirm') {
                const cancelBtn = modalOverlay.querySelector('.modal-cancel-btn');
                const confirmBtn = modalOverlay.querySelector('.modal-confirm-btn');
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeModal);
                }
                
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', () => {
                        if (onConfirm) onConfirm();
                        closeModal();
                    });
                }
            }
        }


        // Initialize Application Data (from local storage)
        function initializeAppData() {
            loadFromLocalStorage();
            currentPage = 'dashboard';
            activeTab = 'summary'; // Set the correct initial tab
            renderDashboardPage();
        }

        // Render Functions
        function renderApp() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Clear existing content
            renderDashboardPage();
        }

        function renderDashboardPage() {
            const appDiv = document.getElementById('app');
            const userName = user?.displayName || "User";
            const totalProperties = properties.length;
            const totalTenants = tenants.length;
            const billsGenerated = bills.length;

            appDiv.innerHTML = `
                <div class="flex h-screen">
                    <!-- Sidebar Navigation -->
                    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 sidebar-gradient text-white flex flex-col p-6 shadow-2xl transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out">
                        <div class="flex items-center mb-8">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center mr-4">
                                <span class="text-white font-bold text-xl">PA</span>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold">Prince Alex</h1>
                                <p class="text-sm text-gray-300">Property Management</p>
                            </div>
                        </div>
                        <nav class="flex-grow">
                            <ul class="space-y-2">
                                <li>
                                    <button id="navSummary"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'summary' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Home}</span>
                                        <span class="font-medium">Dashboard Overview</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navProperties"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'properties' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Building}</span>
                                        <span class="font-medium">Properties & Tenants</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navLeases"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'leases' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.FileText}</span>
                                        <span class="font-medium">Lease Management</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navBilling"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'billing' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Receipt}</span>
                                        <span class="font-medium">Billing & Receipts</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navMaintenance"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'maintenance' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Wrench}</span>
                                        <span class="font-medium">Maintenance</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navFinance"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'finance' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.DollarSign}</span>
                                        <span class="font-medium">Financial Overview</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navReports"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'reports' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.BarChart}</span>
                                        <span class="font-medium">Reports & Analytics</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navSettings"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'settings' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Settings}</span>
                                        <span class="font-medium">Settings & Backup</span>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div class="mt-auto">
                            <div class="p-4 rounded-xl bg-white bg-opacity-10">
                                <p class="text-xs text-gray-300">User ID: ${userId || 'N/A'}</p>
                                <p class="text-sm font-medium">${userName}</p>
                            </div>
                        </div>
                    </aside>

                    <!-- Main Content Area -->
                    <main class="flex-1 overflow-auto p-8 ${isSidebarOpen ? 'lg:ml-64' : 'lg:ml-0'} transition-all duration-300 ease-in-out">
                        <!-- Header -->
                        <header class="glass-effect rounded-2xl shadow-lg p-6 mb-8 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl md:text-4xl font-bold gradient-text">Welcome back, ${userName}!</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Here's what's happening with your properties today</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button id="menuToggleBtn" class="menu-toggle-btn lg:hidden">
                                    ${isSidebarOpen ? icons.X : icons.Menu}
                                </button>
                                <div class="hidden lg:flex items-center text-gray-600 dark:text-gray-400 glass-effect px-4 py-2 rounded-xl">
                                    ${icons.Calendar}
                                    <span class="ml-2 font-medium">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                            </div>
                        </header>

                        <!-- Content Section based on activeTab -->
                        <div id="contentSection"></div>
                    </main>
                    
                    <!-- Floating Action Button -->
                    <div class="floating-action">
                        <div class="relative">
                            <button id="fabMain" class="w-14 h-14 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                                ${icons.PlusCircle}
                            </button>
                            <div id="fabMenu" class="absolute bottom-16 right-0 space-y-3 opacity-0 pointer-events-none transition-all duration-300 transform scale-95">
                                <button id="fabAddProperty" class="w-12 h-12 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Add Property">
                                    ${icons.Building}
                                </button>
                                <button id="fabAddTenant" class="w-12 h-12 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Add Tenant">
                                    ${icons.Users}
                                </button>
                                <button id="fabCreateLease" class="w-12 h-12 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Create Lease">
                                    ${icons.FileText}
                                </button>
                                <button id="fabMaintenanceRequest" class="w-12 h-12 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Maintenance Request">
                                    ${icons.Wrench}
                                </button>
                                <button id="fabGenerateBill" class="w-12 h-12 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Generate Bills">
                                    ${icons.Receipt}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for navigation
            document.getElementById('navSummary').addEventListener('click', () => { activeTab = 'summary'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navProperties').addEventListener('click', () => { activeTab = 'properties'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navLeases').addEventListener('click', () => { activeTab = 'leases'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navBilling').addEventListener('click', () => { activeTab = 'billing'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navMaintenance').addEventListener('click', () => { activeTab = 'maintenance'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navFinance').addEventListener('click', () => { activeTab = 'finance'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navReports').addEventListener('click', () => { activeTab = 'reports'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navSettings').addEventListener('click', () => { activeTab = 'settings'; isSidebarOpen = false; renderDashboardPage(); });
            // Removed logout button event listener
            // document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Add event listener for the new hamburger menu button
            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                renderDashboardPage(); // Re-render to apply sidebar class change
            });

            // Floating Action Button event listeners
            let fabMenuOpen = false;
            document.getElementById('fabMain').addEventListener('click', () => {
                const fabMenu = document.getElementById('fabMenu');
                fabMenuOpen = !fabMenuOpen;
                if (fabMenuOpen) {
                    fabMenu.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                    fabMenu.classList.add('opacity-100', 'pointer-events-auto', 'scale-100');
                } else {
                    fabMenu.classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                    fabMenu.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                }
            });

            document.getElementById('fabAddProperty').addEventListener('click', () => {
                showAddPropertyModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabAddTenant').addEventListener('click', () => {
                if (properties.length === 0) {
                    showNotification('Please add a property first before adding tenants', 'error');
                    return;
                }
                // Show property selection modal for adding tenant
                showAddTenantModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabCreateLease').addEventListener('click', () => {
                if (tenants.length === 0) {
                    showNotification('Please add tenants first before creating leases', 'error');
                    return;
                }
                showAddLeaseModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabMaintenanceRequest').addEventListener('click', () => {
                if (properties.length === 0) {
                    showNotification('Please add properties first before creating maintenance requests', 'error');
                    return;
                }
                showAddMaintenanceModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabGenerateBill').addEventListener('click', () => {
                activeTab = 'billing';
                isSidebarOpen = false;
                renderDashboardPage();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });


            // Render content based on active tab
            const contentSection = document.getElementById('contentSection');
            if (contentSection) {
                if (activeTab === 'summary') {
                    contentSection.innerHTML = renderSummarySection(totalProperties, totalTenants, billsGenerated);
                    // Initialize charts after DOM is updated
                    setTimeout(() => {
                        initializeCharts();
                    }, 100);
                } else if (activeTab === 'properties') {
                    renderPropertiesSection(contentSection);
                } else if (activeTab === 'leases') {
                    renderLeasesSection(contentSection);
                } else if (activeTab === 'billing') {
                    renderBillingSection(contentSection);
                } else if (activeTab === 'maintenance') {
                    renderMaintenanceSection(contentSection);
                } else if (activeTab === 'finance') {
                    renderFinancialSection(contentSection);
                } else if (activeTab === 'reports') {
                    renderReportsSection(contentSection);
                } else if (activeTab === 'settings') {
                    renderSettingsSection(contentSection);
                }
            }
        }

        function renderSummarySection(totalProperties, totalUnits, billsGenerated) {
            const totalRentExpected = tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalOutstanding = tenants.reduce((sum, tenant) => sum + tenant.outstandingBalance, 0);
            
            return `
                <section class="space-y-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${renderStatCard(icons.Building, "Total Properties", totalProperties, "properties", "bg-gradient-to-r from-blue-500 to-blue-600")}
                        ${renderStatCard(icons.HomeIcon, "Total Units", totalUnits, "units", "bg-gradient-to-r from-green-500 to-green-600")}
                        ${renderStatCard(icons.Users, "Total Tenants", tenants.length, "tenants", "bg-gradient-to-r from-purple-500 to-purple-600")}
                        ${renderStatCard(icons.Receipt, "Bills Generated", billsGenerated, "bills", "bg-gradient-to-r from-orange-500 to-orange-600")}
                    </div>

                    <!-- Financial Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${renderStatCard(icons.DollarSign, "Monthly Rent Expected", formatCurrency(totalRentExpected), "rent", "bg-gradient-to-r from-emerald-500 to-emerald-600")}
                        ${renderStatCard(icons.Wallet, "Total Collected", formatCurrency(totalPaid), "collected", "bg-gradient-to-r from-teal-500 to-teal-600")}
                        ${renderStatCard(icons.FileText, "Outstanding Balance", formatCurrency(totalOutstanding), "outstanding", "bg-gradient-to-r from-red-500 to-red-600")}
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-effect rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Revenue Overview</h3>
                            <canvas id="revenueChart" width="400" height="200"></canvas>
                        </div>
                        <div class="glass-effect rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Property Distribution</h3>
                            <canvas id="propertyChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="glass-effect rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Recent Activity</h3>
                        <div class="space-y-3">
                            ${getRecentActivity().map(activity => `
                                <div class="flex items-center space-x-3 p-3 rounded-lg bg-white bg-opacity-50 dark:bg-black dark:bg-opacity-20">
                                    <div class="w-2 h-2 rounded-full ${activity.type === 'payment' ? 'bg-green-500' : activity.type === 'bill' ? 'bg-blue-500' : 'bg-purple-500'}"></div>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">${activity.message}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-auto">${activity.time}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderStatCard(icon, title, value, id, gradientClass) {
            return `
                <div class="stat-card card-hover p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="p-4 rounded-xl ${gradientClass} text-white shadow-lg">
                                ${icon}
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">${title}</p>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${value}</h3>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="w-3 h-3 rounded-full bg-green-400 pulse-animation"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getRecentActivity() {
            const activities = [];
            
            // Add recent payments
            payments.slice(-3).forEach(payment => {
                activities.push({
                    type: 'payment',
                    message: `Payment of ${formatCurrency(payment.amount)} received from ${payment.tenantName}`,
                    time: formatDate(payment.paymentDate)
                });
            });
            
            // Add recent bills
            bills.slice(-3).forEach(bill => {
                activities.push({
                    type: 'bill',
                    message: `Bill generated for ${bill.tenantName} - ${formatCurrency(bill.amount)}`,
                    time: formatDate(bill.createdAt)
                });
            });
            
            // Add recent tenants
            tenants.slice(-3).forEach(tenant => {
                activities.push({
                    type: 'tenant',
                    message: `New tenant ${tenant.name} added to ${tenant.houseNumber}`,
                    time: formatDate(tenant.createdAt)
                });
            });
            
            // Add recent maintenance requests
            maintenanceRequests.slice(-3).forEach(request => {
                activities.push({
                    type: 'maintenance',
                    message: `Maintenance request: ${request.description}`,
                    time: formatDate(request.createdAt)
                });
            });
            
            return activities.sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 5);
        }

        // Lease Management Section
        function renderLeasesSection(parentEl) {
            parentEl.innerHTML = `
                <section class="glass-effect rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Lease Management</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Manage lease agreements and tenant contracts</p>
                        </div>
                        <button id="addLeaseBtn"
                            class="btn-primary text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">Create Lease</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        ${renderStatCard(icons.FileText, "Active Leases", leases.filter(l => l.status === 'active').length, "leases", "bg-gradient-to-r from-blue-500 to-blue-600")}
                        ${renderStatCard(icons.AlertTriangle, "Expiring Soon", getExpiringLeases().length, "expiring", "bg-gradient-to-r from-orange-500 to-orange-600")}
                        ${renderStatCard(icons.CheckCircle, "Renewed This Month", getRenewedLeases().length, "renewed", "bg-gradient-to-r from-green-500 to-green-600")}
                    </div>

                    <div id="leasesList" class="space-y-6">
                        ${leases.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 flex items-center justify-center">
                                    ${icons.FileText}
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Leases Yet</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Create lease agreements for your tenants</p>
                                <button onclick="document.getElementById('addLeaseBtn').click()" 
                                    class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    Create First Lease
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addLeaseBtn').addEventListener('click', () => showAddLeaseModal());
            updateLeasesList();
        }

        function getExpiringLeases() {
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
            
            return leases.filter(lease => {
                const endDate = new Date(lease.endDate);
                return lease.status === 'active' && endDate <= thirtyDaysFromNow;
            });
        }

        function getRenewedLeases() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return leases.filter(lease => {
                const renewalDate = new Date(lease.renewalDate);
                return renewalDate.getMonth() === currentMonth && renewalDate.getFullYear() === currentYear;
            });
        }

        function updateLeasesList() {
            const leasesListDiv = document.getElementById('leasesList');
            if (!leasesListDiv) return;

            if (leases.length === 0) {
                leasesListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No leases created yet.</p>`;
                return;
            }

            leasesListDiv.innerHTML = leases.map(lease => {
                const tenant = tenants.find(t => t.id === lease.tenantId);
                const property = properties.find(p => p.id === lease.propertyId);
                const statusColor = lease.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                                 lease.status === 'expired' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
                                 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                
                return `
                    <div class="glass-effect rounded-2xl p-6 shadow-lg card-hover">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-purple-500 to-pink-600 flex items-center justify-center text-white font-bold text-xl">
                                    ${tenant?.name?.charAt(0) || 'L'}
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200">${tenant?.name || 'Unknown Tenant'}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${property?.name || 'Unknown Property'} - ${tenant?.houseNumber || 'N/A'}</p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${formatCurrency(lease.monthlyRent)}/month</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">•</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${lease.leaseType}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 md:mt-0">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                    ${lease.status.charAt(0).toUpperCase() + lease.status.slice(1)}
                                </span>
                                <button data-lease-id="${lease.id}" class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800 transition duration-200" title="View Details">
                                    ${icons.Edit}
                                </button>
                                <button data-lease-id="${lease.id}" class="p-2 rounded-lg bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-800 transition duration-200" title="Renew Lease">
                                    ${icons.CheckCircle}
                                </button>
                                <button data-lease-id="${lease.id}" class="p-2 rounded-lg bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-800 transition duration-200" title="Terminate Lease">
                                    ${icons.X}
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Start Date</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatDate(lease.startDate)}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">End Date</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatDate(lease.endDate)}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Security Deposit</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(lease.securityDeposit)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners for lease actions
            leasesListDiv.querySelectorAll('button[data-lease-id]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const leaseId = e.currentTarget.dataset.leaseId;
                    const action = e.currentTarget.title;
                    
                    if (action === 'View Details') {
                        showLeaseDetailsModal(leaseId);
                    } else if (action === 'Renew Lease') {
                        showRenewLeaseModal(leaseId);
                    } else if (action === 'Terminate Lease') {
                        showTerminateLeaseModal(leaseId);
                    }
                });
            });
        }

        // Lease Modal Functions
        function showAddLeaseModal() {
            if (tenants.length === 0) {
                showNotification('Please add tenants first before creating leases', 'error');
                return;
            }

            const formContent = `
                <div class="form-header">
                    <h3 class="form-title">Create Lease Agreement</h3>
                    <p class="form-subtitle">Set up a new lease agreement for a tenant</p>
                </div>
                <form id="addLeaseForm">
                    <div class="form-group">
                        <label class="form-label" for="leaseTenant">Select Tenant</label>
                        <select id="leaseTenant" name="leaseTenant" class="form-select" required>
                            <option value="">Choose a tenant...</option>
                            ${tenants.map(tenant => {
                                const property = properties.find(p => p.id === tenant.propertyId);
                                return `<option value="${tenant.id}">${tenant.name} - ${property?.name} (${tenant.houseNumber})</option>`;
                            }).join('')}
                        </select>
                        <div class="form-help-text">Select the tenant for this lease agreement</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="leaseType">Lease Type</label>
                            <select id="leaseType" name="leaseType" class="form-select" required>
                                ${leaseTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                            <div class="form-help-text">Choose the lease duration</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="monthlyRent">Monthly Rent (Ksh)</label>
                            <input type="number" id="monthlyRent" name="monthlyRent" class="form-input" placeholder="0" required>
                            <div class="form-help-text">Enter monthly rent amount</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate" class="form-input" value="${new Date().toISOString().substring(0, 10)}" required>
                            <div class="form-help-text">Lease start date</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate" class="form-input" required>
                            <div class="form-help-text">Lease end date</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="securityDeposit">Security Deposit (Ksh)</label>
                        <input type="number" id="securityDeposit" name="securityDeposit" class="form-input" placeholder="0" required>
                        <div class="form-help-text">Usually 2 months rent as security deposit</div>
                    </div>
                </form>
            `;

            showModal("Create New Lease Agreement", formContent, 'confirm', () => {
                const form = document.getElementById('addLeaseForm');
                const selectedTenant = tenants.find(t => t.id === form.elements['leaseTenant'].value);
                
                if (!selectedTenant) {
                    showNotification('Please select a tenant', 'error');
                    return;
                }

                const leaseData = {
                    id: generateUniqueId(),
                    tenantId: selectedTenant.id,
                    propertyId: selectedTenant.propertyId,
                    leaseType: form.elements['leaseType'].value,
                    monthlyRent: parseFloat(form.elements['monthlyRent'].value),
                    startDate: form.elements['startDate'].value,
                    endDate: form.elements['endDate'].value,
                    securityDeposit: parseFloat(form.elements['securityDeposit'].value),
                    status: 'active',
                    createdAt: new Date().toISOString()
                };

                leases.push(leaseData);
                saveToLocalStorage();
                showNotification('Lease agreement created successfully!', 'success');
                updateLeasesList();
            });
        }

        function showLeaseDetailsModal(leaseId) {
            const lease = leases.find(l => l.id === leaseId);
            if (!lease) return;

            const tenant = tenants.find(t => t.id === lease.tenantId);
            const property = properties.find(p => p.id === lease.propertyId);

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Tenant</p>
                            <p class="font-semibold">${tenant?.name || 'Unknown'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Property</p>
                            <p class="font-semibold">${property?.name || 'Unknown'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Monthly Rent</p>
                            <p class="font-semibold">${formatCurrency(lease.monthlyRent)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Security Deposit</p>
                            <p class="font-semibold">${formatCurrency(lease.securityDeposit)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Start Date</p>
                            <p class="font-semibold">${formatDate(lease.startDate)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">End Date</p>
                            <p class="font-semibold">${formatDate(lease.endDate)}</p>
                        </div>
                    </div>
                </div>
            `;

            showModal("Lease Details", content, 'alert');
        }

        function showRenewLeaseModal(leaseId) {
            const lease = leases.find(l => l.id === leaseId);
            if (!lease) return;

            const formContent = `
                <form id="renewLeaseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="newEndDate">New End Date</label>
                        <input type="date" id="newEndDate" name="newEndDate" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="newMonthlyRent">New Monthly Rent (Ksh)</label>
                        <input type="number" id="newMonthlyRent" name="newMonthlyRent" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${lease.monthlyRent}" required>
                    </div>
                </form>
            `;

            showModal("Renew Lease Agreement", formContent, 'confirm', () => {
                const form = document.getElementById('renewLeaseForm');
                
                lease.endDate = form.elements['newEndDate'].value;
                lease.monthlyRent = parseFloat(form.elements['newMonthlyRent'].value);
                lease.renewalDate = new Date().toISOString();
                
                saveToLocalStorage();
                showNotification('Lease renewed successfully!', 'success');
                updateLeasesList();
            });
        }

        function showTerminateLeaseModal(leaseId) {
            const lease = leases.find(l => l.id === leaseId);
            if (!lease) return;

            const tenant = tenants.find(t => t.id === lease.tenantId);
            
            showModal("Terminate Lease", `Are you sure you want to terminate the lease agreement with ${tenant?.name || 'this tenant'}?`, 'confirm', () => {
                lease.status = 'terminated';
                lease.terminationDate = new Date().toISOString();
                
                saveToLocalStorage();
                showNotification('Lease terminated successfully!', 'success');
                updateLeasesList();
            });
        }

        // Maintenance Management Section
        function renderMaintenanceSection(parentEl) {
            parentEl.innerHTML = `
                <section class="glass-effect rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Maintenance Management</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Track and manage property maintenance requests</p>
                        </div>
                        <button id="addMaintenanceBtn"
                            class="btn-primary text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">New Request</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        ${renderStatCard(icons.Wrench, "Open Requests", maintenanceRequests.filter(r => r.status === 'open').length, "open", "bg-gradient-to-r from-orange-500 to-orange-600")}
                        ${renderStatCard(icons.Clock, "In Progress", maintenanceRequests.filter(r => r.status === 'in_progress').length, "progress", "bg-gradient-to-r from-blue-500 to-blue-600")}
                        ${renderStatCard(icons.CheckCircle, "Completed", maintenanceRequests.filter(r => r.status === 'completed').length, "completed", "bg-gradient-to-r from-green-500 to-green-600")}
                        ${renderStatCard(icons.AlertTriangle, "Urgent", maintenanceRequests.filter(r => r.priority === 'urgent').length, "urgent", "bg-gradient-to-r from-red-500 to-red-600")}
                    </div>

                    <div id="maintenanceList" class="space-y-6">
                        ${maintenanceRequests.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-orange-100 to-red-100 flex items-center justify-center">
                                    ${icons.Wrench}
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Maintenance Requests</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Track property maintenance and repairs</p>
                                <button onclick="document.getElementById('addMaintenanceBtn').click()" 
                                    class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    Create First Request
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addMaintenanceBtn').addEventListener('click', () => showAddMaintenanceModal());
            updateMaintenanceList();
        }

        function showAddMaintenanceModal() {
            const formContent = `
                <div class="form-header">
                    <h3 class="form-title">Create Maintenance Request</h3>
                    <p class="form-subtitle">Report a maintenance issue for a property</p>
                </div>
                <form id="addMaintenanceForm">
                    <div class="form-group">
                        <label class="form-label" for="maintenanceProperty">Property</label>
                        <select id="maintenanceProperty" name="maintenanceProperty" class="form-select" required>
                            <option value="">Select property...</option>
                            ${properties.map(property => `<option value="${property.id}">${property.name} - ${property.location}</option>`).join('')}
                        </select>
                        <div class="form-help-text">Select the property that needs maintenance</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="maintenanceCategory">Category</label>
                            <select id="maintenanceCategory" name="maintenanceCategory" class="form-select" required>
                                ${maintenanceCategories.map(category => `<option value="${category}">${category}</option>`).join('')}
                            </select>
                            <div class="form-help-text">Choose the maintenance category</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="maintenancePriority">Priority</label>
                            <select id="maintenancePriority" name="maintenancePriority" class="form-select" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                            <div class="form-help-text">Set the priority level</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="maintenanceDescription">Description</label>
                        <textarea id="maintenanceDescription" name="maintenanceDescription" class="form-textarea" placeholder="Describe the maintenance issue in detail..." required></textarea>
                        <div class="form-help-text">Provide a detailed description of the problem</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="maintenanceCost">Estimated Cost (Ksh)</label>
                        <input type="number" id="maintenanceCost" name="maintenanceCost" class="form-input" placeholder="0">
                        <div class="form-help-text">Enter estimated cost if known (optional)</div>
                    </div>
                </form>
            `;

            showModal("Create Maintenance Request", formContent, 'confirm', () => {
                const form = document.getElementById('addMaintenanceForm');
                
                const maintenanceData = {
                    id: generateUniqueId(),
                    propertyId: form.elements['maintenanceProperty'].value,
                    category: form.elements['maintenanceCategory'].value,
                    priority: form.elements['maintenancePriority'].value,
                    description: form.elements['maintenanceDescription'].value,
                    estimatedCost: parseFloat(form.elements['maintenanceCost'].value) || 0,
                    status: 'open',
                    createdAt: new Date().toISOString()
                };

                maintenanceRequests.push(maintenanceData);
                saveToLocalStorage();
                showNotification('Maintenance request created successfully!', 'success');
                updateMaintenanceList();
            });
        }

        function updateMaintenanceList() {
            const maintenanceListDiv = document.getElementById('maintenanceList');
            if (!maintenanceListDiv) return;

            if (maintenanceRequests.length === 0) {
                maintenanceListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No maintenance requests found.</p>`;
                return;
            }

            maintenanceListDiv.innerHTML = maintenanceRequests.map(request => {
                const property = properties.find(p => p.id === request.propertyId);
                const priorityColor = request.priority === 'urgent' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                                    request.priority === 'high' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' :
                                    request.priority === 'medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                
                const statusColor = request.status === 'open' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' :
                                  request.status === 'in_progress' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

                return `
                    <div class="glass-effect rounded-2xl p-6 shadow-lg card-hover">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 flex items-center justify-center text-white font-bold text-xl">
                                    ${request.category.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200">${request.category}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${property?.name || 'Unknown Property'}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${request.description}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 md:mt-0">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${priorityColor}">
                                    ${request.priority.charAt(0).toUpperCase() + request.priority.slice(1)}
                                </span>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                    ${request.status.replace('_', ' ').charAt(0).toUpperCase() + request.status.replace('_', ' ').slice(1)}
                                </span>
                                <button data-request-id="${request.id}" class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800 transition duration-200" title="Update Status">
                                    ${icons.Edit}
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Created</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatDate(request.createdAt)}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Cost</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(request.estimatedCost)}</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Category</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${request.category}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners for maintenance actions
            maintenanceListDiv.querySelectorAll('button[data-request-id]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const requestId = e.currentTarget.dataset.requestId;
                    showUpdateMaintenanceModal(requestId);
                });
            });
        }

        function showUpdateMaintenanceModal(requestId) {
            const request = maintenanceRequests.find(r => r.id === requestId);
            if (!request) return;

            const formContent = `
                <form id="updateMaintenanceForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="updateStatus">Status</label>
                        <select id="updateStatus" name="updateStatus" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="open" ${request.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="actualCost">Actual Cost (Ksh)</label>
                        <input type="number" id="actualCost" name="actualCost" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${request.actualCost || ''}" placeholder="Enter actual cost">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Add any notes about the maintenance work...">${request.notes || ''}</textarea>
                    </div>
                </form>
            `;

            showModal("Update Maintenance Request", formContent, 'confirm', () => {
                const form = document.getElementById('updateMaintenanceForm');
                
                request.status = form.elements['updateStatus'].value;
                request.actualCost = parseFloat(form.elements['actualCost'].value) || 0;
                request.notes = form.elements['notes'].value;
                request.updatedAt = new Date().toISOString();
                
                saveToLocalStorage();
                showNotification('Maintenance request updated successfully!', 'success');
                updateMaintenanceList();
            });
        }

        // Reports and Analytics Section
        function renderReportsSection(parentEl) {
            parentEl.innerHTML = `
                <section class="glass-effect rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Reports & Analytics</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Comprehensive insights into your rental business</p>
                        </div>
                        <button id="exportReportBtn"
                            class="btn-primary text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg mt-4 md:mt-0">
                            ${icons.Download} <span class="ml-2">Export Report</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Revenue Analytics -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Revenue Analytics</h4>
                            <canvas id="revenueAnalyticsChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Occupancy Rate -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Occupancy Rate</h4>
                            <canvas id="occupancyChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Maintenance Costs -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Maintenance Costs</h4>
                            <canvas id="maintenanceCostChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Tenant Satisfaction -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Key Metrics</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Average Rent</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${formatCurrency(getAverageRent())}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Collection Rate</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${getCollectionRate()}%</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Vacancy Rate</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${getVacancyRate()}%</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Maintenance Efficiency</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${getMaintenanceEfficiency()}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('exportReportBtn').addEventListener('click', () => exportReport());
            
            // Initialize report charts
            setTimeout(() => {
                initializeReportCharts();
            }, 100);
        }

        function getAverageRent() {
            if (tenants.length === 0) return 0;
            return tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0) / tenants.length;
        }

        function getCollectionRate() {
            const totalExpected = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const totalCollected = payments.reduce((sum, payment) => sum + payment.amount, 0);
            return totalExpected > 0 ? Math.round((totalCollected / totalExpected) * 100) : 0;
        }

        function getVacancyRate() {
            const totalUnits = tenants.length;
            const occupiedUnits = tenants.filter(tenant => tenant.outstandingBalance <= tenant.amountCharged).length;
            return totalUnits > 0 ? Math.round(((totalUnits - occupiedUnits) / totalUnits) * 100) : 0;
        }

        function getMaintenanceEfficiency() {
            const totalRequests = maintenanceRequests.length;
            const completedRequests = maintenanceRequests.filter(r => r.status === 'completed').length;
            return totalRequests > 0 ? Math.round((completedRequests / totalRequests) * 100) : 0;
        }

        function initializeReportCharts() {
            // Revenue Analytics Chart
            const revenueCtx = document.getElementById('revenueAnalyticsChart');
            if (revenueCtx) {
                const monthlyRevenue = getMonthlyRevenueData();
                charts.revenueAnalytics = createChart('revenueAnalyticsChart', {
                    type: 'bar',
                    data: {
                        labels: monthlyRevenue.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: monthlyRevenue.data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Occupancy Chart
            const occupancyCtx = document.getElementById('occupancyChart');
            if (occupancyCtx) {
                const occupancyData = getOccupancyData();
                charts.occupancy = createChart('occupancyChart', {
                    type: 'doughnut',
                    data: {
                        labels: ['Occupied', 'Vacant'],
                        datasets: [{
                            data: occupancyData,
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Maintenance Cost Chart
            const maintenanceCtx = document.getElementById('maintenanceCostChart');
            if (maintenanceCtx) {
                const maintenanceData = getMaintenanceCostData();
                charts.maintenanceCost = createChart('maintenanceCostChart', {
                    type: 'line',
                    data: {
                        labels: maintenanceData.labels,
                        datasets: [{
                            label: 'Maintenance Costs',
                            data: maintenanceData.data,
                            borderColor: 'rgba(245, 101, 101, 1)',
                            backgroundColor: 'rgba(245, 101, 101, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function getOccupancyData() {
            const totalUnits = tenants.length;
            const occupiedUnits = tenants.filter(tenant => tenant.outstandingBalance <= tenant.amountCharged).length;
            return [occupiedUnits, totalUnits - occupiedUnits];
        }

        function getMaintenanceCostData() {
            const last6Months = [];
            const costData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toISOString().substring(0, 7);
                
                last6Months.push(date.toLocaleDateString('en-KE', { month: 'short', year: 'numeric' }));
                
                const monthlyCost = maintenanceRequests
                    .filter(request => request.createdAt.startsWith(monthYear))
                    .reduce((sum, request) => sum + (request.actualCost || request.estimatedCost), 0);
                
                costData.push(monthlyCost);
            }
            
            return {
                labels: last6Months,
                data: costData
            };
        }

        function exportReport() {
            const reportData = {
                properties: properties.length,
                tenants: tenants.length,
                activeLeases: leases.filter(l => l.status === 'active').length,
                totalRevenue: payments.reduce((sum, p) => sum + p.amount, 0),
                outstandingBalance: tenants.reduce((sum, t) => sum + t.outstandingBalance, 0),
                maintenanceRequests: maintenanceRequests.length,
                averageRent: getAverageRent(),
                collectionRate: getCollectionRate(),
                vacancyRate: getVacancyRate(),
                maintenanceEfficiency: getMaintenanceEfficiency(),
                generatedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rental-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Report exported successfully!', 'success');
        }

        // Settings and Backup Section
        function renderSettingsSection(parentEl) {
            parentEl.innerHTML = `
                <section class="glass-effect rounded-2xl shadow-lg p-8">
                    <div class="mb-8">
                        <h3 class="text-3xl font-bold gradient-text">Settings & Data Management</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Manage your data, backup, and system preferences</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Data Management -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">Data Management</h4>
                            <div class="space-y-4">
                                <button id="exportDataBtn" class="w-full btn-primary text-white px-6 py-3 rounded-xl flex items-center justify-center font-medium">
                                    ${icons.Download} <span class="ml-2">Export All Data</span>
                                </button>
                                <button id="importDataBtn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-6 py-3 rounded-xl flex items-center justify-center font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">
                                    ${icons.Upload} <span class="ml-2">Import Data</span>
                                </button>
                                <input type="file" id="importFileInput" accept=".json" style="display: none;">
                                <button id="clearDataBtn" class="w-full btn-danger text-white px-6 py-3 rounded-xl flex items-center justify-center font-medium">
                                    ${icons.Trash2} <span class="ml-2">Clear All Data</span>
                                </button>
                            </div>
                        </div>

                        <!-- System Information -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">System Information</h4>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Properties</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${properties.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Tenants</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${tenants.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Leases</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${leases.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Maintenance Requests</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${maintenanceRequests.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Last Backup</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${localStorage.getItem('rentalData') ? 'Available' : 'Never'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">Preferences</h4>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Dark Mode</span>
                                    <button id="toggleDarkModeBtn" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-700 transition-colors duration-200">
                                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${isDarkMode ? 'translate-x-6' : 'translate-x-1'}"></span>
                                    </button>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Auto Backup</span>
                                    <button id="toggleAutoBackupBtn" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-700 transition-colors duration-200">
                                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 translate-x-1"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- About -->
                        <div class="glass-effect rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">About</h4>
                            <div class="space-y-4">
                                <div class="text-center">
                                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                                        PA
                                    </div>
                                    <h5 class="font-bold text-gray-800 dark:text-gray-200">Prince Alex Property Management</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Version 2.0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Comprehensive rental management system for Kenya</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;

            // Add event listeners
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importData(e.target.files[0]);
                }
            });
            document.getElementById('clearDataBtn').addEventListener('click', () => {
                showModal("Clear All Data", "Are you sure you want to clear all data? This action cannot be undone.", 'confirm', () => {
                    localStorage.clear();
                    location.reload();
                });
            });
            document.getElementById('toggleDarkModeBtn').addEventListener('click', toggleDarkMode);
        }

        function renderPropertiesSection(parentEl) {
            parentEl.innerHTML = `
                <section class="glass-effect rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Your Properties</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Manage your property portfolio and tenants</p>
                        </div>
                        <button id="addPropertyBtn"
                            class="btn-primary text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">Add Property</span>
                        </button>
                    </div>

                    <div id="propertiesList" class="space-y-6">
                        ${properties.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 flex items-center justify-center">
                                    ${icons.Building}
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Properties Yet</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Start building your property portfolio by adding your first property</p>
                                <button onclick="document.getElementById('addPropertyBtn').click()" 
                                    class="btn-primary text-white px-6 py-3 rounded-xl font-medium">
                                    Get Started
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addPropertyBtn').addEventListener('click', () => showAddPropertyModal());
            updatePropertiesList();
        }

        function updatePropertiesList() {
            const propertiesListDiv = document.getElementById('propertiesList');
            if (!propertiesListDiv) return;

            if (properties.length === 0) {
                propertiesListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No properties added yet. Click "Add Property" to get started!</p>`;
                return;
            }

            propertiesListDiv.innerHTML = properties.map(property => {
                const currentPropertySearchQuery = propertyTenantSearchQueries[property.id]?.toLowerCase() || '';
                const tenantsForProperty = tenants.filter(t => t.propertyId === property.id && (currentPropertySearchQuery === '' || t.name.toLowerCase().includes(currentPropertySearchQuery) || t.houseNumber.toLowerCase().includes(currentPropertySearchQuery))
                );

                return `
                    <div class="glass-effect rounded-2xl p-6 shadow-lg card-hover">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <div class="flex items-center space-x-4">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-xl">
                                    ${property.name.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200">${property.name}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${property.location}</p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${tenantsForProperty.length} tenants</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">•</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${formatCurrency(tenantsForProperty.reduce((sum, t) => sum + t.amountCharged, 0))}/month</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-4 md:mt-0">
                                <button data-property-id="${property.id}" class="btn-success text-white px-4 py-2 rounded-xl text-sm flex items-center font-medium">
                                    ${icons.PlusCircle} <span class="ml-1">Add Tenant</span>
                                </button>
                                <button data-property-id="${property.id}" class="btn-danger text-white px-4 py-2 rounded-xl text-sm flex items-center font-medium">
                                    ${icons.Trash2} <span class="ml-1">Delete</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative mb-6">
                            <input type="text" id="tenantSearchInput-${property.id}" data-property-id="${property.id}" placeholder="Search tenants by name or house number..." class="w-full pl-12 pr-4 py-3 border-0 rounded-xl glass-effect focus:ring-2 focus:ring-blue-500 focus:outline-none text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400" value="${currentPropertySearchQuery}">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                ${icons.Search}
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between mb-4">
                            <h5 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Tenants (${tenantsForProperty.length})</h5>
                            ${tenantsForProperty.length > 0 ? `
                                <div class="flex items-center space-x-2 text-sm">
                                    <span class="text-gray-500 dark:text-gray-400">Total Monthly:</span>
                                    <span class="font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(tenantsForProperty.reduce((sum, t) => sum + t.amountCharged, 0))}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${tenantsForProperty.length === 0 ? `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center">
                                    ${icons.Users}
                                </div>
                                <p class="text-gray-500 dark:text-gray-400">No tenants found for this property</p>
                            </div>
                        ` : `
                            <div class="table-modern overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700">
                                            <tr>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Tenant</th>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">House</th>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Type</th>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Rent</th>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Balance</th>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Phone</th>
                                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                            ${tenantsForProperty.map(tenant => {
                                                const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-green-600 dark:text-green-400';
                                                const balanceText = tenant.outstandingBalance > 0 ? `${formatCurrency(tenant.outstandingBalance)} Due` : 'Paid';
                                                return `
                                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200">
                                                        <td class="py-4 px-6 whitespace-nowrap">
                                                            <div class="flex items-center">
                                                                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm mr-3">
                                                                    ${tenant.name.charAt(0)}
                                                                </div>
                                                                <div>
                                                                    <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${tenant.name}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100 font-medium">${tenant.houseNumber}</td>
                                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${tenant.houseType}</td>
                                                        <td class="py-4 px-6 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-gray-100">${formatCurrency(tenant.amountCharged)}</td>
                                                        <td class="py-4 px-6 whitespace-nowrap text-sm ${balanceColor}">${balanceText}</td>
                                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${tenant.phoneNumber}</td>
                                                        <td class="py-4 px-6 whitespace-nowrap text-sm">
                                                            <div class="flex space-x-2">
                                                                <button data-tenant-id="${tenant.id}" class="payment-btn p-2 rounded-lg bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-800 transition duration-200" title="Record Payment">
                                                                    ${icons.Wallet}
                                                                </button>
                                                                <button data-tenant-id="${tenant.id}" class="water-meter-btn p-2 rounded-lg bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-400 hover:bg-cyan-200 dark:hover:bg-cyan-800 transition duration-200" title="Record Water Meter Reading">
                                                                    💧
                                                                </button>
                                                                <button data-tenant-id="${tenant.id}" class="edit-tenant-btn p-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800 transition duration-200" title="Edit Tenant">
                                                                    ${icons.Edit}
                                                                </button>
                                                                <button data-tenant-id="${tenant.id}" class="delete-tenant-btn p-2 rounded-lg bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-800 transition duration-200" title="Delete Tenant">
                                                                    ${icons.Trash2}
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            // Attach event listeners after rendering
            propertiesListDiv.querySelectorAll('.add-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    showAddTenantModal();
                });
            });

            propertiesListDiv.querySelectorAll('.delete-property-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.propertyId;
                    handleDeleteProperty(propertyId);
                });
            });

            propertiesListDiv.querySelectorAll('.edit-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    const tenantToEdit = tenants.find(t => t.id === tenantId);
                    if (tenantToEdit) showEditTenantModal(tenantToEdit);
                });
            });

            propertiesListDiv.querySelectorAll('.delete-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    handleDeleteTenant(tenantId);
                });
            });

            propertiesListDiv.querySelectorAll('.payment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    const tenant = tenants.find(t => t.id === tenantId);
                    if (tenant) showPaymentModal(tenant);
                });
            });

            propertiesListDiv.querySelectorAll('.water-meter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    const tenant = tenants.find(t => t.id === tenantId);
                    if (tenant) showWaterMeterReadingModal(tenant);
                });
            });
            // Attach event listeners for per-property search inputs
            propertiesListDiv.querySelectorAll('input[id^="tenantSearchInput-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const propertyId = e.target.dataset.propertyId;
                    propertyTenantSearchQueries[propertyId] = e.target.value;
                    updatePropertiesList(); // Re-render the list for the specific property
                });
            });

        }

        // Add Property Modal
        function showAddPropertyModal(propertyToEdit = null) {
            const isEditing = !!propertyToEdit;
            const title = isEditing ? 'Edit Property' : 'Add New Property';
            const buttonText = isEditing ? 'Save Changes' : 'Add Property';

            const formContent = `
                <div class="form-header">
                    <h3 class="form-title">${isEditing ? 'Edit Property' : 'Add New Property'}</h3>
                    <p class="form-subtitle">${isEditing ? 'Update property information' : 'Enter property details'}</p>
                </div>
                <form id="addEditPropertyForm">
                    <div class="form-group">
                        <label class="form-label" for="propertyName">Property Name</label>
                        <input type="text" id="propertyName" name="propertyName" class="form-input" value="${propertyToEdit ? propertyToEdit.name : ''}" placeholder="Enter property name" required>
                        <div class="form-help-text">Enter a descriptive name for the property</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="propertyLocation">Location</label>
                        <input type="text" id="propertyLocation" name="propertyLocation" class="form-input" value="${propertyToEdit ? propertyToEdit.location : ''}" placeholder="Enter property location" required>
                        <div class="form-help-text">Enter the full address or area name</div>
                    </div>
                </form>
            `;

            showModal(title, formContent, 'confirm', () => {
                const form = document.getElementById('addEditPropertyForm');
                const newPropertyData = {
                    id: isEditing ? propertyToEdit.id : generateUniqueId(),
                    name: form.elements['propertyName'].value,
                    location: form.elements['propertyLocation'].value,
                    createdAt: new Date().toISOString()
                };

                try {
                    if (isEditing) {
                        const index = properties.findIndex(p => p.id === propertyToEdit.id);
                        if (index !== -1) {
                            properties[index] = newPropertyData;
                        }
                        showNotification("Property updated successfully!", "success");
                    } else {
                        properties.push(newPropertyData);
                        showNotification("Property added successfully!", "success");
                    }
                    saveToLocalStorage();
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantDropdown(); // Update dropdowns that depend on properties
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error saving property: ", e);
                    showModal("Error", `Failed to save property: ${e.message}`);
                }
            });
        }

        // Delete Property Handler
        function handleDeleteProperty(propertyId) {
            const propertyToDelete = properties.find(p => p.id === propertyId);
            if (!propertyToDelete) {
                showModal("Error", "Property not found.");
                return;
            }
            showModal("Confirm Deletion", `Are you sure you want to delete the property '${propertyToDelete.name}'? This will also delete all associated tenants and bills.`, 'confirm', () => {
                try {
                    // Filter out the property
                    properties = properties.filter(p => p.id !== propertyId);
                    // Filter out associated tenants
                    tenants = tenants.filter(t => t.propertyId !== propertyId);
                    // Filter out associated bills
                    bills = bills.filter(b => b.propertyId !== propertyId);
                    // Filter out associated payments
                    payments = payments.filter(p => p.propertyId !== propertyId);

                    saveToLocalStorage();
                    showNotification(`Property '${propertyToDelete.name}' and all associated data deleted successfully.`, "success");
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantDropdown(); // Update dropdowns
                    updateGeneratedBillsList(); // Update bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting property: ", e);
                    showModal("Error", `Failed to delete property: ${e.message}`);
                }
            });
        }

        // Fresh Add Tenant Modal Implementation
        function showAddTenantModal() {
            if (properties.length === 0) {
                showNotification('Please add a property first before adding tenants', 'error');
                return;
            }

            const modalHTML = `
                <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; font-size: 24px; font-weight: bold;">Add New Tenant</h3>
                            <button class="close-btn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; position: absolute; top: 15px; right: 20px;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 30px;">
                            <form id="addTenantForm">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Select Property</label>
                                    <select id="propertySelect" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                        <option value="">Choose a property...</option>
                                        ${properties.map(property => `<option value="${property.id}">${property.name} - ${property.location}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tenant Name</label>
                                        <input type="text" id="tenantName" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="Enter full name" required>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">House/Unit Number</label>
                                        <input type="text" id="houseNumber" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="e.g., A1, 2B" required>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">House Type</label>
                                        <select id="houseType" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                            <option value="">Select type...</option>
                                            ${houseTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Monthly Rent (Ksh)</label>
                                        <input type="number" id="rentAmount" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="0" required>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Phone Number</label>
                                    <input type="tel" id="phoneNumber" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="+254 700 000 000" required>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Initial Water Meter Reading</label>
                                        <input type="number" id="initialWaterMeter" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="0" value="0">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Water Meter Number</label>
                                        <input type="text" id="waterMeterNumber" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="e.g., WM001">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 30px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Billing Preferences</label>
                                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="includeWater" checked style="transform: scale(1.2);">
                                            <span>Include Water Bill (Ksh ${WATER_PRICE_PER_UNIT}/unit)</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="includeGarbage" checked style="transform: scale(1.2);">
                                            <span>Include Garbage Collection (Ksh ${GARBAGE_COLLECTION_FEE}/month)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                                    <button type="button" class="cancel-btn" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Add Tenant</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Add the modal to the page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add event listeners
            const modal = document.querySelector('.modal-overlay');
            const closeBtn = modal.querySelector('.close-btn');
            const cancelBtn = modal.querySelector('.cancel-btn');
            const form = modal.querySelector('#addTenantForm');

            const closeModal = () => {
                modal.remove();
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Handle form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const propertyId = document.getElementById('propertySelect').value;
                const tenantName = document.getElementById('tenantName').value;
                const houseNumber = document.getElementById('houseNumber').value;
                const houseType = document.getElementById('houseType').value;
                const rentAmount = parseFloat(document.getElementById('rentAmount').value);
                const phoneNumber = document.getElementById('phoneNumber').value;
                const initialWaterMeter = parseFloat(document.getElementById('initialWaterMeter').value) || 0;
                const waterMeterNumber = document.getElementById('waterMeterNumber').value;
                const includeWater = document.getElementById('includeWater').checked;
                const includeGarbage = document.getElementById('includeGarbage').checked;

                if (!propertyId || !tenantName || !houseNumber || !houseType || !rentAmount || !phoneNumber) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                const selectedProperty = properties.find(p => p.id === propertyId);
                if (!selectedProperty) {
                    showNotification('Selected property not found', 'error');
                    return;
                }

                // Create new tenant
                const newTenant = {
                    id: generateUniqueId(),
                    propertyId: propertyId,
                    name: tenantName,
                    houseNumber: houseNumber,
                    houseType: houseType,
                    amountCharged: rentAmount,
                    phoneNumber: phoneNumber,
                    outstandingBalance: 0,
                    lastBilledDate: null,
                    lastPaidDate: null,
                    createdAt: new Date().toISOString(),
                    // Water meter data
                    waterMeterNumber: waterMeterNumber,
                    initialWaterMeterReading: initialWaterMeter,
                    currentWaterMeterReading: initialWaterMeter,
                    lastWaterMeterReadingDate: new Date().toISOString(),
                    // Billing preferences
                    includeWaterBill: includeWater,
                    includeGarbageCollection: includeGarbage,
                    // Monthly billing tracking
                    nextBillingDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
                };

                tenants.push(newTenant);
                
                // Create initial water meter reading record
                if (initialWaterMeter > 0) {
                    const waterReading = {
                        id: generateUniqueId(),
                        tenantId: newTenant.id,
                        tenantName: tenantName,
                        propertyId: propertyId,
                        houseNumber: houseNumber,
                        waterMeterNumber: waterMeterNumber,
                        readingValue: initialWaterMeter,
                        readingDate: new Date().toISOString(),
                        isInitialReading: true,
                        createdAt: new Date().toISOString()
                    };
                    waterMeterReadings.push(waterReading);
                }
                
                saveToLocalStorage();
                
                showNotification('Tenant added successfully!', 'success');
                closeModal();
                
                // Refresh the properties list
                updatePropertiesList();
                updateBillingTenantList();
                renderFinancialSection(document.getElementById('contentSection'));
            });
        }

        // Edit Tenant Modal Implementation
        function showEditTenantModal(tenantToEdit) {
            const property = properties.find(p => p.id === tenantToEdit.propertyId);
            
            const modalHTML = `
                <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; font-size: 24px; font-weight: bold;">Edit Tenant Details</h3>
                            <button class="close-btn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; position: absolute; top: 15px; right: 20px;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 30px;">
                            <form id="editTenantForm">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Property</label>
                                    <input type="text" value="${property ? property.name : 'Unknown'}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; background: #f9fafb;" readonly>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Tenant Name</label>
                                        <input type="text" id="editTenantName" value="${tenantToEdit.name}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">House/Unit Number</label>
                                        <input type="text" id="editHouseNumber" value="${tenantToEdit.houseNumber}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">House Type</label>
                                        <select id="editHouseType" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                            ${houseTypes.map(type => `<option value="${type}" ${tenantToEdit.houseType === type ? 'selected' : ''}>${type}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Monthly Rent (Ksh)</label>
                                        <input type="number" id="editRentAmount" value="${tenantToEdit.amountCharged}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 30px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Phone Number</label>
                                    <input type="tel" id="editPhoneNumber" value="${tenantToEdit.phoneNumber}" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" required>
                                </div>
                                
                                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                                    <button type="button" class="cancel-btn" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Add the modal to the page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add event listeners
            const modal = document.querySelector('.modal-overlay');
            const closeBtn = modal.querySelector('.close-btn');
            const cancelBtn = modal.querySelector('.cancel-btn');
            const form = modal.querySelector('#editTenantForm');

            const closeModal = () => {
                modal.remove();
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Handle form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const tenantName = document.getElementById('editTenantName').value;
                const houseNumber = document.getElementById('editHouseNumber').value;
                const houseType = document.getElementById('editHouseType').value;
                const rentAmount = parseFloat(document.getElementById('editRentAmount').value);
                const phoneNumber = document.getElementById('editPhoneNumber').value;

                if (!tenantName || !houseNumber || !houseType || !rentAmount || !phoneNumber) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }

                // Update tenant data
                const tenantIndex = tenants.findIndex(t => t.id === tenantToEdit.id);
                if (tenantIndex !== -1) {
                    tenants[tenantIndex].name = tenantName;
                    tenants[tenantIndex].houseNumber = houseNumber;
                    tenants[tenantIndex].houseType = houseType;
                    tenants[tenantIndex].amountCharged = rentAmount;
                    tenants[tenantIndex].phoneNumber = phoneNumber;
                }

                saveToLocalStorage();
                
                showNotification('Tenant updated successfully!', 'success');
                closeModal();
                
                // Refresh the properties list
                updatePropertiesList();
                updateBillingTenantList();
                renderFinancialSection(document.getElementById('contentSection'));
            });
        }

        // Water Meter Reading Modal
        function showWaterMeterReadingModal(tenant) {
            const property = properties.find(p => p.id === tenant.propertyId);
            
            const modalHTML = `
                <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; font-size: 24px; font-weight: bold;">Record Water Meter Reading</h3>
                            <button class="close-btn" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; position: absolute; top: 15px; right: 20px;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 30px;">
                            <form id="waterMeterForm">
                                <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0; color: #0369a1;">Tenant Information</h4>
                                    <p style="margin: 5px 0; color: #374151;"><strong>Name:</strong> ${tenant.name}</p>
                                    <p style="margin: 5px 0; color: #374151;"><strong>House:</strong> ${tenant.houseNumber}</p>
                                    <p style="margin: 5px 0; color: #374151;"><strong>Property:</strong> ${property ? property.name : 'Unknown'}</p>
                                    <p style="margin: 5px 0; color: #374151;"><strong>Meter Number:</strong> ${tenant.waterMeterNumber || 'Not set'}</p>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Current Meter Reading</label>
                                    <input type="number" id="currentReading" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="Enter current reading" required>
                                    <small style="color: #6b7280; margin-top: 5px; display: block;">Last reading: ${tenant.currentWaterMeterReading || 0} units</small>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Reading Date</label>
                                    <input type="date" id="readingDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" value="${new Date().toISOString().substring(0, 10)}" required>
                                </div>
                                
                                <div style="margin-bottom: 30px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0; color: #92400e;">Estimated Bill</h4>
                                    <div id="billEstimate" style="color: #374151;">
                                        <p style="margin: 5px 0;">Water units used: <span id="unitsUsed">0</span></p>
                                        <p style="margin: 5px 0;">Water cost: Ksh <span id="waterCost">0</span></p>
                                        <p style="margin: 5px 0;">Garbage fee: Ksh <span id="garbageCost">${tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0}</span></p>
                                        <p style="margin: 5px 0; font-weight: bold;">Total: Ksh <span id="totalCost">0</span></p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                                    <button type="button" class="cancel-btn" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; cursor: pointer;">Cancel</button>
                                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Record Reading</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Add the modal to the page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add event listeners
            const modal = document.querySelector('.modal-overlay');
            const closeBtn = modal.querySelector('.close-btn');
            const cancelBtn = modal.querySelector('.cancel-btn');
            const form = modal.querySelector('#waterMeterForm');
            const currentReadingInput = modal.querySelector('#currentReading');

            const closeModal = () => {
                modal.remove();
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Calculate bill estimate when reading changes
            const updateBillEstimate = () => {
                const currentReading = parseFloat(currentReadingInput.value) || 0;
                const lastReading = tenant.currentWaterMeterReading || 0;
                const unitsUsed = Math.max(0, currentReading - lastReading);
                const waterCost = unitsUsed * WATER_PRICE_PER_UNIT;
                const garbageCost = tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0;
                const totalCost = waterCost + garbageCost;

                document.getElementById('unitsUsed').textContent = unitsUsed;
                document.getElementById('waterCost').textContent = waterCost.toFixed(2);
                document.getElementById('garbageCost').textContent = garbageCost;
                document.getElementById('totalCost').textContent = totalCost.toFixed(2);
            };

            currentReadingInput.addEventListener('input', updateBillEstimate);

            // Handle form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const currentReading = parseFloat(document.getElementById('currentReading').value);
                const readingDate = document.getElementById('readingDate').value;

                if (!currentReading || currentReading < 0) {
                    showNotification('Please enter a valid meter reading', 'error');
                    return;
                }

                if (currentReading < tenant.currentWaterMeterReading) {
                    showNotification('New reading cannot be less than previous reading', 'error');
                    return;
                }

                // Create water meter reading record
                const waterReading = {
                    id: generateUniqueId(),
                    tenantId: tenant.id,
                    tenantName: tenant.name,
                    propertyId: tenant.propertyId,
                    houseNumber: tenant.houseNumber,
                    waterMeterNumber: tenant.waterMeterNumber,
                    readingValue: currentReading,
                    readingDate: new Date(readingDate).toISOString(),
                    previousReading: tenant.currentWaterMeterReading,
                    unitsUsed: currentReading - (tenant.currentWaterMeterReading || 0),
                    waterCost: (currentReading - (tenant.currentWaterMeterReading || 0)) * WATER_PRICE_PER_UNIT,
                    createdAt: new Date().toISOString()
                };

                waterMeterReadings.push(waterReading);

                // Update tenant's current reading
                const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                if (tenantIndex !== -1) {
                    tenants[tenantIndex].currentWaterMeterReading = currentReading;
                    tenants[tenantIndex].lastWaterMeterReadingDate = new Date(readingDate).toISOString();
                }

                saveToLocalStorage();
                
                showNotification('Water meter reading recorded successfully!', 'success');
                closeModal();
                
                // Refresh the properties list
                updatePropertiesList();
            });
        }

        // Delete Tenant Handler
        function handleDeleteTenant(tenantId) {
            const tenantToDelete = tenants.find(t => t.id === tenantId);
            if (!tenantToDelete) {
                showModal("Error", "Tenant not found.");
                return;
            }
            showModal("Confirm Deletion", `Are you sure you want to delete the tenant '${tenantToDelete.name}' from house '${tenantToDelete.houseNumber}'? This action cannot be undone.`, 'confirm', () => {
                try {
                    tenants = tenants.filter(t => t.id !== tenantId);
                    // Also remove associated bills and payments for this tenant
                    bills = bills.filter(b => b.tenantId !== tenantId);
                    payments = payments.filter(p => p.tenantId !== tenantId);

                    saveToLocalStorage();
                    showModal("Success", "Tenant deleted successfully!");
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantList(); // Re-render billing tenant list
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting tenant: ", e);
                    showModal("Error", `Failed to delete tenant: ${e.message}`);
                }
            });
        }


        // Payment Modal
        function showPaymentModal(tenant) {
            const formContent = `
                <div class="form-header">
                    <h3 class="form-title">Record Payment</h3>
                    <p class="form-subtitle">Record a payment from ${tenant.name}</p>
                </div>
                <form id="paymentForm">
                    <div class="form-group">
                        <label class="form-label">Tenant Information</label>
                        <div class="bg-blue-50 dark:bg-blue-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">${tenant.name}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">House: ${tenant.houseNumber}</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Outstanding Balance</label>
                        <div class="bg-red-50 dark:bg-red-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-xl font-bold text-red-600 dark:text-red-400">${formatCurrency(tenant.outstandingBalance)}</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="paymentAmount">Payment Amount (Ksh)</label>
                            <input type="number" id="paymentAmount" name="paymentAmount" class="form-input" step="0.01" min="0" value="${tenant.outstandingBalance.toFixed(2)}" required>
                            <div class="form-help-text">Enter the amount being paid</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="paymentDate">Date of Payment</label>
                            <input type="date" id="paymentDate" name="paymentDate" class="form-input" value="${new Date().toISOString().substring(0, 10)}" required>
                            <div class="form-help-text">Select the payment date</div>
                        </div>
                    </div>
                </form>
            `;

            showModal("Record Payment", formContent, 'confirm', () => {
                const form = document.getElementById('paymentForm');
                const paymentAmount = parseFloat(form.elements['paymentAmount'].value);
                const paymentDate = form.elements['paymentDate'].value;

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showModal("Error", "Please enter a valid payment amount.");
                    return;
                }

                try {
                    const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                    if (tenantIndex !== -1) {
                        tenants[tenantIndex].outstandingBalance -= paymentAmount;
                        tenants[tenantIndex].lastPaidDate = new Date(paymentDate).toISOString();
                    }

                    // Add a new payment record
                    const paymentRecord = {
                        id: generateUniqueId(),
                        tenantId: tenant.id,
                        tenantName: tenant.name,
                        propertyId: tenant.propertyId,
                        houseNumber: tenant.houseNumber,
                        amount: paymentAmount,
                        paymentDate: new Date(paymentDate).toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    payments.push(paymentRecord);

                    saveToLocalStorage();
                    showModal("Success", `Payment of Ksh ${paymentAmount.toFixed(2)} recorded successfully! New balance is Ksh ${tenants[tenantIndex].outstandingBalance.toFixed(2)}.`);
                    updatePropertiesList(); // Re-render properties section to update balance display
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error recording payment: ", e);
                    showModal("Error", `Failed to record payment: ${e.message}`);
                }
            });
        }


        // Render Billing Section
        function renderBillingSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Generate Bills</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                            <div class="relative w-full md:w-auto">
                                <input type="text" id="billingTenantSearch" placeholder="Search tenants..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${billingTenantSearchQuery}">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    ${icons.Search}
                                </div>
                            </div>
                            <select id="billingPropertyFilter" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Filter by Property</option>
                                ${properties.map(p => `<option value="${p.id}" ${selectedPropertyForBillingFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <button id="generateBillsBtn"
                                class="bg-blue-600 text-white px-5 py-2 rounded-lg flex items-center justify-center hover:bg-blue-700 transition duration-200 shadow-md">
                                ${icons.PlusCircle} <span class="ml-2">Generate Bills</span>
                            </button>
                        </div>
                    </div>
                    <div id="tenantsToBillList" class="space-y-4">
                        <!-- Tenant list will be rendered here -->
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Bills History</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mb-4">
                            <input type="month" id="billingHistoryMonthFilter" value="${billingHistoryFilterMonth}" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button id="showAllBillsBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200">Show All Bills</button>
                        </div>
                        <div id="billsHistoryList" class="space-y-4">
                            <!-- Bills history will be rendered here -->
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('billingTenantSearch').addEventListener('input', (e) => {
                billingTenantSearchQuery = e.target.value;
                updateBillingTenantList();
            });

            document.getElementById('billingPropertyFilter').addEventListener('change', (e) => {
                selectedPropertyForBillingFilter = e.target.value;
                updateBillingTenantList();
            });

            document.getElementById('generateBillsBtn').addEventListener('click', handleGenerateBills);
            document.getElementById('billingHistoryMonthFilter').addEventListener('change', (e) => {
                billingHistoryFilterMonth = e.target.value;
                updateGeneratedBillsList();
            });
            document.getElementById('showAllBillsBtn').addEventListener('click', () => {
                billingHistoryFilterMonth = '';
                document.getElementById('billingHistoryMonthFilter').value = '';
                updateGeneratedBillsList();
            });

            updateBillingTenantList();
            updateGeneratedBillsList();
        }

        function updateBillingTenantList() {
            const tenantsToBillListDiv = document.getElementById('tenantsToBillList');
            if (!tenantsToBillListDiv) return;

            const filteredTenants = tenants.filter(tenant => {
                const matchesSearch = tenant.name.toLowerCase().includes(billingTenantSearchQuery.toLowerCase()) || tenant.houseNumber.toLowerCase().includes(billingTenantSearchQuery.toLowerCase());
                const matchesProperty = selectedPropertyForBillingFilter === '' || tenant.propertyId === selectedPropertyForBillingFilter;
                return matchesSearch && matchesProperty;
            });

            if (filteredTenants.length === 0) {
                tenantsToBillListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No matching tenants found to bill.</p>`;
                return;
            }

            tenantsToBillListDiv.innerHTML = `
                <p class="text-gray-600">Select tenants to generate a bill for the current month:</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">
                                    <input type="checkbox" id="selectAllTenants" class="form-checkbox h-4 w-4 text-blue-600">
                                </th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Last Billed</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredTenants.map(tenant => {
                                const lastBilledDate = tenant.lastBilledDate ? new Date(tenant.lastBilledDate).toLocaleDateString() : 'Never';
                                const property = properties.find(p => p.id === tenant.propertyId)?.name || 'N/A';
                                const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600' : 'text-green-600';
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm">
                                            <input type="checkbox" name="tenantToBill" value="${tenant.id}" class="form-checkbox h-4 w-4 text-blue-600">
                                        </td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.name}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.houseNumber}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm font-medium ${balanceColor}">Ksh ${tenant.outstandingBalance.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500">${lastBilledDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Add event listener for "select all" checkbox
            document.getElementById('selectAllTenants').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('input[name="tenantToBill"]');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
        }

        async function handleGenerateBills() {
            const selectedTenantIds = Array.from(document.querySelectorAll('input[name="tenantToBill"]:checked')).map(cb => cb.value);

            if (selectedTenantIds.length === 0) {
                showModal("Error", "Please select at least one tenant to bill.");
                return;
            }

            const currentMonthYear = new Date().toISOString().substring(0, 7); // e.g., "2024-05"

            // Check if bills have already been generated for this month
            const alreadyBilledTenants = bills.filter(bill =>
                selectedTenantIds.includes(bill.tenantId) && bill.billingPeriod === currentMonthYear
            ).map(bill => tenants.find(t => t.id === bill.tenantId)?.name || 'Unknown Tenant');

            if (alreadyBilledTenants.length > 0) {
                showModal("Warning", `Bills have already been generated for the current month for the following tenants: ${alreadyBilledTenants.join(', ')}. Please unselect them to avoid double billing.`);
                return;
            }

            // Show water meter reading modal for each selected tenant
            const tenantsToBill = tenants.filter(t => selectedTenantIds.includes(t.id));
            await showWaterMeterReadingForBilling(tenantsToBill, currentMonthYear);
        }

        async function showWaterMeterReadingForBilling(tenantsToBill, currentMonthYear) {
            if (tenantsToBill.length === 0) {
                showNotification('No tenants selected for billing', 'error');
                return;
            }

            const tenant = tenantsToBill[0];
            const property = properties.find(p => p.id === tenant.propertyId);
            
            const modalHTML = `
                <div class="modal-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; font-size: 24px; font-weight: bold;">Water Meter Reading & Bill Generation</h3>
                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Tenant ${tenantsToBill.indexOf(tenant) + 1} of ${tenantsToBill.length}</p>
                        </div>
                        <div class="modal-body" style="padding: 30px;">
                            <form id="waterMeterBillingForm">
                                <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0; color: #0369a1;">Tenant Information</h4>
                                    <p style="margin: 5px 0; color: #374151;"><strong>Name:</strong> ${tenant.name}</p>
                                    <p style="margin: 5px 0; color: #374151;"><strong>House:</strong> ${tenant.houseNumber}</p>
                                    <p style="margin: 5px 0; color: #374151;"><strong>Property:</strong> ${property ? property.name : 'Unknown'}</p>
                                    <p style="margin: 5px 0; color: #374151;"><strong>Meter Number:</strong> ${tenant.waterMeterNumber || 'Not set'}</p>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Current Water Meter Reading</label>
                                    <input type="number" id="currentReading" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" placeholder="Enter current reading" required>
                                    <small style="color: #6b7280; margin-top: 5px; display: block;">Last reading: ${tenant.currentWaterMeterReading || 0} units</small>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Reading Date</label>
                                    <input type="date" id="readingDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px;" value="${new Date().toISOString().substring(0, 10)}" required>
                                </div>
                                
                                <div style="margin-bottom: 30px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                                    <h4 style="margin: 0 0 10px 0; color: #92400e;">Bill Calculation</h4>
                                    <div id="billCalculation" style="color: #374151;">
                                        <p style="margin: 5px 0;"><strong>Base Rent:</strong> Ksh <span id="baseRent">${tenant.amountCharged}</span></p>
                                        <p style="margin: 5px 0;">Water units used: <span id="unitsUsed">0</span></p>
                                        <p style="margin: 5px 0;">Water cost: Ksh <span id="waterCost">0</span></p>
                                        <p style="margin: 5px 0;">Garbage fee: Ksh <span id="garbageCost">${tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0}</span></p>
                                        <hr style="margin: 10px 0; border: 1px solid #e5e7eb;">
                                        <p style="margin: 5px 0; font-weight: bold; font-size: 18px;">Total Bill: Ksh <span id="totalBill">${tenant.amountCharged}</span></p>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                                    <button type="button" class="cancel-btn" style="padding: 12px 24px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-size: 16px; cursor: pointer;">Skip This Tenant</button>
                                    <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">Generate Bill</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing modal
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            // Add the modal to the page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Add event listeners
            const modal = document.querySelector('.modal-overlay');
            const closeBtn = modal.querySelector('.close-btn');
            const cancelBtn = modal.querySelector('.cancel-btn');
            const form = modal.querySelector('#waterMeterBillingForm');
            const currentReadingInput = modal.querySelector('#currentReading');

            const closeModal = () => {
                modal.remove();
            };

            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', () => {
                closeModal();
                // Skip this tenant and continue with next
                const remainingTenants = tenantsToBill.slice(1);
                if (remainingTenants.length > 0) {
                    showWaterMeterReadingForBilling(remainingTenants, currentMonthYear);
                } else {
                    showNotification('Bill generation completed!', 'success');
                    updateBillingTenantList();
                    updateGeneratedBillsList();
                }
            });

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Calculate bill when reading changes
            const updateBillCalculation = () => {
                const currentReading = parseFloat(currentReadingInput.value) || 0;
                const lastReading = tenant.currentWaterMeterReading || 0;
                const unitsUsed = Math.max(0, currentReading - lastReading);
                const waterCost = unitsUsed * WATER_PRICE_PER_UNIT;
                const garbageCost = tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0;
                const totalBill = tenant.amountCharged + waterCost + garbageCost;

                document.getElementById('unitsUsed').textContent = unitsUsed;
                document.getElementById('waterCost').textContent = waterCost.toFixed(2);
                document.getElementById('garbageCost').textContent = garbageCost;
                document.getElementById('totalBill').textContent = totalBill.toFixed(2);
            };

            currentReadingInput.addEventListener('input', updateBillCalculation);

            // Handle form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const currentReading = parseFloat(document.getElementById('currentReading').value);
                const readingDate = document.getElementById('readingDate').value;

                if (!currentReading || currentReading < 0) {
                    showNotification('Please enter a valid meter reading', 'error');
                    return;
                }

                if (currentReading < tenant.currentWaterMeterReading) {
                    showNotification('New reading cannot be less than previous reading', 'error');
                    return;
                }

                // Create water meter reading record
                const waterReading = {
                    id: generateUniqueId(),
                    tenantId: tenant.id,
                    tenantName: tenant.name,
                    propertyId: tenant.propertyId,
                    houseNumber: tenant.houseNumber,
                    waterMeterNumber: tenant.waterMeterNumber,
                    readingValue: currentReading,
                    readingDate: new Date(readingDate).toISOString(),
                    previousReading: tenant.currentWaterMeterReading,
                    unitsUsed: currentReading - (tenant.currentWaterMeterReading || 0),
                    waterCost: (currentReading - (tenant.currentWaterMeterReading || 0)) * WATER_PRICE_PER_UNIT,
                    createdAt: new Date().toISOString()
                };

                waterMeterReadings.push(waterReading);

                // Update tenant's current reading
                const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                if (tenantIndex !== -1) {
                    tenants[tenantIndex].currentWaterMeterReading = currentReading;
                    tenants[tenantIndex].lastWaterMeterReadingDate = new Date(readingDate).toISOString();
                }

                // Generate bill with water and garbage costs
                const waterCost = (currentReading - (tenant.currentWaterMeterReading || 0)) * WATER_PRICE_PER_UNIT;
                const garbageCost = tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0;
                const totalBillAmount = tenant.amountCharged + waterCost + garbageCost;

                // Update tenant's outstanding balance
                if (tenantIndex !== -1) {
                    tenants[tenantIndex].outstandingBalance += totalBillAmount;
                    tenants[tenantIndex].lastBilledDate = new Date().toISOString();
                }

                // Add new bill record
                const newBill = {
                    id: generateUniqueId(),
                    tenantId: tenant.id,
                    tenantName: tenant.name,
                    propertyId: tenant.propertyId,
                    houseNumber: tenant.houseNumber,
                    amount: totalBillAmount,
                    billingPeriod: currentMonthYear,
                    rentAmount: tenant.amountCharged,
                    waterAmount: waterCost,
                    garbageAmount: garbageCost,
                    waterUnitsUsed: currentReading - (tenant.currentWaterMeterReading || 0),
                    createdAt: new Date().toISOString()
                };

                bills.push(newBill);
                saveToLocalStorage();
                
                showNotification(`Bill generated for ${tenant.name}: Ksh ${totalBillAmount.toFixed(2)}`, 'success');
                closeModal();
                
                // Continue with next tenant
                const remainingTenants = tenantsToBill.slice(1);
                if (remainingTenants.length > 0) {
                    showWaterMeterReadingForBilling(remainingTenants, currentMonthYear);
                } else {
                    showNotification('All bills generated successfully!', 'success');
                    updateBillingTenantList();
                    updateGeneratedBillsList();
                }
            });
        }

        function updateGeneratedBillsList() {
            const billsHistoryListDiv = document.getElementById('billsHistoryList');
            if (!billsHistoryListDiv) return;

            let filteredBills = bills;
            if (billingHistoryFilterMonth) {
                filteredBills = bills.filter(bill => bill.billingPeriod === billingHistoryFilterMonth);
            }

            // Sort bills by creation date (newest first)
            filteredBills.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (filteredBills.length === 0) {
                billsHistoryListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No bills found for the selected period.</p>`;
                return;
            }

            billsHistoryListDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Billed</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated On</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredBills.map(bill => {
                                const property = properties.find(p => p.id === bill.propertyId)?.name || 'N/A';
                                const generatedDate = new Date(bill.createdAt).toLocaleDateString();
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.tenantName}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.houseNumber}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${bill.amount.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.billingPeriod}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${generatedDate}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm">
                                            <div class="flex space-x-2">
                                                <button data-bill-id="${bill.id}" class="generate-pdf-btn text-blue-600 hover:text-blue-800 transition duration-200" title="Generate PDF">
                                                    ${icons.FileText}
                                                </button>
                                                <button data-bill-id="${bill.id}" class="delete-bill-btn text-red-600 hover:text-red-800 transition duration-200" title="Delete Bill">
                                                    ${icons.Trash2}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            billsHistoryListDiv.querySelectorAll('.delete-bill-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.billId;
                    handleDeleteBill(billId);
                });
            });

            billsHistoryListDiv.querySelectorAll('.generate-pdf-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.billId;
                    const billToGenerate = bills.find(b => b.id === billId);
                    if (billToGenerate) {
                        generateReceiptPdf(billToGenerate);
                    } else {
                        showModal("Error", "Bill not found for PDF generation.");
                    }
                });
            });
        }

        // Generate PDF for a single receipt
        async function generateReceiptPdf(bill) {
            const tenant = tenants.find(t => t.id === bill.tenantId);
            const property = properties.find(p => p.id === bill.propertyId);

            if (!tenant || !property) {
                showModal("Error", "Tenant or Property information missing for this bill. Cannot generate receipt.");
                return;
            }

            const receiptDate = new Date(bill.createdAt).toLocaleDateString('en-KE', { year: 'numeric', month: 'long', day: 'numeric' });
            const billingPeriodFormatted = new Date(bill.billingPeriod).toLocaleDateString('en-KE', { year: 'numeric', month: 'long' });
            const outstandingBalance = tenant.outstandingBalance.toFixed(2);

            const receiptContent = `
                <div style="font-family: Arial, sans-serif; width: 600px; margin: 0 auto; background: #ffffff; border: 3px solid #667eea; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                    
                    <!-- Header Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; position: relative;">
                        <div style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 25px; font-size: 11px; font-weight: bold; letter-spacing: 1px;">
                            RECEIPT
                        </div>
                        <h1 style="margin: 0; font-size: 36px; font-weight: bold; letter-spacing: -1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">PA PROPERTY MANAGEMENT</h1>
                        <p style="margin: 10px 0 0 0; font-size: 18px; opacity: 0.95; font-weight: 500;">Monthly Rent Receipt</p>
                    </div>

                    <!-- Content Section -->
                    <div style="padding: 35px;">
                        
                        <!-- Receipt Info Card -->
                        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 30px; border-left: 5px solid #667eea; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                            <div style="display: table; width: 100%;">
                                <div style="display: table-cell; width: 50%; vertical-align: top;">
                                    <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Receipt Date</p>
                                    <p style="margin: 0; font-size: 18px; color: #1e293b; font-weight: bold;">${receiptDate}</p>
                                </div>
                                <div style="display: table-cell; width: 50%; vertical-align: top;">
                                    <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Receipt ID</p>
                                    <p style="margin: 0; font-size: 18px; color: #1e293b; font-weight: bold; font-family: monospace;">${bill.id.substring(0, 8).toUpperCase()}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tenant Information Section -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b; font-weight: bold; display: flex; align-items: center;">
                                <span style="background: #667eea; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 12px;">👤</span>
                                Tenant Information
                            </h3>
                            <div style="background: #f1f5f9; border-radius: 12px; padding: 25px; border: 1px solid #e2e8f0;">
                                <div style="display: table; width: 100%;">
                                    <div style="display: table-row;">
                                        <div style="display: table-cell; width: 50%; padding-right: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Full Name</p>
                                            <p style="margin: 0; font-size: 16px; color: #1e293b; font-weight: bold;">${tenant.name}</p>
                                        </div>
                                        <div style="display: table-cell; width: 50%; padding-left: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">House Number</p>
                                            <p style="margin: 0; font-size: 16px; color: #1e293b; font-weight: bold;">${tenant.houseNumber}</p>
                                        </div>
                                    </div>
                                    <div style="display: table-row; margin-top: 20px;">
                                        <div style="display: table-cell; width: 50%; padding-right: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Property</p>
                                            <p style="margin: 0; font-size: 16px; color: #1e293b; font-weight: bold;">${property.name}</p>
                                        </div>
                                        <div style="display: table-cell; width: 50%; padding-left: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Phone Number</p>
                                            <p style="margin: 0; font-size: 16px; color: #1e293b; font-weight: bold;">${tenant.phoneNumber}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Water Usage Section -->
                        ${bill.waterAmount ? `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b; font-weight: bold; display: flex; align-items: center;">
                                <span style="background: #0ea5e9; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 12px;">💧</span>
                                Water Usage Details
                            </h3>
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 25px; border: 2px solid #bae6fd;">
                                <div style="display: table; width: 100%;">
                                    <div style="display: table-row;">
                                        <div style="display: table-cell; width: 33.33%; padding-right: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Previous Reading</p>
                                            <p style="margin: 0; font-size: 18px; color: #1e293b; font-weight: bold;">${(tenant.currentWaterMeterReading - (bill.waterUnitsUsed || 0)).toFixed(0)} units</p>
                                        </div>
                                        <div style="display: table-cell; width: 33.33%; padding: 0 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Current Reading</p>
                                            <p style="margin: 0; font-size: 18px; color: #1e293b; font-weight: bold;">${tenant.currentWaterMeterReading.toFixed(0)} units</p>
                                        </div>
                                        <div style="display: table-cell; width: 33.33%; padding-left: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Units Consumed</p>
                                            <p style="margin: 0; font-size: 18px; color: #1e293b; font-weight: bold;">${bill.waterUnitsUsed || 0} units</p>
                                        </div>
                                    </div>
                                    <div style="display: table-row; margin-top: 20px;">
                                        <div style="display: table-cell; width: 50%; padding-right: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Rate per Unit</p>
                                            <p style="margin: 0; font-size: 16px; color: #1e293b; font-weight: bold;">Ksh ${WATER_PRICE_PER_UNIT}</p>
                                        </div>
                                        <div style="display: table-cell; width: 50%; padding-left: 15px; vertical-align: top;">
                                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Water Bill Total</p>
                                            <p style="margin: 0; font-size: 20px; color: #0ea5e9; font-weight: bold;">Ksh ${bill.waterAmount.toFixed(2)}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Billing Breakdown Section -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b; font-weight: bold; display: flex; align-items: center;">
                                <span style="background: #10b981; color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 12px;">💰</span>
                                Billing Summary
                            </h3>
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 25px; border: 2px solid #dcfce7;">
                                <div style="margin-bottom: 20px;">
                                    <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Billing Period</p>
                                    <p style="margin: 0; font-size: 18px; color: #1e293b; font-weight: bold;">${billingPeriodFormatted}</p>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <thead>
                                        <tr style="background: #f8fafc;">
                                            <th style="padding: 15px; text-align: left; font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #e2e8f0;">Description</th>
                                            <th style="padding: 15px; text-align: right; font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #e2e8f0;">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 15px; color: #475569; font-weight: 500;">Base Rent</td>
                                            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 15px; color: #475569; font-weight: bold;">Ksh ${(bill.rentAmount || tenant.amountCharged).toFixed(2)}</td>
                                        </tr>
                                        ${bill.waterAmount ? `
                                        <tr>
                                            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 15px; color: #475569; font-weight: 500;">Water Bill (${bill.waterUnitsUsed || 0} units @ Ksh ${WATER_PRICE_PER_UNIT})</td>
                                            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 15px; color: #475569; font-weight: bold;">Ksh ${bill.waterAmount.toFixed(2)}</td>
                                        </tr>
                                        ` : ''}
                                        ${bill.garbageAmount ? `
                                        <tr>
                                            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; font-size: 15px; color: #475569; font-weight: 500;">Garbage Collection</td>
                                            <td style="padding: 15px; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 15px; color: #475569; font-weight: bold;">Ksh ${bill.garbageAmount.toFixed(2)}</td>
                                        </tr>
                                        ` : ''}
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #667eea; color: white;">
                                            <td style="padding: 20px; font-size: 18px; font-weight: bold; border-top: 3px solid #5a67d8;">Total Amount</td>
                                            <td style="padding: 20px; text-align: right; font-size: 22px; font-weight: bold; border-top: 3px solid #5a67d8;">Ksh ${bill.amount.toFixed(2)}</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Outstanding Balance Section -->
                        <div style="background: ${outstandingBalance > 0 ? '#fef2f2' : '#f0fdf4'}; border: 2px solid ${outstandingBalance > 0 ? '#fecaca' : '#dcfce7'}; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
                            <div style="display: table; width: 100%;">
                                <div style="display: table-cell; width: 60%; vertical-align: middle;">
                                    <p style="margin: 0 0 8px 0; font-size: 11px; color: #64748b; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Outstanding Balance</p>
                                    <p style="margin: 0; font-size: 16px; color: #1e293b; font-weight: bold;">As of ${receiptDate}</p>
                                </div>
                                <div style="display: table-cell; width: 40%; vertical-align: middle; text-align: right;">
                                    <p style="margin: 0; font-size: 28px; font-weight: bold; color: ${outstandingBalance > 0 ? '#dc2626' : '#16a34a'};">Ksh ${outstandingBalance}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="text-align: center; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                            <p style="margin: 0 0 15px 0; font-size: 16px; color: #64748b; font-weight: 500;">Thank you for your payment!</p>
                            <p style="margin: 0; font-size: 14px; color: #94a3b8; font-weight: 500;">Prince Alex Property Management • Nairobi, Kenya</p>
                            <p style="margin: 10px 0 0 0; font-size: 11px; color: #cbd5e1;">Generated on ${new Date().toLocaleString('en-KE')}</p>
                        </div>
                    </div>
                </div>
            `;

            // Create a temporary div to render the HTML content for html2canvas
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px'; // Position off-screen
            tempDiv.style.width = '600px'; // Set a fixed width for consistent rendering
            tempDiv.innerHTML = receiptContent;
            document.body.appendChild(tempDiv);

            try {
                const canvas = await html2canvas(tempDiv, { scale: 2 }); // Scale for better quality
                const imgData = canvas.toDataURL('image/png');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`rent-receipt-${tenant.name.replace(/\s/g, '-')}-${tenant.houseNumber}.pdf`);
                showModal("Receipt Generated", `Receipt for ${tenant.name} (${tenant.houseNumber}) downloaded successfully.`);
            } catch (err) {
                console.error("Error generating PDF:", err);
                showModal("Error", `Failed to generate PDF receipt for ${tenant.name}. Please try again.`);
            } finally {
                document.body.removeChild(tempDiv); // Clean up temporary div
            }
        }


        // Delete Bill Handler
        function handleDeleteBill(billId) {
            const billToDelete = bills.find(b => b.id === billId);
            if (!billToDelete) {
                showModal("Error", "Bill not found.");
                return;
            }

            showModal("Confirm Deletion", `Are you sure you want to delete this bill for '${billToDelete.tenantName}' for the period '${billToDelete.billingPeriod}'? This action will also adjust their outstanding balance.`, 'confirm', () => {
                try {
                    // Remove the bill from the array
                    bills = bills.filter(b => b.id !== billId);

                    // Adjust tenant's balance
                    const tenantIndex = tenants.findIndex(t => t.id === billToDelete.tenantId);
                    if (tenantIndex !== -1) {
                        tenants[tenantIndex].outstandingBalance -= billToDelete.amount;
                    }

                    saveToLocalStorage();
                    showModal("Success", "Bill deleted and tenant balance adjusted successfully.");
                    updatePropertiesList(); // Re-render properties section to update balance display
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting bill: ", e);
                    showModal("Error", `Failed to delete bill: ${e.message}`);
                }
            });
        }

        // Render Financial Section
        function renderFinancialSection(parentEl) {
            // Recalculate totals every time this function runs
            const totalRentExpected = tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0);
            const totalBilled = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalOutstandingBalance = totalBilled - totalPaid;

            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Financial Overview</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        ${renderStatCard(icons.DollarSign, "Total Rent Expected (Monthly)", `Ksh ${totalRentExpected.toFixed(2)}`)}
                        ${renderStatCard(icons.FileText, "Total Billed Amount", `Ksh ${totalBilled.toFixed(2)}`)}
                        ${renderStatCard(icons.Wallet, "Total Paid Amount", `Ksh ${totalPaid.toFixed(2)}`)}
                        ${renderStatCard(icons.DollarSign, "Total Outstanding Balance", `Ksh ${totalOutstandingBalance.toFixed(2)}`)}
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Payment History</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mb-4">
                            <select id="financePropertyFilter" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Filter by Property</option>
                                ${properties.map(p => `<option value="${p.id}" ${selectedPropertyForFinanceFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="paymentHistoryList" class="space-y-4">
                            <!-- Payment list will be rendered here -->
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('financePropertyFilter').addEventListener('change', (e) => {
                selectedPropertyForFinanceFilter = e.target.value;
                updatePaymentHistoryList();
            });

            updatePaymentHistoryList();
        }

        function updatePaymentHistoryList() {
            const paymentHistoryListDiv = document.getElementById('paymentHistoryList');
            if (!paymentHistoryListDiv) return;

            let filteredPayments = payments;
            if (selectedPropertyForFinanceFilter) {
                filteredPayments = payments.filter(payment => payment.propertyId === selectedPropertyForFinanceFilter);
            }

            // Sort payments by payment date (newest first)
            filteredPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            if (filteredPayments.length === 0) {
                paymentHistoryListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No payments found for the selected property.</p>`;
                return;
            }

            paymentHistoryListDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Payment Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredPayments.map(payment => {
                                const property = properties.find(p => p.id === payment.propertyId)?.name || 'N/A';
                                const paymentDate = new Date(payment.paymentDate).toLocaleDateString();
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${payment.tenantName}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${payment.amount.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${paymentDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Chart initialization
        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                const monthlyData = getMonthlyRevenueData();
                charts.revenue = createChart('revenueChart', {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: monthlyData.data,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Property Distribution Chart
            const propertyCtx = document.getElementById('propertyChart');
            if (propertyCtx) {
                const propertyData = getPropertyDistributionData();
                charts.property = createChart('propertyChart', {
                    type: 'doughnut',
                    data: {
                        labels: propertyData.labels,
                        datasets: [{
                            data: propertyData.data,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(79, 172, 254, 0.8)',
                                'rgba(67, 233, 123, 0.8)',
                                'rgba(240, 147, 251, 0.8)',
                                'rgba(255, 193, 7, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function getMonthlyRevenueData() {
            const last6Months = [];
            const revenueData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toISOString().substring(0, 7);
                
                last6Months.push(date.toLocaleDateString('en-KE', { month: 'short', year: 'numeric' }));
                
                const monthlyRevenue = payments
                    .filter(payment => payment.paymentDate.startsWith(monthYear))
                    .reduce((sum, payment) => sum + payment.amount, 0);
                
                revenueData.push(monthlyRevenue);
            }
            
            return {
                labels: last6Months,
                data: revenueData
            };
        }

        function getPropertyDistributionData() {
            const propertyTenantCounts = {};
            
            tenants.forEach(tenant => {
                const property = properties.find(p => p.id === tenant.propertyId);
                if (property) {
                    propertyTenantCounts[property.name] = (propertyTenantCounts[property.name] || 0) + 1;
                }
            });
            
            return {
                labels: Object.keys(propertyTenantCounts),
                data: Object.values(propertyTenantCounts)
            };
        }

        // --- Main Execution ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();
            initializeAppData();
            
            // Add dark mode toggle event listener
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        });
    </script>
</body>
</html>
