<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Property Management System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for data visualization -->    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>


    <style>
        /* A few custom styles that are difficult to replicate with Tailwind utilities alone, like scrollbars and complex gradients. */
        .gradient-text {
            background-image: linear-gradient(135deg, #4f46e5 0%, #8b5cf6 100%); /* Indigo to Purple */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .sidebar-gradient {
            background-image: linear-gradient(135deg, #1f2937 0%, #111827 100%); /* Darker gradient for sidebar */
        }
        .modal-header-gradient {
            background-image: linear-gradient(135deg, #4f46e5 0%, #8b5cf6 100%); /* Indigo to Purple */
        }
        .form-title-gradient {
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        /* Custom Notification Styles */
        .notification {
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            transform: translateY(-150%);
            opacity: 0;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .notification-progress {
            animation: progress-bar-animation linear;
        }
    </style>
</head>
<body class="font-inter antialiased min-h-screen bg-gray-50 dark:bg-gray-900 dark:text-gray-200" id="body">
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="fixed top-4 right-4 z-50 p-3 rounded-full bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 hover:scale-110 transition-all duration-300 shadow-lg">
        <svg id="sunIcon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
        </svg>
        <svg id="moonIcon" class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
    </button>

    <div id="app">
        <!-- Content will be dynamically loaded here by JavaScript -->
        <!-- Initial Loading Spinner -->
    </div>

    <!-- Libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="module">
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC0TdBjLeGimGoYZwLxzC4fQLPBdSzrT0A",
            authDomain: "universityweb-19e1e.firebaseapp.com",
            projectId: "universityweb-19e1e",
            storageBucket: "universityweb-19e1e.firebasestorage.app",
            messagingSenderId: "401942926589",
            appId: "1:401942926589:web:c98e8d71ae6bd396775a94"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Firestore collection references
        //const getCollectionRef = (collectionName) => db.collection('users').doc(auth.currentUser.uid).collection(collectionName);
        const getCollectionRef = (collectionName) => db.collection(collectionName);


        // Lucide Icons (as SVG strings for direct embedding)
        const icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            Users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            Building: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9.5 16h5"/><path d="M9.5 12h5"/><path d="M9.5 8h5"/><path d="M12 22V2"/></svg>`,
            Receipt: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2h-2.5a2 2 0 0 1-2-2H6.5a2 2 0 0 1-2 2H4Z"/><path d="M18 6H8"/><path d="M18 10H8"/><path d="M18 14H8"/><path d="M18 18H8"/></svg>`,
            PlusCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
            Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            LogOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            HomeIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`, // Reusing Home for HomeIcon
            Wallet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h12a2 2 0 0 0 2-2v-3"/><path d="M22 7V4a1 1 0 0 0-1-1H3a2 2 0 0 0 0 4h18a1 1 0 0 0 1-1Z"/></svg>`,
            Search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            DollarSign: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            Menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            Wrench: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wrench"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            AlertTriangle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`,
            Clock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>`,
            Download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            Upload: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`,
            Settings: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>`,
            BarChart: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`,
            Bell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>`,
            Archive: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>`
            ,Mail: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>`
            ,Lock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`
        };


        // Global State
        let user = null; // Will be populated by Firebase Auth
        let userId = null; // Will be populated by Firebase Auth
        let currentPage = 'dashboard';
        let properties = [];
        let tenants = [];
        let bills = [];
        let payments = [];
        let leases = []; // New: Lease agreements
        let maintenanceRequests = []; // New: Maintenance requests
        let expenses = []; // New: Property expenses
        let notifications = []; // New: System notifications
        let documents = []; // New: Document storage
        let waterMeterReadings = []; // New: Water meter readings
        let activeTab = 'summary';
        let billingTenantSearchQuery = '';
        let selectedPropertyForBillingFilter = '';
        let tenantSearchQuery = '';
        let billingHistoryFilterMonth = new Date().toISOString().substring(0, 7);
        let selectedPropertyForFinanceFilter = '';
        let isSidebarOpen = false;
        let propertyTenantSearchQueries = {};
        let isDarkMode = false;
        let charts = {}; // Store chart instances
        let currentView = 'dashboard'; // New: Current view tracking

        // Kenyan Rental Management Constants
        const houseTypes = ['Apartment', 'Bungalow', 'Mansionette', 'Commercial Space', 'Shop', 'Studio', 'Single Room', 'Self-Contained'];
        const leaseTypes = ['Monthly', 'Quarterly', 'Semi-Annual', 'Annual'];
        const maintenanceCategories = ['Plumbing', 'Electrical', 'Structural', 'Security', 'Cleaning', 'Landscaping', 'HVAC', 'Other'];
        const expenseCategories = ['Maintenance', 'Utilities', 'Insurance', 'Taxes', 'Legal', 'Marketing', 'Administrative', 'Repairs', 'Renovations'];
        const notificationTypes = ['Payment Due', 'Lease Expiry', 'Maintenance Request', 'Payment Received', 'System Alert'];
        const documentTypes = ['Lease Agreement', 'ID Copy', 'Payment Receipt', 'Maintenance Report', 'Insurance Document', 'Other'];
        const WATER_PRICE_PER_UNIT = 200;
        const SECURITY_DEPOSIT_MULTIPLIER = 2; // Usually 2 months rent
        const PENALTY_RATE = 0.05; // 5% penalty for late payments
        const GARBAGE_COLLECTION_FEE = 150; // Monthly garbage collection fee
        const WATER_METER_READING_INTERVAL = 30; // Days between meter readings

        // --- Modern Utility Functions ---
        function showNotification(message, type = 'info', duration = 3000) {
            // Remove any existing notifications to prevent overlap
            const existingNotification = document.querySelector('.notification-container');
            if (existingNotification) {
                existingNotification.remove();
            }

            const container = document.createElement('div');
            container.className = 'notification-container fixed top-0 left-0 right-0 flex justify-center p-4 z-[100] pointer-events-none';

            const notification = document.createElement('div');
            
            let bgColor, icon, iconColor;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500 dark:bg-green-600';
                    icon = icons.CheckCircle;
                    iconColor = 'text-green-100';
                    break;
                case 'error':
                    bgColor = 'bg-red-500 dark:bg-red-600';
                    icon = icons.AlertTriangle;
                    iconColor = 'text-red-100';
                    break;
                default: // 'info'
                    bgColor = 'bg-blue-500 dark:bg-blue-600';
                    icon = icons.Bell;
                    iconColor = 'text-blue-100';
                    break;
            }

            notification.className = `notification pointer-events-auto flex items-center space-x-4 ${bgColor} text-white font-semibold px-6 py-4 rounded-2xl shadow-2xl max-w-md w-full border-2 border-white/30`;
            notification.innerHTML = `
                <div class="flex-shrink-0 ${iconColor}">${icon}</div>
                <div class="flex-grow">${message}</div>
                <div class="absolute bottom-0 left-0 h-1 bg-white/50 notification-progress" style="animation-duration: ${duration}ms;"></div>
            `;
            
            container.appendChild(notification);
            document.body.appendChild(container);
            
            setTimeout(() => notification.classList.add('show'), 50);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => container.remove(), 500);
            }, duration);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.getElementById('body');
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            
            if (isDarkMode) {
                body.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                body.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
            
            localStorage.setItem('darkMode', isDarkMode);
            renderDashboardPage(); // Re-render to apply dark mode styles
        }

        function initializeDarkMode() {
            const savedDarkMode = localStorage.getItem('darkMode') === 'true';
            if (savedDarkMode) {
                toggleDarkMode();
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-KE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function createChart(canvasId, config) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            return new Chart(ctx, config);
        }

        function getFriendlyErrorMessage(error) {
            console.error("Firebase Error:", error.code, error.message); // Keep for debugging
            switch (error.code) {
                // --- Auth Errors ---
                case 'auth/user-not-found':
                    return 'No account found with this email. Please check your spelling or sign up.';
                case 'auth/invalid-credential':
                case 'auth/wrong-password': // Fallback for older SDKs or different error responses
                    return 'Invalid credentials. Please check your email and password and try again.';
                case 'auth/invalid-email':
                    return 'The email address you entered is not valid. Please check the format.';
                case 'auth/email-already-in-use':
                    return 'An account with this email address already exists.';
                case 'auth/weak-password':
                    return 'Your password is too weak. It must be at least 6 characters long.';
                case 'auth/too-many-requests':
                    return 'Access has been temporarily disabled due to too many failed login attempts. Please reset your password or try again later.';
                // --- Firestore Errors ---
                case 'permission-denied':
                    return 'You do not have permission to perform this action.';
                default:
                    return 'An unexpected error occurred. Please check your internet connection and try again.';
            }
        }
        // --- Firestore Data Functions (Replaces Local Storage) ---
        function generateUniqueId() {
            return db.collection('whatever').doc().id; // Use Firestore's own ID generation
        }

        async function saveData(collectionName, data) {
            if (!auth.currentUser) return;
            try {
                const docRef = await getCollectionRef(collectionName).add({
                    ...data,
                    uid: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                const savedDoc = await docRef.get();
                return { id: savedDoc.id, ...savedDoc.data() };
            } catch (error) {
                console.error(`Error saving to ${collectionName}:`, error);
                showNotification(getFriendlyErrorMessage(error), 'error');
            }
        }

        async function updateData(collectionName, docId, data) {
            if (!auth.currentUser) return;
            try {
                await getCollectionRef(collectionName).doc(docId).update({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error(`Error updating ${collectionName}:`, error);
                showNotification(getFriendlyErrorMessage(error), 'error');
            }
        }

        async function deleteData(collectionName, docId) {
            if (!auth.currentUser) return;
            try {
                await getCollectionRef(collectionName).doc(docId).delete();
            } catch (error) {
                console.error(`Error deleting from ${collectionName}:`, error);
                showNotification(getFriendlyErrorMessage(error), 'error');
            }
        }

        async function loadAllData() {
            if (!auth.currentUser) {
                console.log("No user logged in, cannot load data.");
                return;
            }

            const collectionsToLoad = ['properties', 'tenants', 'bills', 'payments', 'leases', 'maintenanceRequests', 'expenses', 'notifications', 'documents', 'waterMeterReadings'];
            const promises = collectionsToLoad.map(async (collectionName) => {
                const snapshot = await getCollectionRef(collectionName).get();
                return { [collectionName]: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })) };
            });

            try {
                const results = await Promise.all(promises);
                const allData = Object.assign({}, ...results);

                properties = allData.properties || [];
                tenants = allData.tenants || [];
                bills = allData.bills || [];
                payments = allData.payments || [];
                leases = allData.leases || [];
                maintenanceRequests = allData.maintenanceRequests || [];
                expenses = allData.expenses || [];
                notifications = allData.notifications || [];
                documents = allData.documents || [];
                waterMeterReadings = allData.waterMeterReadings || [];

            } catch (error) {
                console.error("Error loading all data from Firestore:", error);
                showNotification("We couldn't load your data. Please check your connection and refresh.", 'error');
                properties = [];
                tenants = [];
                bills = [];
                payments = [];
                leases = [];
                maintenanceRequests = [];
                expenses = [];
                notifications = [];
                documents = [];
                waterMeterReadings = [];
            }
        }

        // Backup and Restore Functions
        function exportData() {
            const data = {
                properties,
                tenants,
                bills,
                payments,
                leases,
                maintenanceRequests,
                expenses,
                notifications,
                documents,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rental-data-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        async function importData(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.version && data.properties) {
                        showNotification('Starting data import... This may take a moment.', 'info');

                        // A more robust implementation would clear existing data first.
                        // For now, we will add the imported data.
                        const dataToImport = {
                            properties: data.properties || [],
                            tenants: data.tenants || [],
                            bills: data.bills || [],
                            payments: data.payments || [],
                            leases: data.leases || [],
                            maintenanceRequests: data.maintenanceRequests || [],
                            expenses: data.expenses || [],
                            notifications: data.notifications || [],
                            documents: data.documents || []
                        };
                        
                        for (const collectionName in dataToImport) {
                            for (const item of dataToImport[collectionName]) {
                                await saveData(collectionName, item);
                            }
                        }
                        
                        await initializeAppData(); // Reload all data from Firestore
                        showNotification('Data imported successfully! The page will now refresh.', 'success');
                    } else {
                        showNotification('This file is not a valid backup. Please choose a different file.', 'error');
                    }
                } catch (error) {
                    showNotification('Error importing data: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Enhanced Modal Functions
        function showModal(title, content, type = 'alert', onConfirm = null) {
            const appDiv = document.getElementById('app');
            if (!appDiv) {
                console.error('App div not found');
                return;
            }

            let modalOverlay = document.querySelector('.modal-overlay');
            
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');                
                modalOverlay.className = 'modal-overlay fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4 transition-opacity duration-300';
                appDiv.appendChild(modalOverlay);
            }

            const contentElement = typeof content === 'string' ? `<div class="p-6">${content}</div>` : content.outerHTML || '';
            
            modalOverlay.innerHTML = `
                <div class="modal-content bg-white/95 dark:bg-gray-900/95 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden border border-white/20 dark:border-gray-700/50 transition-all duration-300 scale-95 opacity-0">
                    <div class="modal-header-gradient flex justify-between items-center p-6 flex-shrink-0">
                        <h3 class="text-2xl font-bold text-white">${title}</h3>
                        <button class="text-white hover:text-gray-200 transition duration-200 modal-close-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body p-6 overflow-y-auto custom-scrollbar">
                        ${contentElement}
                    </div>
                    <div class="p-6 border-t border-gray-200/50 dark:border-gray-700/50 flex justify-end gap-3 bg-gray-50/50 dark:bg-gray-900/50 flex-shrink-0">
                        ${type === 'confirm' ? `
                            <button class="px-6 py-3 rounded-xl font-semibold bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-all duration-300 modal-cancel-btn">
                                Cancel
                            </button>
                            <button class="px-6 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-600 to-purple-700 text-white hover:shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all duration-300 modal-confirm-btn">
                                Confirm
                            </button>
                        ` : `
                            <button class="px-6 py-3 rounded-xl font-semibold bg-gradient-to-r from-indigo-600 to-purple-700 text-white hover:shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all duration-300 modal-close-btn">
                                OK
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            // Animate in (using setTimeout to ensure element is in DOM before animating)
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                const modalContent = modalOverlay.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }
            }, 10);
            
            if (typeof content !== 'string') {
                const modalBody = modalOverlay.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = '';
                    modalBody.appendChild(content);
                }
            }
            
            const closeModal = () => {
                modalOverlay.classList.add('opacity-0');
                const modalContent = modalOverlay.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                setTimeout(() => modalOverlay.remove(), 300);
            };
            
            const closeBtn = modalOverlay.querySelector('.modal-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }

            const cancelBtn = modalOverlay.querySelector('.modal-cancel-btn');
            const confirmBtn = modalOverlay.querySelector('.modal-confirm-btn');

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeModal);
            }

            if (confirmBtn) {
                confirmBtn.addEventListener('click', () => {
                    if (onConfirm) onConfirm(closeModal);
                    // The modal will be closed by the onConfirm handler or automatically if it's a simple confirm
                    closeModal();
                });
            }
        }



        // Render Functions
        function renderApp() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Clear existing content
            renderDashboardPage();
        }

        function renderDashboardPage() {
            const appDiv = document.getElementById('app');
            const userName = user?.displayName || user?.email || "User";
            const totalProperties = properties.length;
            const totalTenants = tenants.length;
            const billsGenerated = bills.length;

            appDiv.innerHTML = `
                <div class="flex h-screen">
                    <!-- Sidebar Navigation -->
                    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 sidebar-gradient text-white flex flex-col p-6 shadow-2xl transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out custom-scrollbar overflow-y-auto">
                        <div class="flex items-center mb-8">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-400 to-purple-500 flex items-center justify-center mr-4">
                                <span class="text-white font-bold text-xl">PA</span>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold">Prince Alex</h1>
                                <p class="text-sm text-gray-300">Property Management</p>
                            </div>
                        </div>
                        <nav class="flex-grow">
                            <ul class="space-y-2">
                                <li>
                                    <button id="navSummary"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'summary' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Home}</span>
                                        <span class="font-medium">Dashboard Overview</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navProperties"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'properties' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Building}</span>
                                        <span class="font-medium">Properties</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navTenants"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'tenants' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Users}</span>
                                        <span class="font-medium">Tenants</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navLeases"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'leases' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.FileText}</span>
                                        <span class="font-medium">Lease Management</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navBilling"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'billing' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Receipt}</span>
                                        <span class="font-medium">Billing & Receipts</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navMaintenance"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'maintenance' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Wrench}</span>
                                        <span class="font-medium">Maintenance</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navFinance"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'finance' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.DollarSign}</span>
                                        <span class="font-medium">Financial Overview</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navReports"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'reports' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.BarChart}</span>
                                        <span class="font-medium">Reports & Analytics</span>
                                    </button>
                                </li>
                                <li>
                                    <button id="navSettings"
                                        class="flex items-center w-full p-4 rounded-xl transition-all duration-300 ${activeTab === 'settings' ? 'bg-white bg-opacity-20 shadow-lg' : 'hover:bg-white hover:bg-opacity-10'} group">
                                        <span class="mr-4 group-hover:scale-110 transition-transform">${icons.Settings}</span>
                                        <span class="font-medium">Settings & Backup</span>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div class="mt-auto">
                            <div class="p-4 rounded-xl bg-white bg-opacity-10">
                                <p class="text-xs text-gray-300">User ID: ${userId || 'N/A'}</p>
                                <p class="text-sm font-medium">${userName}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                             <button id="logoutBtn"
                                class="flex items-center w-full p-4 rounded-xl transition-all duration-300 bg-red-500 bg-opacity-20 hover:bg-red-500 hover:bg-opacity-40 group">
                                <span class="mr-4 group-hover:scale-110 transition-transform">${icons.LogOut}</span>
                                <span class="font-medium">Logout</span>
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content Area -->
                    <main class="flex-1 overflow-auto p-8 ${isSidebarOpen ? 'lg:ml-64' : 'lg:ml-0'} transition-all duration-300 ease-in-out">
                        <!-- Header -->                        
                        <header class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-6 mb-8 flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl md:text-4xl font-bold gradient-text">Welcome back, ${userName}!</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Here's what's happening with your properties today</p>
                            </div>
                            <div class="flex items-center space-x-4">                                
                                <button id="menuToggleBtn" class="p-3 rounded-xl bg-white/30 dark:bg-gray-900/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 text-gray-800 dark:text-gray-200 fixed top-4 left-4 z-50 shadow-md hover:bg-white/40 dark:hover:bg-gray-700/50 transition ${isSidebarOpen ? 'hidden' : ''}">
                                    ${isSidebarOpen ? icons.X : icons.Menu}
                                </button>
                                <div class="hidden lg:flex items-center text-gray-600 dark:text-gray-400 glass-effect px-4 py-2 rounded-xl">
                                    ${icons.Calendar}
                                    <span class="ml-2 font-medium">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                            </div>
                        </header>

                        <!-- Content Section based on activeTab -->
                        <div id="contentSection"></div>
                    </main>
                    
                    <!-- Floating Action Button -->
                    <div class="fixed bottom-8 right-8 z-40 animate-bounce">
                        <div class="relative">
                            <button id="fabMain" class="w-14 h-14 bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                                ${icons.PlusCircle}
                            </button>
                            <div id="fabMenu" class="absolute bottom-16 right-0 space-y-3 opacity-0 pointer-events-none transition-all duration-300 transform scale-95">
                                <button id="fabAddProperty" class="w-12 h-12 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Add Property">
                                    ${icons.Building}
                                </button>
                                <button id="fabAddTenant" class="w-12 h-12 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Add Tenant">
                                    ${icons.Users}
                                </button>
                                <button id="fabCreateLease" class="w-12 h-12 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Create Lease">
                                    ${icons.FileText}
                                </button>
                                <button id="fabMaintenanceRequest" class="w-12 h-12 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Maintenance Request">
                                    ${icons.Wrench}
                                </button>
                                <button id="fabGenerateBill" class="w-12 h-12 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-300 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center" title="Generate Bills">
                                    ${icons.Receipt}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for navigation
            document.getElementById('navSummary').addEventListener('click', () => { activeTab = 'summary'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navProperties').addEventListener('click', () => { activeTab = 'properties'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navTenants').addEventListener('click', () => { activeTab = 'tenants'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navLeases').addEventListener('click', () => { activeTab = 'leases'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navBilling').addEventListener('click', () => { activeTab = 'billing'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navMaintenance').addEventListener('click', () => { activeTab = 'maintenance'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navFinance').addEventListener('click', () => { activeTab = 'finance'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navReports').addEventListener('click', () => { activeTab = 'reports'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navSettings').addEventListener('click', () => { activeTab = 'settings'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Add event listener for the new hamburger menu button
            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                renderDashboardPage(); // Re-render to apply sidebar class change
            });

            // Floating Action Button event listeners
            let fabMenuOpen = false;
            document.getElementById('fabMain').addEventListener('click', () => {
                const fabMenu = document.getElementById('fabMenu');
                fabMenuOpen = !fabMenuOpen;
                if (fabMenuOpen) {
                    fabMenu.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                    fabMenu.classList.add('opacity-100', 'pointer-events-auto', 'scale-100');
                } else {
                    fabMenu.classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                    fabMenu.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                }
            });

            document.getElementById('fabAddProperty').addEventListener('click', () => {
                showAddPropertyModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabAddTenant').addEventListener('click', () => {
                if (properties.length === 0) {
                    showNotification('Please add a property before adding a tenant.', 'error');
                    return;
                }
                // Show property selection modal for adding tenant
                showAddTenantModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabCreateLease').addEventListener('click', () => {
                if (tenants.length === 0) {
                    showNotification('Please add a tenant before creating a lease.', 'error');
                    return;
                }
                showAddLeaseModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabMaintenanceRequest').addEventListener('click', () => {
                if (properties.length === 0) {
                    showNotification('Please add a property before creating a maintenance request.', 'error');
                    return;
                }
                showAddMaintenanceModal();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });

            document.getElementById('fabGenerateBill').addEventListener('click', () => {
                activeTab = 'billing';
                isSidebarOpen = false;
                renderDashboardPage();
                fabMenuOpen = false;
                document.getElementById('fabMenu').classList.remove('opacity-100', 'pointer-events-auto', 'scale-100');
                document.getElementById('fabMenu').classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            });


            // Render content based on active tab
            const contentSection = document.getElementById('contentSection');
            if (contentSection) {
                if (activeTab === 'summary') {
                    contentSection.innerHTML = renderSummarySection(totalProperties, totalTenants, billsGenerated);
                    // Initialize charts after DOM is updated
                    setTimeout(() => {
                        initializeCharts();
                    }, 100);
                } else if (activeTab === 'properties') {
                    renderPropertiesSection(contentSection);
                } else if (activeTab === 'tenants') {
                    renderTenantsSection(contentSection);
                } else if (activeTab === 'leases') {
                    renderLeasesSection(contentSection);
                } else if (activeTab === 'billing') {
                    renderBillingSection(contentSection);
                } else if (activeTab === 'maintenance') {
                    renderMaintenanceSection(contentSection);
                } else if (activeTab === 'finance') {
                    renderFinancialSection(contentSection);
                } else if (activeTab === 'reports') {
                    renderReportsSection(contentSection);
                } else if (activeTab === 'settings') {
                    renderSettingsSection(contentSection);
                }
            }
        }

        // --- Authentication Functions ---

        function renderLoginPage() {
            const appDiv = document.getElementById('app');
            if (!document.getElementById('auth-container')) {
                // A more professional split-screen layout
                // Full-screen background with a centered, blurred card
                appDiv.innerHTML = `
                    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=2070&auto=format&fit=crop');">
                        <div class="absolute inset-0 bg-black/50"></div>
                        <div id="auth-card" class="relative w-full max-w-md"></div>
                    </div>
                `;
            }
            renderLoginContent();
        }

        function renderLoginContent() {
            const authCard = document.getElementById('auth-card');
            if (!authCard) return;
            authCard.innerHTML = `
                <div class="w-full max-w-md bg-white/10 dark:bg-gray-900/30 backdrop-blur-xl border border-white/20 dark:border-gray-700/50 p-8 rounded-3xl shadow-2xl">
                    <div class="flex items-center mb-8">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center mr-4">
                            <span class="text-white font-bold text-xl">PA</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">Prince Alex Property</h1>
                            <p class="text-gray-300">Management System</p>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold gradient-text mb-2">Welcome Back</h2>
                    <p class="text-gray-300 mb-8">Please enter your details to sign in.</p>
                    
                    <form id="loginForm" class="space-y-6">
                        <div class="relative">
                            <label for="email" class="sr-only">Email Address</label>
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                                ${icons.Mail}
                            </div>
                            <input type="email" id="email" name="email" class="w-full pl-12 p-4 rounded-xl border-2 border-white/20 bg-black/20 text-white placeholder-gray-400 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Email Address" required>
                        </div>
                        <div class="relative">
                            <label for="password" class="sr-only">Password</label>
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                                ${icons.Lock}
                            </div>
                            <input type="password" id="password" name="password" class="w-full pl-12 p-4 rounded-xl border-2 border-white/20 bg-black/20 text-white placeholder-gray-400 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Password" required>
                        </div>
                        <div class="flex items-center justify-between">
                            <a href="#" id="forgotPasswordLink" class="text-sm text-indigo-400 hover:text-white hover:underline font-medium">Forgot password?</a>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-4 rounded-xl font-semibold hover:shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center space-x-2">
                            <span>Sign In</span>
                        </button>
                    </form>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('forgotPasswordLink').addEventListener('click', handlePasswordResetRequest);
        }

        function renderPasswordResetContent() {
            const authCard = document.getElementById('auth-card');
            if (!authCard) return;
            authCard.innerHTML = `
                <div class="w-full max-w-md bg-white/10 dark:bg-gray-900/30 backdrop-blur-xl border border-white/20 dark:border-gray-700/50 p-8 rounded-3xl shadow-2xl">
                    <h2 class="text-3xl font-bold gradient-text mb-2">Reset Password</h2>
                    <p class="text-gray-300 mb-8">Enter your email to receive a reset link.</p>
                    
                    <form id="resetPasswordForm" class="space-y-6">
                        <div class="relative">
                            <label for="resetEmail" class="sr-only">Email Address</label>
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                                ${icons.Mail}
                            </div>
                            <input type="email" id="resetEmail" name="resetEmail" class="w-full pl-12 p-4 rounded-xl border-2 border-white/20 bg-black/20 text-white placeholder-gray-400 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Email Address" required>
                        </div>
                        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-4 rounded-xl font-semibold hover:shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all duration-300">
                            Send Reset Link
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <a href="#" id="backToLoginLink" class="text-sm text-indigo-400 hover:text-white hover:underline font-medium">Back to Login</a>
                    </div>
                </div>
            `;

            document.getElementById('resetPasswordForm').addEventListener('submit', handleSendResetEmail);
            document.getElementById('backToLoginLink').addEventListener('click', (e) => {
                e.preventDefault();
                renderLoginContent();
            });
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;

            auth.signInWithEmailAndPassword(email, password).catch((error) => {
                // For login, any auth error is likely due to bad credentials.
                // This provides a consistent, user-friendly message without exposing specific error codes.
                if (error.code.startsWith('auth/')) {
                    showNotification('Invalid credentials. Please check your email and password.', 'error');
                } else {
                    // Handle non-auth errors (like network issues) with the generic helper.
                    showNotification(getFriendlyErrorMessage(error), 'error');
                }
            });
        }

        function handleLogout() {
            auth.signOut().then(() => {
                // The onAuthStateChanged observer will handle the UI update
                showNotification('You have been logged out.', 'info');
                // Clear local state
                user = null;
                userId = null;
                properties = [];
                tenants = [];
                bills = [];
                payments = [];
                leases = [];
                maintenanceRequests = [];
            }).catch((error) => {
                showNotification(getFriendlyErrorMessage(error), 'error');
            });
        }

        function handlePasswordResetRequest(e) {
            e.preventDefault();
            renderPasswordResetContent();
        }

        function handleSendResetEmail(e) {
            e.preventDefault();
            const email = e.target.resetEmail.value;
            if (!email) {
                showNotification('Please enter your email address.', 'error');
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showNotification('Password reset email sent! Check your inbox.', 'success');
                    renderLoginContent(); // Go back to login form after sending
                })
                .catch((error) => {
                    showNotification(getFriendlyErrorMessage(error), 'error');
                });
        }
        // Initialize Application Data (from Firestore)
        async function initializeAppData() {
            // Show a loading state
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="text-center bg-white/30 dark:bg-gray-900/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 p-8 rounded-2xl">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mx-auto"></div>
                        <p class="mt-6 text-xl font-semibold gradient-text">Loading Your Data...</p>
                    </div>
                </div>
            `;

            await loadAllData();
            currentPage = 'dashboard';
            activeTab = 'summary'; // Set the correct initial tab
            renderDashboardPage();
        }

        // Auth State Listener
        auth.onAuthStateChanged(async (firebaseUser) => {
            if (firebaseUser) {
                user = firebaseUser;
                userId = firebaseUser.uid;
                await initializeAppData();
            } else {
                user = null;
                userId = null;
                renderLoginPage();
            }
        });

        function renderSummarySection(totalProperties, totalUnits, billsGenerated) {
            const totalRentExpected = tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalOutstanding = tenants.reduce((sum, tenant) => sum + tenant.outstandingBalance, 0);
            
            return `
                <section class="space-y-8">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${renderStatCard(icons.Building, "Total Properties", totalProperties, "properties", "bg-gradient-to-r from-indigo-500 to-indigo-600")}
                        ${renderStatCard(icons.HomeIcon, "Total Units", totalUnits, "units", "bg-gradient-to-r from-green-500 to-green-600")}
                        ${renderStatCard(icons.Users, "Total Tenants", tenants.length, "tenants", "bg-gradient-to-r from-purple-500 to-purple-600")}
                        ${renderStatCard(icons.Receipt, "Bills Generated", billsGenerated, "bills", "bg-gradient-to-r from-orange-500 to-orange-600")}
                    </div>

                    <!-- Financial Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${renderStatCard(icons.DollarSign, "Monthly Rent Expected", formatCurrency(totalRentExpected), "rent", "bg-gradient-to-r from-emerald-500 to-emerald-600")}
                        ${renderStatCard(icons.Wallet, "Total Collected", formatCurrency(totalPaid), "collected", "bg-gradient-to-r from-teal-500 to-teal-600")}
                        ${renderStatCard(icons.FileText, "Outstanding Balance", formatCurrency(totalOutstanding), "outstanding", "bg-gradient-to-r from-red-500 to-red-600")}
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white/50 dark:bg-gray-900/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Revenue Overview</h3>
                            <canvas id="revenueChart" width="400" height="200"></canvas>
                        </div>
                        <div class="bg-white/50 dark:bg-gray-900/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Property Distribution</h3>
                            <canvas id="propertyChart" width="400" height="200"></canvas>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Recent Activity</h3>
                        <div class="space-y-3 custom-scrollbar overflow-y-auto max-h-60">
                            ${getRecentActivity().map(activity => `
                                <div class="flex items-center space-x-3 p-3 rounded-lg bg-white/50 dark:bg-black/20">
                                    <div class="w-2 h-2 rounded-full ${activity.type === 'payment' ? 'bg-green-500' : activity.type === 'bill' ? 'bg-blue-500' : 'bg-purple-500'}"></div>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">${activity.message}</span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-auto">${activity.time}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </section>
            `;
        }

        function renderStatCard(icon, title, value, id, gradientClass) {
            return `
                <div class="bg-white/80 dark:bg-gray-900/50 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 p-6 rounded-2xl shadow-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="p-4 rounded-xl ${gradientClass} text-white shadow-md">
                                ${icon}
                            </div>
                            <div>
                                <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">${title}</p>
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">${value}</h3>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getRecentActivity() {
            const activities = [];
            
            // Add recent payments
            payments.slice(-3).forEach(payment => {
                activities.push({
                    type: 'payment',
                    message: `Payment of ${formatCurrency(payment.amount)} received from ${payment.tenantName}`,
                    time: formatDate(payment.paymentDate)
                });
            });
            
            // Add recent bills
            bills.slice(-3).forEach(bill => {
                activities.push({
                    type: 'bill',
                    message: `Bill generated for ${bill.tenantName} - ${formatCurrency(bill.amount)}`,
                    time: formatDate(bill.createdAt)
                });
            });
            
            // Add recent tenants
            tenants.slice(-3).forEach(tenant => {
                activities.push({
                    type: 'tenant',
                    message: `New tenant ${tenant.name} added to ${tenant.houseNumber}`,
                    time: formatDate(tenant.createdAt)
                });
            });
            
            // Add recent maintenance requests
            maintenanceRequests.slice(-3).forEach(request => {
                activities.push({
                    type: 'maintenance',
                    message: `Maintenance request: ${request.description}`,
                    time: formatDate(request.createdAt)
                });
            });
            
            return activities.sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 5);
        }

        // Lease Management Section
        function renderLeasesSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Lease Management</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Manage lease agreements and tenant contracts</p>
                        </div>
                        <button id="addLeaseBtn" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">Create Lease</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        ${renderStatCard(icons.FileText, "Active Leases", leases.filter(l => l.status === 'active').length, "leases", "bg-gradient-to-r from-blue-500 to-blue-600")}
                        ${renderStatCard(icons.AlertTriangle, "Expiring Soon", getExpiringLeases().length, "expiring", "bg-gradient-to-r from-orange-500 to-orange-600")}
                        ${renderStatCard(icons.CheckCircle, "Renewed This Month", getRenewedLeases().length, "renewed", "bg-gradient-to-r from-green-500 to-green-600")}
                    </div>

                    <div id="leasesList" class="space-y-6">
                        ${leases.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 flex items-center justify-center">
                                    ${icons.FileText}
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Leases Yet</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Create lease agreements for your tenants</p>
                                <button onclick="document.getElementById('addLeaseBtn').click()" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl font-medium hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                                    Create First Lease
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addLeaseBtn').addEventListener('click', () => showAddLeaseModal());
            updateLeasesList();
        }

        function getExpiringLeases() {
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
            
            return leases.filter(lease => {
                const endDate = new Date(lease.endDate);
                return lease.status === 'active' && endDate <= thirtyDaysFromNow;
            });
        }

        function getRenewedLeases() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return leases.filter(lease => {
                const renewalDate = new Date(lease.renewalDate);
                return renewalDate.getMonth() === currentMonth && renewalDate.getFullYear() === currentYear;
            });
        }

        function updateLeasesList() {
            const leasesListDiv = document.getElementById('leasesList');
            if (!leasesListDiv) return;

            if (leases.length === 0) {
                leasesListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No leases created yet.</p>`;
                return;
            }

            leasesListDiv.innerHTML = leases.map(lease => {
                const tenant = tenants.find(t => t.id === lease.tenantId);
                const property = properties.find(p => p.id === lease.propertyId);
                const statusColor = lease.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                                 lease.status === 'expired' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
                                 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                
                return `
                    <div class="bg-white/50 dark:bg-gray-900/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6 shadow-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-purple-500 to-pink-600 flex items-center justify-center text-white font-bold text-xl">
                                    ${tenant?.name?.charAt(0) || 'L'}
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200">${tenant?.name || 'Unknown Tenant'}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${property?.name || 'Unknown Property'} - ${tenant?.houseNumber || 'N/A'}</p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${formatCurrency(lease.monthlyRent)}/month</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400"></span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${lease.leaseType}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 md:mt-0">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                    ${lease.status.charAt(0).toUpperCase() + lease.status.slice(1)}
                                </span>
                                <button data-lease-id="${lease.id}" class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800 transition duration-200" title="View Details">
                                    ${icons.Edit}
                                </button>
                                <button data-lease-id="${lease.id}" class="p-2 rounded-lg bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-800 transition duration-200" title="Renew Lease">
                                    ${icons.CheckCircle}
                                </button>
                                <button data-lease-id="${lease.id}" class="p-2 rounded-lg bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-800 transition duration-200" title="Terminate Lease">
                                    ${icons.X}
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-white/50 dark:bg-gray-900/50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Start Date</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatDate(lease.startDate)}</p>
                            </div>
                            <div class="bg-white/50 dark:bg-gray-900/50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">End Date</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatDate(lease.endDate)}</p>
                            </div>
                            <div class="bg-white/50 dark:bg-gray-900/50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Security Deposit</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(lease.securityDeposit)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners for lease actions
            leasesListDiv.querySelectorAll('button[data-lease-id]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const leaseId = e.currentTarget.dataset.leaseId;
                    const action = e.currentTarget.title;
                    
                    if (action === 'View Details') {
                        showLeaseDetailsModal(leaseId);
                    } else if (action === 'Renew Lease') {
                        showRenewLeaseModal(leaseId);
                    } else if (action === 'Terminate Lease') {
                        showTerminateLeaseModal(leaseId);
                    }
                });
            });
        }

        // Lease Modal Functions
        function showAddLeaseModal() {
            if (tenants.length === 0) { // This check is now redundant due to FAB check, but good for safety
                showNotification('Please add tenants first before creating leases', 'error');
                return;
            }

            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">Create Lease Agreement</h3>
                    <p class="text-gray-600 dark:text-gray-400">Set up a new lease agreement for a tenant</p>
                </div>
                <form id="addLeaseForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="leaseTenant">Select Tenant</label>
                        <select id="leaseTenant" name="leaseTenant" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                            <option value="">Choose a tenant...</option>
                            ${tenants.map(tenant => {
                                const property = properties.find(p => p.id === tenant.propertyId);
                                return `<option value="${tenant.id}">${tenant.name} - ${property?.name} (${tenant.houseNumber})</option>`;
                            }).join('')}
                        </select>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Select the tenant for this lease agreement</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="leaseType">Lease Type</label>
                            <select id="leaseType" name="leaseType" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                                ${leaseTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="monthlyRent">Monthly Rent (Ksh)</label>
                            <input type="number" id="monthlyRent" name="monthlyRent" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="0" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${new Date().toISOString().substring(0, 10)}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="securityDeposit">Security Deposit (Ksh)</label>
                        <input type="number" id="securityDeposit" name="securityDeposit" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="0" required>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Usually 2 months rent as security deposit</p>
                    </div>
                </form>
            `;

            showModal("Create New Lease Agreement", formContent, 'confirm', () => {
                const form = document.getElementById('addLeaseForm');
                const selectedTenant = tenants.find(t => t.id === form.elements['leaseTenant'].value);
                
                if (!selectedTenant) {
                    showNotification('Please select a tenant to create a lease.', 'error');
                    return;
                }

                const leaseData = {
                    // id will be assigned by Firestore
                    tenantId: selectedTenant.id,
                    propertyId: selectedTenant.propertyId,
                    leaseType: form.elements['leaseType'].value,
                    monthlyRent: parseFloat(form.elements['monthlyRent'].value),
                    startDate: form.elements['startDate'].value,
                    endDate: form.elements['endDate'].value,
                    securityDeposit: parseFloat(form.elements['securityDeposit'].value),
                    status: 'active',
                    createdAt: new Date().toISOString()
                };

                saveData('leases', leaseData).then(savedLease => {
                    if (savedLease) {
                        leases.push(savedLease);
                    }
                });
                showNotification('Lease agreement created successfully!', 'success');
                updateLeasesList();
            });
        }

        function showLeaseDetailsModal(leaseId) {
            const lease = leases.find(l => l.id === leaseId);
            if (!lease) { showNotification("Could not find lease details.", "error"); return; }

            const tenant = tenants.find(t => t.id === lease.tenantId);
            const property = properties.find(p => p.id === lease.propertyId);

            const content = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Tenant</p>
                            <p class="font-semibold">${tenant?.name || 'Unknown'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Property</p>
                            <p class="font-semibold">${property?.name || 'Unknown'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Monthly Rent</p>
                            <p class="font-semibold">${formatCurrency(lease.monthlyRent)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Security Deposit</p>
                            <p class="font-semibold">${formatCurrency(lease.securityDeposit)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Start Date</p>
                            <p class="font-semibold">${formatDate(lease.startDate)}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">End Date</p>
                            <p class="font-semibold">${formatDate(lease.endDate)}</p>
                        </div>
                    </div>
                </div>
            `;

            showModal("Lease Details", content, 'alert');
        }

        function showRenewLeaseModal(leaseId) {
            const lease = leases.find(l => l.id === leaseId);
            if (!lease) { showNotification("Could not find the lease to renew.", "error"); return; }

            const formContent = `
                <form id="renewLeaseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="newEndDate">New End Date</label>
                        <input type="date" id="newEndDate" name="newEndDate" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="newMonthlyRent">New Monthly Rent (Ksh)</label>
                        <input type="number" id="newMonthlyRent" name="newMonthlyRent" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${lease.monthlyRent}" required>
                    </div>
                </form>
            `;

            showModal("Renew Lease Agreement", formContent, 'confirm', () => {
                const form = document.getElementById('renewLeaseForm');
                const updatedData = {
                    endDate: form.elements['newEndDate'].value,
                    monthlyRent: parseFloat(form.elements['newMonthlyRent'].value),
                    renewalDate: new Date().toISOString()
                };

                updateData('leases', leaseId, updatedData).then(() => {
                    const leaseIndex = leases.findIndex(l => l.id === leaseId);
                    if (leaseIndex !== -1) leases[leaseIndex] = { ...leases[leaseIndex], ...updatedData };
                });

                showNotification('Lease renewed successfully!', 'success');
                updateLeasesList();
            });
        }

        function showTerminateLeaseModal(leaseId) {
            const lease = leases.find(l => l.id === leaseId);
            if (!lease) { showNotification("Could not find the lease to terminate.", "error"); return; }

            const tenant = tenants.find(t => t.id === lease.tenantId);
            
            showModal("Terminate Lease", `Are you sure you want to terminate the lease agreement with ${tenant?.name || 'this tenant'}?`, 'confirm', () => {
                const updatedData = {
                    status: 'terminated',
                    terminationDate: new Date().toISOString()
                };
                updateData('leases', leaseId, updatedData);
                showNotification('Lease terminated successfully!', 'success');
                updateLeasesList();
            });
        }

        // Maintenance Management Section
        function renderMaintenanceSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Maintenance Management</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Track and manage property maintenance requests</p>
                        </div>
                        <button id="addMaintenanceBtn" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">New Request</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        ${renderStatCard(icons.Wrench, "Open Requests", maintenanceRequests.filter(r => r.status === 'open').length, "open", "bg-gradient-to-r from-orange-500 to-orange-600")}
                        ${renderStatCard(icons.Clock, "In Progress", maintenanceRequests.filter(r => r.status === 'in_progress').length, "progress", "bg-gradient-to-r from-blue-500 to-blue-600")}
                        ${renderStatCard(icons.CheckCircle, "Completed", maintenanceRequests.filter(r => r.status === 'completed').length, "completed", "bg-gradient-to-r from-green-500 to-green-600")}
                        ${renderStatCard(icons.AlertTriangle, "Urgent", maintenanceRequests.filter(r => r.priority === 'urgent').length, "urgent", "bg-gradient-to-r from-red-500 to-red-600")}
                    </div>

                    <div id="maintenanceList" class="space-y-6">
                        ${maintenanceRequests.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-orange-100 to-red-100 flex items-center justify-center">
                                    ${icons.Wrench}
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Maintenance Requests</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Track property maintenance and repairs</p>
                                <button onclick="document.getElementById('addMaintenanceBtn').click()" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl font-medium hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                                    Create First Request
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addMaintenanceBtn').addEventListener('click', () => showAddMaintenanceModal());
            updateMaintenanceList();
        }

        function showAddMaintenanceModal() {
            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">Create Maintenance Request</h3>
                    <p class="text-gray-600 dark:text-gray-400">Report a maintenance issue for a property</p>
                </div>
                <form id="addMaintenanceForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="maintenanceProperty">Property</label>
                        <select id="maintenanceProperty" name="maintenanceProperty" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                            <option value="">Select property...</option>
                            ${properties.map(property => `<option value="${property.id}">${property.name} - ${property.location}</option>`).join('')}
                        </select>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Select the property that needs maintenance</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="maintenanceCategory">Category</label>
                            <select id="maintenanceCategory" name="maintenanceCategory" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                                ${maintenanceCategories.map(category => `<option value="${category}">${category}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="maintenancePriority">Priority</label>
                            <select id="maintenancePriority" name="maintenancePriority" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="maintenanceDescription">Description</label>
                        <textarea id="maintenanceDescription" name="maintenanceDescription" rows="4" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Describe the maintenance issue in detail..." required></textarea>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Provide a detailed description of the problem</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="maintenanceCost">Estimated Cost (Ksh)</label>
                        <input type="number" id="maintenanceCost" name="maintenanceCost" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="0">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Enter estimated cost if known (optional)</p>
                    </div>
                </form>
            `;

            showModal("Create Maintenance Request", formContent, 'confirm', () => {
                const form = document.getElementById('addMaintenanceForm');
                
                const maintenanceData = {
                    // id will be assigned by Firestore
                    propertyId: form.elements['maintenanceProperty'].value,
                    category: form.elements['maintenanceCategory'].value,
                    priority: form.elements['maintenancePriority'].value,
                    description: form.elements['maintenanceDescription'].value,
                    estimatedCost: parseFloat(form.elements['maintenanceCost'].value) || 0,
                    status: 'open',
                    createdAt: new Date().toISOString()
                };

                saveData('maintenanceRequests', maintenanceData).then(savedRequest => {
                    if (savedRequest) {
                        maintenanceRequests.push(savedRequest);
                    }
                });
                showNotification('Maintenance request created successfully!', 'success');
                updateMaintenanceList();
            });
        }

        function updateMaintenanceList() {
            const maintenanceListDiv = document.getElementById('maintenanceList');
            if (!maintenanceListDiv) return;

            if (maintenanceRequests.length === 0) {
                maintenanceListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No maintenance requests found.</p>`;
                return;
            }

            maintenanceListDiv.innerHTML = maintenanceRequests.map(request => {
                const property = properties.find(p => p.id === request.propertyId);
                const priorityColor = request.priority === 'urgent' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                                    request.priority === 'high' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' :
                                    request.priority === 'medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                
                const statusColor = request.status === 'open' ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' :
                                  request.status === 'in_progress' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

                return `
                    <div class="bg-white/50 dark:bg-gray-900/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6 shadow-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 flex items-center justify-center text-white font-bold text-xl">
                                    ${request.category.charAt(0)}
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200">${request.category}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${property?.name || 'Unknown Property'}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${request.description}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 mt-4 md:mt-0">
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${priorityColor}">
                                    ${request.priority.charAt(0).toUpperCase() + request.priority.slice(1)}
                                </span>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                                    ${request.status.replace('_', ' ').charAt(0).toUpperCase() + request.status.replace('_', ' ').slice(1)}
                                </span>
                                <button data-request-id="${request.id}" class="p-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800 transition duration-200" title="Update Status">
                                    ${icons.Edit}
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                            <div class="bg-white/50 dark:bg-gray-900/50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Created</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatDate(request.createdAt)}</p>
                            </div>
                            <div class="bg-white/50 dark:bg-gray-900/50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Estimated Cost</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(request.estimatedCost)}</p>
                            </div>
                            <div class="bg-white/50 dark:bg-gray-900/50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Category</p>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${request.category}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners for maintenance actions
            maintenanceListDiv.querySelectorAll('button[data-request-id]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const requestId = e.currentTarget.dataset.requestId;
                    showUpdateMaintenanceModal(requestId);
                });
            });
        }

        function showUpdateMaintenanceModal(requestId) {
            const request = maintenanceRequests.find(r => r.id === requestId);
            if (!request) { showNotification("Could not find the maintenance request.", "error"); return; }

            const formContent = `
                <form id="updateMaintenanceForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="updateStatus">Status</label>
                        <select id="updateStatus" name="updateStatus" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                            <option value="open" ${request.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="actualCost">Actual Cost (Ksh)</label>
                        <input type="number" id="actualCost" name="actualCost" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${request.actualCost || ''}" placeholder="Enter actual cost">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Add any notes about the maintenance work...">${request.notes || ''}</textarea>
                    </div>
                </form>
            `;

            showModal("Update Maintenance Request", formContent, 'confirm', () => {
                const form = document.getElementById('updateMaintenanceForm');
                const updatedData = {
                    status: form.elements['updateStatus'].value,
                    actualCost: parseFloat(form.elements['actualCost'].value) || 0,
                    notes: form.elements['notes'].value,
                    updatedAt: new Date().toISOString()
                };

                updateData('maintenanceRequests', requestId, updatedData);
                showNotification('Maintenance request updated successfully!', 'success');
                updateMaintenanceList();
            });
        }

        // Reports and Analytics Section
        function renderReportsSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Reports & Analytics</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Comprehensive insights into your rental business</p>
                        </div>
                        <button id="exportReportBtn" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 mt-4 md:mt-0">
                            ${icons.Download} <span class="ml-2">Export Report</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Revenue Analytics -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Revenue Analytics</h4> 
                            <canvas id="revenueAnalyticsChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Occupancy Rate -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Occupancy Rate</h4> 
                            <canvas id="occupancyChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Maintenance Costs -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Maintenance Costs</h4> 
                            <canvas id="maintenanceCostChart" width="400" height="300"></canvas>
                        </div>

                        <!-- Tenant Satisfaction -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Key Metrics</h4> 
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Average Rent</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${formatCurrency(getAverageRent())}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-800/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Collection Rate</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${getCollectionRate()}%</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Vacancy Rate</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${getVacancyRate()}%</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Maintenance Efficiency</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${getMaintenanceEfficiency()}%</span>
                                </div>
                            </div> 
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('exportReportBtn').addEventListener('click', () => exportReport());
            
            // Initialize report charts
            setTimeout(() => {
                initializeReportCharts();
            }, 100);
        }

        function getAverageRent() {
            if (tenants.length === 0) return 0;
            return tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0) / tenants.length;
        }

        function getCollectionRate() {
            const totalExpected = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const totalCollected = payments.reduce((sum, payment) => sum + payment.amount, 0);
            return totalExpected > 0 ? Math.round((totalCollected / totalExpected) * 100) : 0;
        }

        function getVacancyRate() {
            const totalUnits = tenants.length;
            const occupiedUnits = tenants.filter(tenant => tenant.outstandingBalance <= tenant.amountCharged).length;
            return totalUnits > 0 ? Math.round(((totalUnits - occupiedUnits) / totalUnits) * 100) : 0;
        }

        function getMaintenanceEfficiency() {
            const totalRequests = maintenanceRequests.length;
            const completedRequests = maintenanceRequests.filter(r => r.status === 'completed').length;
            return totalRequests > 0 ? Math.round((completedRequests / totalRequests) * 100) : 0;
        }

        function initializeReportCharts() {
            // Revenue Analytics Chart
            const revenueCtx = document.getElementById('revenueAnalyticsChart');
            if (revenueCtx) {
                const monthlyRevenue = getMonthlyRevenueData();
                charts.revenueAnalytics = createChart('revenueAnalyticsChart', {
                    type: 'bar',
                    data: {
                        labels: monthlyRevenue.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: monthlyRevenue.data,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)', // indigo-600
                            borderColor: 'rgba(79, 70, 229, 1)', // indigo-600
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Occupancy Chart
            const occupancyCtx = document.getElementById('occupancyChart');
            if (occupancyCtx) {
                const occupancyData = getOccupancyData();
                charts.occupancy = createChart('occupancyChart', {
                    type: 'doughnut',
                    data: {
                        labels: ['Occupied', 'Vacant'],
                        datasets: [{
                            data: occupancyData,
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Maintenance Cost Chart
            const maintenanceCtx = document.getElementById('maintenanceCostChart');
            if (maintenanceCtx) {
                const maintenanceData = getMaintenanceCostData();
                charts.maintenanceCost = createChart('maintenanceCostChart', {
                    type: 'line',
                    data: {
                        labels: maintenanceData.labels,
                        datasets: [{
                            label: 'Maintenance Costs',
                            data: maintenanceData.data,
                            borderColor: 'rgba(245, 101, 101, 1)',
                            backgroundColor: 'rgba(245, 101, 101, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function getOccupancyData() {
            const totalUnits = tenants.length;
            const occupiedUnits = tenants.filter(tenant => tenant.outstandingBalance <= tenant.amountCharged).length;
            return [occupiedUnits, totalUnits - occupiedUnits];
        }

        function getMaintenanceCostData() {
            const last6Months = [];
            const costData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toISOString().substring(0, 7);
                
                last6Months.push(date.toLocaleDateString('en-KE', { month: 'short', year: 'numeric' }));
                
                const monthlyCost = maintenanceRequests
                    .filter(request => request.createdAt.startsWith(monthYear))
                    .reduce((sum, request) => sum + (request.actualCost || request.estimatedCost), 0);
                
                costData.push(monthlyCost);
            }
            
            return {
                labels: last6Months,
                data: costData
            };
        }

        function exportReport() {
            const reportData = {
                properties: properties.length,
                tenants: tenants.length,
                activeLeases: leases.filter(l => l.status === 'active').length,
                totalRevenue: payments.reduce((sum, p) => sum + p.amount, 0),
                outstandingBalance: tenants.reduce((sum, t) => sum + t.outstandingBalance, 0),
                maintenanceRequests: maintenanceRequests.length,
                averageRent: getAverageRent(),
                collectionRate: getCollectionRate(),
                vacancyRate: getVacancyRate(),
                maintenanceEfficiency: getMaintenanceEfficiency(),
                generatedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rental-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Report exported successfully!', 'success');
        }

        // Settings and Backup Section
        function renderSettingsSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="mb-8">
                        <h3 class="text-3xl font-bold gradient-text">Settings & Data Management</h3>
                        <p class="text-gray-600 dark:text-gray-400 mt-2">Manage your data, backup, and system preferences</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Data Management -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">Data Backup & Restore</h4>
                            <div class="space-y-4"> 
                                <button id="exportDataBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center justify-center font-medium hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                                    ${icons.Download} <span class="ml-2">Export All Data</span>
                                </button>
                                <button id="importDataBtn" class="w-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 px-6 py-3 rounded-xl flex items-center justify-center font-medium hover:bg-gray-300 dark:hover:bg-gray-700 transition duration-200">
                                    ${icons.Upload} <span class="ml-2">Import Data</span>
                                </button>
                            </div>
                        </div>

                        <!-- System Information -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">System Information</h4>
                            <div class="space-y-4"> 
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Properties</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${properties.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Tenants</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${tenants.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Leases</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${leases.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Maintenance Requests</span>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">${maintenanceRequests.length}</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Data Source</span>
                                    <span class="font-bold text-green-600 dark:text-green-400">Cloud (Firestore)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">Preferences</h4>
                            <div class="space-y-4"> 
                                <div class="flex items-center justify-between p-4 bg-white/50 dark:bg-gray-900/50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Dark Mode</span>
                                    <button id="toggleDarkModeBtn" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-700 transition-colors duration-200">
                                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${isDarkMode ? 'translate-x-6' : 'translate-x-1'}"></span> 
                                    </button>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 bg-opacity-50 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-400">Auto Backup</span>
                                    <button id="toggleAutoBackupBtn" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-700 transition-colors duration-200">
                                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 translate-x-1"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- About -->
                        <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6">
                            <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">About</h4>
                            <div class="space-y-4">
                                <div class="text-center">
                                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-indigo-600 to-purple-700 flex items-center justify-center text-white font-bold text-xl">
                                        PA
                                    </div>
                                    <h5 class="font-bold text-gray-800 dark:text-gray-200">Prince Alex Property Management</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Version 2.0</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Comprehensive rental management system for Kenya</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;

            // Add event listeners
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importData(e.target.files[0]);
                }
            });
            document.getElementById('toggleDarkModeBtn').addEventListener('click', toggleDarkMode);
        }

        function renderPropertiesSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">Your Properties</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">Manage your property portfolio and tenants</p>
                        </div>
                        <button id="addPropertyBtn" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">Add Property</span>
                        </button>
                    </div>

                    <div id="propertiesList" class="space-y-6">
                        ${properties.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 flex items-center justify-center">
                                    ${icons.Building}
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Properties Yet</h4>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Start building your property portfolio by adding your first property</p>
                                <button onclick="document.getElementById('addPropertyBtn').click()" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl font-medium hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300">
                                    Get Started
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addPropertyBtn').addEventListener('click', () => showAddPropertyModal());
            updatePropertiesList();
        }

        function renderTenantsSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/30 dark:bg-gray-800/30 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold gradient-text">All Tenants</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-2">View and manage all tenants across your properties</p>
                        </div>
                        <button id="addTenantBtn" class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center font-medium shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 mt-4 md:mt-0">
                            ${icons.PlusCircle} <span class="ml-2">Add Tenant</span>
                        </button>
                    </div>

                    <div class="relative mb-6">
                        <input type="text" id="tenantSearchInput" placeholder="Search tenants by name, house, or phone..." class="w-full pl-12 pr-4 py-3 border-0 rounded-xl bg-white/30 dark:bg-gray-900/30 backdrop-blur-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400" value="${tenantSearchQuery}">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            ${icons.Search}
                        </div>
                    </div>

                    <div id="allTenantsListContainer">
                        <!-- Tenant table will be rendered here -->
                    </div>
                </section>
            `;

            document.getElementById('addTenantBtn').addEventListener('click', () => showAddTenantModal());
            document.getElementById('tenantSearchInput').addEventListener('input', (e) => {
                tenantSearchQuery = e.target.value;
                renderAllTenantsList();
            });
            renderAllTenantsList();
        }

        function renderAllTenantsList() {
            const container = document.getElementById('allTenantsListContainer');
            if (!container) return;

            const lowerCaseQuery = tenantSearchQuery.toLowerCase();
            const filteredTenants = tenants.filter(t => 
                t.name.toLowerCase().includes(lowerCaseQuery) || 
                t.houseNumber.toLowerCase().includes(lowerCaseQuery) ||
                t.phoneNumber.includes(lowerCaseQuery)
            );

            if (filteredTenants.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 flex items-center justify-center">
                            ${icons.Users}
                        </div>
                        <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">No Tenants Found</h4>
                        <p class="text-gray-600 dark:text-gray-400">No tenants match your search, or you haven't added any yet.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="bg-white/80 dark:bg-gray-900/50 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Tenant</th>
                                    <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Property & House</th>
                                    <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Rent</th>
                                    <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Balance</th>
                                    <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Phone</th>
                                    <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                ${filteredTenants.map(tenant => getTenantTableRowHTML(tenant)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Re-attach event listeners for this view
            container.querySelectorAll('.payment-btn').forEach(button => button.addEventListener('click', (e) => showPaymentModal(tenants.find(t => t.id === e.currentTarget.dataset.tenantId))));
            container.querySelectorAll('.water-meter-btn').forEach(button => button.addEventListener('click', (e) => showWaterMeterReadingModal(tenants.find(t => t.id === e.currentTarget.dataset.tenantId))));
            container.querySelectorAll('.edit-tenant-btn').forEach(button => button.addEventListener('click', (e) => showEditTenantModal(tenants.find(t => t.id === e.currentTarget.dataset.tenantId))));
            container.querySelectorAll('.delete-tenant-btn').forEach(button => button.addEventListener('click', (e) => handleDeleteTenant(e.currentTarget.dataset.tenantId)));
        }

        function updatePropertiesList() {
            const propertiesListDiv = document.getElementById('propertiesList');
            if (!propertiesListDiv) return;

            if (properties.length === 0) {
                propertiesListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No properties added yet. Click "Add Property" to get started!</p>`;
                return;
            }

            propertiesListDiv.innerHTML = properties.map(property => {
                const tenantsForProperty = tenants.filter(t => t.propertyId === property.id);
                return `
                    <div class="bg-white/50 dark:bg-gray-800/40 backdrop-blur-md border border-white/20 dark:border-gray-700/50 rounded-2xl p-6 shadow-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6"> 
                            <div class="flex items-center space-x-4">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-700 flex items-center justify-center text-white font-bold text-xl">
                                    ${property.name.charAt(0)}
                                </div> 
                                <div>
                                    <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200">${property.name}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${property.location}</p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${tenantsForProperty.length} tenants</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400"></span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">${formatCurrency(tenantsForProperty.reduce((sum, t) => sum + t.amountCharged, 0))}/month</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-4 md:mt-0">
                                <button data-property-id="${property.id}" class="add-tenant-btn bg-gradient-to-r from-green-500 to-teal-500 text-white px-4 py-2 rounded-xl text-sm flex items-center font-medium hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                                    ${icons.PlusCircle} <span class="ml-1">Add Tenant</span>
                                </button>
                                <button data-property-id="${property.id}" class="delete-property-btn bg-gradient-to-r from-red-500 to-pink-500 text-white px-4 py-2 rounded-xl text-sm flex items-center font-medium hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                                    ${icons.Trash2} <span class="ml-1">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            // Attach event listeners after rendering
            propertiesListDiv.querySelectorAll('.add-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    showAddTenantModal(e.currentTarget.dataset.propertyId);
                });
            });

            propertiesListDiv.querySelectorAll('.delete-property-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.propertyId;
                    handleDeleteProperty(propertyId);
                });
            });

        }

        function getTenantTableRowHTML(tenant) {
            const property = properties.find(p => p.id === tenant.propertyId);
            const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-green-600 dark:text-green-400';
            const balanceText = tenant.outstandingBalance > 0 ? `${formatCurrency(tenant.outstandingBalance)} Due` : 'Paid';
            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200">
                    <td class="py-4 px-6 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm mr-3">
                                ${tenant.name.charAt(0)}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">${tenant.name}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${property?.name || 'N/A'} <span class="font-medium text-gray-800 dark:text-gray-200">(${tenant.houseNumber})</span></td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-gray-100">${formatCurrency(tenant.amountCharged)}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm ${balanceColor}">${balanceText}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${tenant.phoneNumber}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm">
                        <div class="flex space-x-2">
                            <button data-tenant-id="${tenant.id}" class="payment-btn p-2 rounded-lg bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-400 hover:bg-green-200 dark:hover:bg-green-800 transition duration-200" title="Record Payment">
                                ${icons.Wallet}
                            </button>
                            <button data-tenant-id="${tenant.id}" class="water-meter-btn p-2 rounded-lg bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-400 hover:bg-cyan-200 dark:hover:bg-cyan-800 transition duration-200" title="Record Water Meter Reading">
                                
                            </button>
                            <button data-tenant-id="${tenant.id}" class="edit-tenant-btn p-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800 transition duration-200" title="Edit Tenant">
                                ${icons.Edit}
                            </button>
                            <button data-tenant-id="${tenant.id}" class="delete-tenant-btn p-2 rounded-lg bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-800 transition duration-200" title="Delete Tenant">
                                ${icons.Trash2}
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Add Property Modal
        function showAddPropertyModal(propertyToEdit = null) {
            const isEditing = !!propertyToEdit;
            const title = isEditing ? 'Edit Property' : 'Add New Property';
            const buttonText = isEditing ? 'Save Changes' : 'Add Property';

            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">${isEditing ? 'Edit Property' : 'Add New Property'}</h3>
                    <p class="text-gray-600 dark:text-gray-400">${isEditing ? 'Update property information' : 'Enter property details'}</p>
                </div>
                <form id="addEditPropertyForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="propertyName">Property Name</label>
                        <input type="text" id="propertyName" name="propertyName" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${propertyToEdit ? propertyToEdit.name : ''}" placeholder="e.g., Apollo Heights" required>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">A descriptive name for the property.</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="propertyLocation">Location</label>
                        <input type="text" id="propertyLocation" name="propertyLocation" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${propertyToEdit ? propertyToEdit.location : ''}" placeholder="e.g., Westlands, Nairobi" required>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">The physical address or area of the property.</p>
                    </div>
                </form>
            `;

            showModal(title, formContent, 'confirm', () => {
                const form = document.getElementById('addEditPropertyForm');
                const newPropertyData = {
                    name: form.elements['propertyName'].value,
                    location: form.elements['propertyLocation'].value,
                };

                try {
                    if (isEditing) {
                        updateData('properties', propertyToEdit.id, newPropertyData).then(() => {
                            const index = properties.findIndex(p => p.id === propertyToEdit.id);
                            if (index !== -1) properties[index] = { ...properties[index], ...newPropertyData };
                            updatePropertiesList();
                        });
                        showNotification("Property updated successfully!", "success");
                    } else {
                        saveData('properties', newPropertyData).then(savedProperty => {
                            if (savedProperty) properties.push(savedProperty);
                            updatePropertiesList();
                        });
                        showNotification("Property added successfully!", "success");
                    }
                    updateBillingTenantDropdown(); // Update dropdowns that depend on properties
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                    // If on the billing tab, re-render it to update the property dropdown
                    if (activeTab === 'billing') {
                        renderBillingSection(document.getElementById('contentSection'));
                    }
                } catch (e) {
                    console.error("Error saving property: ", e);
                    showModal("Error", `Failed to save property. Please try again.`);
                }
            });
        }

        // Delete Property Handler
        function handleDeleteProperty(propertyId) {
            const propertyToDelete = properties.find(p => p.id === propertyId);
            if (!propertyToDelete) {
                showNotification("Could not find the property to delete.", "error");
                return;
            }
            showModal("Confirm Deletion", `Are you sure you want to delete the property '${propertyToDelete.name}'? This will also delete all associated tenants and bills.`, 'confirm', () => {
                try {
                    // This is a complex delete. For simplicity here, we delete from the client-side arrays
                    // and then from Firestore. A more robust solution would use Firebase Functions for cascading deletes.
                    deleteData('properties', propertyId);
                    tenants.filter(t => t.propertyId === propertyId).forEach(t => deleteData('tenants', t.id));
                    bills.filter(b => b.propertyId === propertyId).forEach(b => deleteData('bills', b.id));
                    payments.filter(p => p.propertyId === propertyId).forEach(p => deleteData('payments', p.id));

                    // Update local state
                    properties = properties.filter(p => p.id !== propertyId);                    
                    tenants = tenants.filter(t => t.propertyId !== propertyId);                    
                    bills = bills.filter(b => b.propertyId !== propertyId);                    
                    payments = payments.filter(p => p.propertyId !== propertyId);                    


                    showNotification(`Property '${propertyToDelete.name}' and all associated data deleted successfully.`, "success");
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantDropdown(); // Update dropdowns
                    updateGeneratedBillsList(); // Update bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                    if (activeTab === 'billing') {
                        renderBillingSection(document.getElementById('contentSection'));
                    }
                } catch (e) {
                    console.error("Error deleting property: ", e);
                    showNotification("Failed to delete the property. Please try again.", "error");
                }
            });
        }

        // Fresh Add Tenant Modal Implementation
        function showAddTenantModal(preselectedPropertyId = null) {
            if (properties.length === 0) {
                showNotification('Please add a property before adding a tenant.', 'error');
                return;
            }

            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">Add New Tenant</h3>
                    <p class="text-gray-600 dark:text-gray-400">Enter details for the new tenant</p>
                </div>
                <form id="addTenantForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="propertySelect">Select Property</label>
                        <select id="propertySelect" name="propertySelect" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                                        <option value="">Choose a property...</option>${properties.map(property => `<option value="${property.id}" ${preselectedPropertyId === property.id ? 'selected' : ''}>${property.name} - ${property.location}</option>`).join('')}
                                    </select> 
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Select the property for this tenant.</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="tenantName">Tenant Name</label>
                                        <input type="text" id="tenantName" name="tenantName" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Enter full name" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="houseNumber">House/Unit Number</label>
                                        <input type="text" id="houseNumber" name="houseNumber" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="e.g., A1, 2B" required>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="houseType">House Type</label>
                                        <select id="houseType" name="houseType" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                                            <option value="">Select type...</option>
                                            ${houseTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="rentAmount">Monthly Rent (Ksh)</label>
                                        <input type="number" id="rentAmount" name="rentAmount" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="0" required>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="phoneNumber">Phone Number</label>
                                    <input type="tel" id="phoneNumber" name="phoneNumber" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="+254 700 000 000" required>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="initialWaterMeter">Initial Water Meter Reading</label>
                                        <input type="number" id="initialWaterMeter" name="initialWaterMeter" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="0" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="waterMeterNumber">Water Meter Number</label>
                                        <input type="text" id="waterMeterNumber" name="waterMeterNumber" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="e.g., WM001">
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Billing Preferences</label>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                                            <input type="checkbox" id="includeWater" name="includeWater" checked class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500">
                                            <span>Include Water Bill (Ksh ${WATER_PRICE_PER_UNIT}/unit)</span>
                                        </label>
                                        <label class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                                            <input type="checkbox" id="includeGarbage" name="includeGarbage" checked class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500">
                                            <span>Include Garbage Collection (Ksh ${GARBAGE_COLLECTION_FEE}/month)</span>
                                        </label>
                                    </div>
                                </div>
                            </form>
            `;

            showModal("Add New Tenant", formContent, 'confirm', (closeModal) => {
                const form = document.getElementById('addTenantForm');
                
                const propertyId = document.getElementById('propertySelect').value;
                const tenantName = document.getElementById('tenantName').value;
                const houseNumber = document.getElementById('houseNumber').value;
                const houseType = document.getElementById('houseType').value;
                const rentAmount = parseFloat(document.getElementById('rentAmount').value);
                const phoneNumber = document.getElementById('phoneNumber').value;
                const initialWaterMeter = parseFloat(document.getElementById('initialWaterMeter').value) || 0;
                const waterMeterNumber = document.getElementById('waterMeterNumber').value;
                const includeWater = document.getElementById('includeWater').checked;
                const includeGarbage = document.getElementById('includeGarbage').checked;

                if (!propertyId || !tenantName || !houseNumber || !houseType || !rentAmount || !phoneNumber) {
                    showNotification('Please fill in all required fields to add a tenant.', 'error');
                    return;
                }

                const selectedProperty = properties.find(p => p.id === propertyId);
                if (!selectedProperty) {
                    showNotification('The selected property could not be found.', 'error');
                    return;
                }

                // Create new tenant
                const newTenant = {
                    // id will be assigned by Firestore
                    propertyId: propertyId,
                    name: tenantName,
                    houseNumber: houseNumber,
                    houseType: houseType,
                    amountCharged: rentAmount,
                    phoneNumber: phoneNumber,
                    outstandingBalance: 0,
                    lastBilledDate: null,
                    lastPaidDate: null,
                    createdAt: new Date().toISOString(),
                    // Water meter data
                    waterMeterNumber: waterMeterNumber,
                    initialWaterMeterReading: initialWaterMeter,
                    currentWaterMeterReading: initialWaterMeter,
                    lastWaterMeterReadingDate: new Date().toISOString(),
                    // Billing preferences
                    includeWaterBill: includeWater,
                    includeGarbageCollection: includeGarbage,
                    // Monthly billing tracking
                    nextBillingDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
                };

                saveData('tenants', newTenant).then(savedTenant => {
                    if (savedTenant) {
                        tenants.push(savedTenant);
                        // You might also want to save the initial water meter reading here as a separate record
                        if (activeTab === 'tenants') renderAllTenantsList();
                    }
                    updatePropertiesList();
                });
                
                showNotification('Tenant added successfully!', 'success');                
                
                updateBillingTenantList();
                renderFinancialSection(document.getElementById('contentSection'));
            });            
        }
        // Edit Tenant Modal Implementation
        function showEditTenantModal(tenantToEdit) {
            const property = properties.find(p => p.id === tenantToEdit.propertyId);
            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">Edit Tenant Details</h3>
                    <p class="text-gray-600 dark:text-gray-400">Update tenant information</p>
                </div>
                <form id="editTenantForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Property</label>
                        <input type="text" value="${property ? property.name : 'Unknown'}" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 cursor-not-allowed" readonly>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="editTenantName">Tenant Name</label>
                            <input type="text" id="editTenantName" name="editTenantName" value="${tenantToEdit.name}" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="editHouseNumber">House/Unit Number</label>
                            <input type="text" id="editHouseNumber" name="editHouseNumber" value="${tenantToEdit.houseNumber}" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="editHouseType">House Type</label>
                            <select id="editHouseType" name="editHouseType" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                                            ${houseTypes.map(type => `<option value="${type}" ${tenantToEdit.houseType === type ? 'selected' : ''}>${type}</option>`).join('')}
                                        </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="editRentAmount">Monthly Rent (Ksh)</label>
                            <input type="number" id="editRentAmount" name="editRentAmount" value="${tenantToEdit.amountCharged}" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="editPhoneNumber">Phone Number</label>
                        <input type="tel" id="editPhoneNumber" name="editPhoneNumber" value="${tenantToEdit.phoneNumber}" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" required>
                    </div>
                </form>
            `;

            showModal("Edit Tenant Details", formContent, 'confirm', () => {
                const form = document.getElementById('editTenantForm');
                
                const tenantName = document.getElementById('editTenantName').value;
                const houseNumber = document.getElementById('editHouseNumber').value;
                const houseType = document.getElementById('editHouseType').value;
                const rentAmount = parseFloat(document.getElementById('editRentAmount').value);
                const phoneNumber = document.getElementById('editPhoneNumber').value;

                if (!tenantName || !houseNumber || !houseType || !rentAmount || !phoneNumber) {
                    showNotification('Please fill in all required fields to update the tenant.', 'error');
                    return;
                }

                // Update tenant data
                const updatedData = {
                    name: tenantName,
                    houseNumber: houseNumber,
                    houseType: houseType,
                    amountCharged: rentAmount,
                    phoneNumber: phoneNumber
                };

                updateData('tenants', tenantToEdit.id, updatedData).then(() => {
                    const tenantIndex = tenants.findIndex(t => t.id === tenantToEdit.id);
                    if (tenantIndex !== -1) tenants[tenantIndex] = { ...tenants[tenantIndex], ...updatedData };
                });
                
                showNotification('Tenant updated successfully!', 'success');
                
                // Refresh the properties list
                updatePropertiesList();
                if (activeTab === 'tenants') renderAllTenantsList();
                updateBillingTenantList();
                renderFinancialSection(document.getElementById('contentSection'));
            });            
        }
        // Water Meter Reading Modal
        function showWaterMeterReadingModal(tenant) {
            const property = properties.find(p => p.id === tenant.propertyId);
            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">Record Water Meter Reading</h3>
                    <p class="text-gray-600 dark:text-gray-400">Enter the latest water meter reading for the tenant</p>
                </div>
                <form id="waterMeterForm">
                    <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">Tenant Information</h4>
                        <p class="text-gray-700 dark:text-gray-300"><strong>Name:</strong> ${tenant.name}</p>
                        <p class="text-gray-700 dark:text-gray-300"><strong>House:</strong> ${tenant.houseNumber}</p>
                        <p class="text-gray-700 dark:text-gray-300"><strong>Property:</strong> ${property ? property.name : 'Unknown'}</p>
                        <p class="text-gray-700 dark:text-gray-300"><strong>Meter Number:</strong> ${tenant.waterMeterNumber || 'Not set'}</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="currentReading">Current Meter Reading</label>
                        <input type="number" id="currentReading" name="currentReading" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Enter current reading" required>
                        <small class="text-gray-500 dark:text-gray-400 mt-2 block">Last reading: ${tenant.currentWaterMeterReading || 0} units</small>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="readingDate">Reading Date</label>
                        <input type="date" id="readingDate" name="readingDate" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${new Date().toISOString().substring(0, 10)}" required>
                    </div>
                    
                    <div class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                        <h4 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Estimated Bill</h4>
                        <div id="billEstimate" class="text-gray-700 dark:text-gray-300">
                            <p class="mb-1">Water units used: <span id="unitsUsed" class="font-medium">0</span></p>
                            <p class="mb-1">Water cost: Ksh <span id="waterCost" class="font-medium">0</span></p>
                            <p class="mb-1">Garbage fee: Ksh <span id="garbageCost" class="font-medium">${tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0}</span></p>
                            <p class="mt-2 font-bold text-lg">Total: Ksh <span id="totalCost">0</span></p>
                        </div>
                    </div>
                </form>
            `;

            const { closeModal, modalElement } = showModal("Record Water Meter Reading", formContent, 'confirm', () => {
                const form = modalElement.querySelector('#waterMeterForm');
                const currentReading = parseFloat(form.elements['currentReading'].value);
                const readingDate = form.elements['readingDate'].value;

                if (isNaN(currentReading) || currentReading < 0) {
                    showNotification('Please enter a valid, positive number for the meter reading.', 'error');
                    return;
                }

                if (currentReading < (tenant.currentWaterMeterReading || 0)) {
                    showNotification('The new reading cannot be less than the previous one.', 'error');
                    return;
                }

                // Create water meter reading record
                const waterReading = {
                    // id will be assigned by Firestore
                    tenantId: tenant.id,
                    tenantName: tenant.name,
                    propertyId: tenant.propertyId,
                    houseNumber: tenant.houseNumber,
                    waterMeterNumber: tenant.waterMeterNumber,
                    readingValue: currentReading,
                    readingDate: new Date(readingDate).toISOString(),
                    previousReading: tenant.currentWaterMeterReading,
                    unitsUsed: currentReading - (tenant.currentWaterMeterReading || 0),
                    waterCost: (currentReading - (tenant.currentWaterMeterReading || 0)) * WATER_PRICE_PER_UNIT,
                    createdAt: new Date().toISOString()
                };

                saveData('waterMeterReadings', waterReading).then(savedReading => {
                    if (savedReading) waterMeterReadings.push(savedReading);
                });

                // Update tenant's current reading in Firestore
                updateData('tenants', tenant.id, {
                    currentWaterMeterReading: currentReading,
                    lastWaterMeterReadingDate: new Date(readingDate).toISOString()
                }).then(() => {
                    const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                    if (tenantIndex !== -1) tenants[tenantIndex].currentWaterMeterReading = currentReading;
                });
                
                if (activeTab === 'tenants') renderAllTenantsList();
                showNotification('Water meter reading recorded successfully!', 'success');
                
                // Refresh the properties list
                updatePropertiesList();
            });

            // Attach event listener for dynamic bill estimate
            const currentReadingInput = modalElement.querySelector('#currentReading');
            const updateBillEstimate = () => {
                const currentReading = parseFloat(currentReadingInput.value) || 0;                
                const lastReading = tenant.currentWaterMeterReading || 0;
                const unitsUsed = Math.max(0, currentReading - lastReading);
                const waterCost = unitsUsed * WATER_PRICE_PER_UNIT;
                const garbageCost = tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0;
                const totalCost = waterCost + garbageCost;
                
                modalElement.querySelector('#unitsUsed').textContent = unitsUsed;
                modalElement.querySelector('#waterCost').textContent = waterCost.toFixed(2);
                modalElement.querySelector('#garbageCost').textContent = garbageCost;
                modalElement.querySelector('#totalCost').textContent = totalCost.toFixed(2);
            };

            currentReadingInput.addEventListener('input', updateBillEstimate);
            updateBillEstimate(); // Initial calculation
        }

        // Delete Tenant Handler
        function handleDeleteTenant(tenantId) {
            const tenantToDelete = tenants.find(t => t.id === tenantId);
            if (!tenantToDelete) {
                showNotification("Could not find the tenant to delete.", "error");
                return;
            }
            showModal("Confirm Deletion", `Are you sure you want to delete the tenant '${tenantToDelete.name}' from house '${tenantToDelete.houseNumber}'? This action cannot be undone.`, 'confirm', () => {
                try {
                    // Again, a robust solution would use Firebase Functions for cascading deletes.
                    deleteData('tenants', tenantId);
                    bills.filter(b => b.tenantId === tenantId).forEach(b => deleteData('bills', b.id));
                    payments.filter(p => p.tenantId === tenantId).forEach(p => deleteData('payments', p.id));
                    leases.filter(l => l.tenantId === tenantId).forEach(l => deleteData('leases', l.id));

                    // Update local state
                    tenants = tenants.filter(t => t.id !== tenantId);                    
                    bills = bills.filter(b => b.tenantId !== tenantId);
                    payments = payments.filter(p => p.tenantId !== tenantId);                    
                    leases = leases.filter(l => l.tenantId !== tenantId);                    

                    showNotification("Tenant deleted successfully!", "success");

                    updatePropertiesList(); // Re-render properties section
                    if (activeTab === 'tenants') renderAllTenantsList();
                    updateBillingTenantList(); // Re-render billing tenant list
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting tenant: ", e);
                    showNotification("Failed to delete the tenant. Please try again.", "error");
                }
            });
        }

        // Payment Modal
        function showPaymentModal(tenant) {
            const formContent = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold form-title-gradient bg-clip-text text-transparent mb-2">Record Payment</h3>
                    <p class="text-gray-600 dark:text-gray-400">Record a payment from ${tenant.name}</p>
                </div>
                <form id="paymentForm">
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Tenant Information</label>
                        <div class="bg-blue-50 dark:bg-blue-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">${tenant.name}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">House: ${tenant.houseNumber}</p>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Outstanding Balance</label>
                        <div class="bg-red-50 dark:bg-red-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-xl font-bold text-red-600 dark:text-red-400">${formatCurrency(tenant.outstandingBalance)}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="paymentAmount">Payment Amount (Ksh)</label>
                            <input type="number" id="paymentAmount" name="paymentAmount" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" step="0.01" min="0" value="${tenant.outstandingBalance.toFixed(2)}" required>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Enter the amount being paid</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="paymentDate">Date of Payment</label>
                            <input type="date" id="paymentDate" name="paymentDate" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${new Date().toISOString().substring(0, 10)}" required>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 italic">Select the payment date</p>
                        </div>
                    </div>
                </form>
            `;

            showModal("Record Payment", formContent, 'confirm', () => {
                const form = document.getElementById('paymentForm');
                const paymentAmount = parseFloat(form.elements['paymentAmount'].value);
                const paymentDate = form.elements['paymentDate'].value;

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showNotification("Please enter a valid payment amount.", "error");
                    return;
                }

                try {
                    // Add a new payment record
                    const paymentRecord = {
                        // id will be assigned by Firestore
                        tenantId: tenant.id,
                        tenantName: tenant.name,
                        propertyId: tenant.propertyId,
                        houseNumber: tenant.houseNumber,
                        amount: paymentAmount,
                        paymentDate: new Date(paymentDate).toISOString(),
                    };

                    saveData('payments', paymentRecord).then(savedPayment => {
                        if (savedPayment) payments.push(savedPayment);
                    });

                    // Update tenant's balance
                    const newBalance = tenant.outstandingBalance - paymentAmount;
                    updateData('tenants', tenant.id, {
                        outstandingBalance: newBalance,
                        lastPaidDate: new Date(paymentDate).toISOString()
                    }).then(() => {
                        const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                        if (tenantIndex !== -1) tenants[tenantIndex].outstandingBalance = newBalance;
                        if (activeTab === 'tenants') renderAllTenantsList();
                        updatePropertiesList();
                    });

                    showModal("Success", `Payment of Ksh ${paymentAmount.toFixed(2)} recorded successfully! New balance is Ksh ${tenants[tenantIndex].outstandingBalance.toFixed(2)}.`);
                    updatePropertiesList(); // Re-render properties section to update balance display
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error recording payment: ", e);
                    showNotification("Failed to record the payment. Please try again.", "error");
                }
            });
        }


        // Render Billing Section
        function renderBillingSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white/50 dark:bg-gray-900/40 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-3xl font-bold gradient-text mb-4 md:mb-0">Generate Bills</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <input type="text" id="billingTenantSearch" placeholder="Search tenants..." class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${billingTenantSearchQuery}">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    ${icons.Search}
                                </div>
                            </div>
                            <select id="billingPropertyFilter" class="w-full md:w-auto p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition">
                                <option value="">All Properties</option>
                                ${properties.map(p => `<option value="${p.id}" ${selectedPropertyForBillingFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <button id="generateBillsBtn"
                                class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white px-6 py-3 rounded-xl flex items-center justify-center hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300">
                                ${icons.PlusCircle} <span class="ml-2">Generate Bills</span>
                            </button>
                        </div>
                    </div>
                    <div id="tenantsToBillList" class="space-y-4">
                        <!-- Tenant list will be rendered here -->
                    </div>
                    
                    <div class="mt-8 border-t border-gray-200/50 dark:border-gray-700/50 pt-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">Bills History</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mb-4"> 
                            <input type="month" id="billingHistoryMonthFilter" value="${billingHistoryFilterMonth}" class="w-full md:w-auto p-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition">
                            <button id="showAllBillsBtn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">Show All Bills</button>
                        </div>
                        <div id="billsHistoryList" class="space-y-4">
                            <!-- Bills history will be rendered here -->
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('billingTenantSearch').addEventListener('input', (e) => { // Use input event for live search
                billingTenantSearchQuery = e.target.value;
                updateBillingTenantList();
            });
            
            document.getElementById('billingPropertyFilter').addEventListener('change', (e) => {
                selectedPropertyForBillingFilter = e.target.value;
                updateBillingTenantList();
            });

            document.getElementById('generateBillsBtn').addEventListener('click', handleGenerateBills);
            document.getElementById('billingHistoryMonthFilter').addEventListener('change', (e) => {
                billingHistoryFilterMonth = e.target.value;
                updateGeneratedBillsList();
            });
            document.getElementById('showAllBillsBtn').addEventListener('click', () => {
                billingHistoryFilterMonth = '';
                document.getElementById('billingHistoryMonthFilter').value = '';
                updateGeneratedBillsList();
            });

            updateBillingTenantList();
            updateGeneratedBillsList();
        }

        function updateBillingTenantList() {
            const tenantsToBillListDiv = document.getElementById('tenantsToBillList');
            if (!tenantsToBillListDiv) return;

            const filteredTenants = tenants.filter(tenant => {
                const matchesSearch = tenant.name.toLowerCase().includes(billingTenantSearchQuery.toLowerCase()) || tenant.houseNumber.toLowerCase().includes(billingTenantSearchQuery.toLowerCase());
                const matchesProperty = selectedPropertyForBillingFilter === '' || tenant.propertyId === selectedPropertyForBillingFilter;
                return matchesSearch && matchesProperty;
            });

            if (filteredTenants.length === 0) {
                tenantsToBillListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No matching tenants found to bill.</p>`;
                return;
            }

            tenantsToBillListDiv.innerHTML = `
                <p class="text-gray-600">Select tenants to generate a bill for the current month:</p>
                <div class="overflow-x-auto bg-white/80 dark:bg-gray-900/50 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-xl"> 
                    <table class="min-w-full">
                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                            <tr>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllTenants" class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500">
                                </th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Tenant</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">House No.</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Property</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Balance</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Last Billed</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            ${filteredTenants.map(tenant => {
                                const lastBilledDate = tenant.lastBilledDate ? new Date(tenant.lastBilledDate).toLocaleDateString() : 'Never';
                                const property = properties.find(p => p.id === tenant.propertyId)?.name || 'N/A';
                                const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
                                return `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200">
                                        <td class="py-4 px-6 whitespace-nowrap text-sm">
                                            <input type="checkbox" name="tenantToBill" value="${tenant.id}" class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500">
                                        </td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${tenant.name}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${tenant.houseNumber}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${property}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm font-medium ${balanceColor}">${formatCurrency(tenant.outstandingBalance)}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${lastBilledDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Add event listener for "select all" checkbox
            document.getElementById('selectAllTenants').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('input[name="tenantToBill"]');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
        }

        async function handleGenerateBills() {
            const selectedTenantIds = Array.from(document.querySelectorAll('input[name="tenantToBill"]:checked')).map(cb => cb.value);

            if (selectedTenantIds.length === 0) {
                showNotification("Please select at least one tenant to generate a bill.", "error");
                return;
            }

            const currentMonthYear = new Date().toISOString().substring(0, 7); // e.g., "2024-05"

            // Check if bills have already been generated for this month
            const alreadyBilledTenants = bills.filter(bill =>
                selectedTenantIds.includes(bill.tenantId) && bill.billingPeriod === currentMonthYear
            ).map(bill => tenants.find(t => t.id === bill.tenantId)?.name || 'Unknown Tenant');

            if (alreadyBilledTenants.length > 0) {
                showNotification(`Bills for this month already exist for: ${alreadyBilledTenants.join(', ')}.`, 'error');
                return;
            }

            // Show water meter reading modal for each selected tenant
            const tenantsToBill = tenants.filter(t => selectedTenantIds.includes(t.id));
            await showWaterMeterReadingForBilling(tenantsToBill, currentMonthYear);
        }

        async function showWaterMeterReadingForBilling(tenantsToBill, currentMonthYear) {
            if (tenantsToBill.length === 0) {
                // This is the end of the loop, no error needed.
                return;
            }

            const tenant = tenantsToBill[0];
            const property = properties.find(p => p.id === tenant.propertyId);
            
            const formContent = document.createElement('form');
            formContent.id = 'waterMeterBillingForm';
            formContent.innerHTML = `
                <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">Tenant Information</h4>
                    <p class="text-gray-700 dark:text-gray-300"><strong>Name:</strong> ${tenant.name}</p>
                    <p class="text-gray-700 dark:text-gray-300"><strong>House:</strong> ${tenant.houseNumber}</p>
                    <p class="text-gray-700 dark:text-gray-300"><strong>Property:</strong> ${property ? property.name : 'Unknown'}</p>
                    <p class="text-gray-700 dark:text-gray-300"><strong>Meter Number:</strong> ${tenant.waterMeterNumber || 'Not set'}</p>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="currentReading">Current Water Meter Reading</label>
                    <input type="number" id="currentReading" name="currentReading" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" placeholder="Enter current reading" required>
                    <small class="text-gray-500 dark:text-gray-400 mt-2 block">Last reading: ${tenant.currentWaterMeterReading || 0} units</small>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="readingDate">Reading Date</label>
                    <input type="date" id="readingDate" name="readingDate" class="w-full p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white/80 dark:bg-gray-800/80 focus:border-indigo-500 focus:ring-indigo-500/20 focus:ring-4 outline-none transition" value="${new Date().toISOString().substring(0, 10)}" required>
                </div>
                <div class="mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                    <h4 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2">Bill Calculation</h4>
                    <div id="billCalculation" class="text-gray-700 dark:text-gray-300 space-y-1">
                        <p><strong>Base Rent:</strong> Ksh <span id="baseRent">${tenant.amountCharged}</span></p>
                        <p>Water units used: <span id="unitsUsed" class="font-medium">0</span></p>
                        <p>Water cost: Ksh <span id="waterCost" class="font-medium">0</span></p>
                        <p>Garbage fee: Ksh <span id="garbageCost" class="font-medium">${tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0}</span></p>
                        <hr class="my-2 border-yellow-300/50 dark:border-yellow-700/50">
                        <p class="font-bold text-lg">Total Bill: Ksh <span id="totalBill">${tenant.amountCharged}</span></p>
                    </div>
                </div>
            `;

            const modalTitle = `Bill for ${tenant.name} (${tenantsToBill.indexOf(tenant) + 1} of ${tenantsToBill.length})`;
            showModal(modalTitle, formContent, 'confirm', (closeModal) => {
                handleGenerateBillForSingleTenant(formContent, tenant, currentMonthYear, () => {
                    closeModal();
                    const remainingTenants = tenantsToBill.slice(1);
                    if (remainingTenants.length > 0) {
                        showWaterMeterReadingForBilling(remainingTenants, currentMonthYear);
                    } else {
                        showNotification('All bills generated successfully!', 'success');
                        updateBillingTenantList();
                        updateGeneratedBillsList();
                    }
                });
            });

            const currentReadingInput = document.getElementById('currentReading');

            // Calculate bill when reading changes
            const updateBillCalculation = () => {
                const currentReading = parseFloat(currentReadingInput.value) || 0;
                const lastReading = tenant.currentWaterMeterReading || 0;
                const unitsUsed = Math.max(0, currentReading - lastReading);
                const waterCost = unitsUsed * WATER_PRICE_PER_UNIT;
                const garbageCost = tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0;
                const totalBill = tenant.amountCharged + waterCost + garbageCost;

                formContent.querySelector('#unitsUsed').textContent = unitsUsed;
                formContent.querySelector('#waterCost').textContent = waterCost.toFixed(2);
                formContent.querySelector('#garbageCost').textContent = garbageCost;
                formContent.querySelector('#totalBill').textContent = totalBill.toFixed(2);
            };

            currentReadingInput.addEventListener('input', updateBillCalculation);            
            updateBillCalculation(); // Initial calculation
        }

        // Helper function for single tenant bill generation (extracted from showWaterMeterReadingForBilling)
        function handleGenerateBillForSingleTenant(form, tenant, currentMonthYear, callback) {
            const currentReading = parseFloat(form.elements['currentReading'].value);
            const readingDate = form.elements['readingDate'].value;

            if (isNaN(currentReading) || currentReading < 0) {
                showNotification('Please enter a valid meter reading to continue.', 'error');
                return;
            }

            if (currentReading < (tenant.currentWaterMeterReading || 0)) {
                showNotification('The new reading cannot be less than the previous one.', 'error');
                return;
            }

            // Create water meter reading record
            const waterReading = {
                // id will be assigned by Firestore
                tenantId: tenant.id,
                tenantName: tenant.name,
                propertyId: tenant.propertyId,
                houseNumber: tenant.houseNumber,
                waterMeterNumber: tenant.waterMeterNumber,
                readingValue: currentReading,
                readingDate: new Date(readingDate).toISOString(),
                previousReading: tenant.currentWaterMeterReading,
                unitsUsed: currentReading - (tenant.currentWaterMeterReading || 0),
                waterCost: (currentReading - (tenant.currentWaterMeterReading || 0)) * WATER_PRICE_PER_UNIT,
                createdAt: new Date().toISOString()
            };

            saveData('waterMeterReadings', waterReading).then(savedReading => {
                if (savedReading) waterMeterReadings.push(savedReading);
            });

            // Generate bill with water and garbage costs
            const waterCost = (currentReading - (tenant.currentWaterMeterReading || 0)) * WATER_PRICE_PER_UNIT;
            const garbageCost = tenant.includeGarbageCollection ? GARBAGE_COLLECTION_FEE : 0;
            const totalBillAmount = tenant.amountCharged + waterCost + garbageCost;

            // Update tenant's current reading and balance
            const newBalance = tenant.outstandingBalance + totalBillAmount;
            updateData('tenants', tenant.id, {
                currentWaterMeterReading: currentReading,
                lastWaterMeterReadingDate: new Date(readingDate).toISOString(),
                outstandingBalance: newBalance,
                lastBilledDate: new Date().toISOString()
            }).then(() => {
                const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                if (tenantIndex !== -1) {
                    tenants[tenantIndex].currentWaterMeterReading = currentReading;
                    tenants[tenantIndex].outstandingBalance = newBalance;
                }
            });

            // Update tenant's outstanding balance
            
            // Add new bill record
            const newBill = {
                id: generateUniqueId(),
                tenantId: tenant.id,
                tenantName: tenant.name,
                propertyId: tenant.propertyId,
                houseNumber: tenant.houseNumber,
                amount: totalBillAmount,
                billingPeriod: currentMonthYear,
                rentAmount: tenant.amountCharged,
                waterAmount: waterCost,
                garbageAmount: garbageCost,
                waterUnitsUsed: currentReading - (tenant.currentWaterMeterReading || 0),
                createdAt: new Date().toISOString()
            };

            saveData('bills', newBill).then(savedBill => {
                if (savedBill) bills.push(savedBill);
                updateGeneratedBillsList();
            });
            
            showNotification(`Bill generated for ${tenant.name}: Ksh ${totalBillAmount.toFixed(2)}`, 'success');
            callback(); // Proceed to next tenant or finish
        }

        function updateGeneratedBillsList() {
            const billsHistoryListDiv = document.getElementById('billsHistoryList');
            if (!billsHistoryListDiv) return;

            let filteredBills = bills;
            if (billingHistoryFilterMonth) {
                filteredBills = bills.filter(bill => bill.billingPeriod === billingHistoryFilterMonth);
            }

            // Sort bills by creation date (newest first)
            filteredBills.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (filteredBills.length === 0) {
                billsHistoryListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No bills found for the selected period.</p>`;
                return;
            }

            billsHistoryListDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Billed</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated On</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredBills.map(bill => {
                                const property = properties.find(p => p.id === bill.propertyId)?.name || 'N/A';
                                // Handle Firestore Timestamp object
                                const billCreatedAt = bill.createdAt?.toDate ? bill.createdAt.toDate() : new Date(bill.createdAt);
                                const generatedDate = !isNaN(billCreatedAt) ? billCreatedAt.toLocaleDateString('en-KE') : 'Invalid Date';
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.tenantName}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.houseNumber}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${bill.amount.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.billingPeriod}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${generatedDate}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm">
                                            <div class="flex space-x-2">
                                                <button data-bill-id="${bill.id}" class="generate-pdf-btn text-blue-600 hover:text-blue-800 transition duration-200" title="Generate PDF">
                                                    ${icons.FileText}
                                                </button>
                                                <button data-bill-id="${bill.id}" class="delete-bill-btn text-red-600 hover:text-red-800 transition duration-200" title="Delete Bill">
                                                    ${icons.Trash2}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            billsHistoryListDiv.querySelectorAll('.delete-bill-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.billId;
                    handleDeleteBill(billId);
                });
            });

            billsHistoryListDiv.querySelectorAll('.generate-pdf-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.billId;
                    const billToGenerate = bills.find(b => b.id === billId);
                    if (billToGenerate) {
                        generateReceiptPdf(billToGenerate);
                    }
                });
            });
        }

        // Generate PDF for a single receipt
        async function generateReceiptPdf(bill) {
            // If bill.createdAt is an object (from Firestore server timestamp), convert it to a Date.
            const billCreatedAt = bill.createdAt?.toDate ? bill.createdAt.toDate() : new Date(bill.createdAt);
            if (isNaN(billCreatedAt)) {
                showNotification("Invalid bill creation date. Cannot generate PDF.", "error");
                return;
            }
            const tenant = tenants.find(t => t.id === bill.tenantId);
            const property = properties.find(p => p.id === bill.propertyId);

            if (!tenant || !property) {
                showNotification("Tenant or Property info is missing for this bill.", "error");
                return;
            }

            const receiptDate = billCreatedAt.toLocaleDateString('en-KE', { year: 'numeric', month: 'long', day: 'numeric' });
            const billingPeriodFormatted = new Date(bill.billingPeriod).toLocaleDateString('en-KE', { year: 'numeric', month: 'long' });
            const outstandingBalance = tenant.outstandingBalance.toFixed(2);

            const receiptContent = `
                <div style="font-family: 'Inter', sans-serif; width: 700px; margin: 0 auto; background: #ffffff; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border-radius: 10px;">
                    
                    <!-- Header Section -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 800; color: #111827; margin: 0;">PA PROPERTY</h1>
                            <p style="font-size: 14px; color: #6b7280; margin: 0;">Nairobi, Kenya</p>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="font-size: 24px; font-weight: 700; color: #4f46e5; margin: 0;">INVOICE</h2>
                            <p style="font-size: 14px; color: #6b7280; margin: 0;">#${bill.id.substring(0, 8).toUpperCase()}</p>
                        </div>
                    </div>

                    <!-- Billed To and Dates -->
                    <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                        <div>
                            <p style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Billed To</p>
                            <p style="font-size: 16px; color: #111827; font-weight: 700; margin: 0;">${tenant.name}</p>
                            <p style="font-size: 14px; color: #4b5563; margin: 0;">${property.name}, House ${tenant.houseNumber}</p>
                            <p style="font-size: 14px; color: #4b5563; margin: 0;">${tenant.phoneNumber}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">Invoice Date</p>
                            <p style="font-size: 14px; color: #111827; font-weight: 600; margin: 0;">${receiptDate}</p>
                            <p style="font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: 600; margin-top: 12px; margin-bottom: 4px;">Billing Period</p>
                            <p style="font-size: 14px; color: #111827; font-weight: 600; margin: 0;">${billingPeriodFormatted}</p>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div style="margin-top: 40px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background-color: #f3f4f6; border-radius: 8px;">
                                <tr>
                                    <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: #4b5563; font-weight: 600; text-transform: uppercase;">Item</th>
                                    <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: #4b5563; font-weight: 600; text-transform: uppercase;">Description</th>
                                    <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: #4b5563; font-weight: 600; text-transform: uppercase;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 16px; font-size: 14px; color: #111827; font-weight: 600;">Base Rent</td>
                                    <td style="padding: 16px; font-size: 14px; color: #4b5563;">Monthly rent for ${billingPeriodFormatted}</td>
                                    <td style="padding: 16px; text-align: right; font-size: 14px; color: #111827; font-weight: 600;">${formatCurrency(bill.rentAmount || tenant.amountCharged)}</td>
                                </tr>
                                ${bill.waterAmount ? `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 16px; font-size: 14px; color: #111827; font-weight: 600;">Water Bill</td>
                                    <td style="padding: 16px; font-size: 14px; color: #4b5563;">${bill.waterUnitsUsed || 0} units @ ${formatCurrency(WATER_PRICE_PER_UNIT)}/unit</td>
                                    <td style="padding: 16px; text-align: right; font-size: 14px; color: #111827; font-weight: 600;">${formatCurrency(bill.waterAmount)}</td>
                                </tr>
                                ` : ''}
                                ${bill.garbageAmount ? `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 16px; font-size: 14px; color: #111827; font-weight: 600;">Garbage Collection</td>
                                    <td style="padding: 16px; font-size: 14px; color: #4b5563;">Monthly service fee</td>
                                    <td style="padding: 16px; text-align: right; font-size: 14px; color: #111827; font-weight: 600;">${formatCurrency(bill.garbageAmount)}</td>
                                </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals Section -->
                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <div style="width: 50%;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tbody>
                                    <tr style="border-top: 2px solid #e5e7eb;">
                                        <td style="padding: 12px 0; font-size: 14px; color: #4b5563; font-weight: 600;">Invoice Total</td>
                                        <td style="padding: 12px 0; text-align: right; font-size: 16px; color: #111827; font-weight: 700;">${formatCurrency(bill.amount)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 12px 0; font-size: 14px; color: #4b5563; font-weight: 600;">Total Outstanding Balance</td>
                                        <td style="padding: 12px 0; text-align: right; font-size: 16px; color: ${outstandingBalance > 0 ? '#dc2626' : '#16a34a'}; font-weight: 700;">${formatCurrency(outstandingBalance)}</td>
                                    </tr>
                                    <tr style="background-color: #4f46e5; color: white; border-radius: 8px;">
                                        <td style="padding: 16px; font-size: 16px; font-weight: 700; border-radius: 8px 0 0 8px;">Amount Due</td>
                                        <td style="padding: 16px; text-align: right; font-size: 22px; font-weight: 800; border-radius: 0 8px 8px 0;">${formatCurrency(outstandingBalance)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="text-align: center; margin-top: 50px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                        <p style="font-size: 14px; color: #4b5563; margin: 0;">Thank you for your prompt payment!</p>
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Generated on ${new Date().toLocaleString('en-KE')}</p>
                    </div>
                </div>
            `;

            // Create a temporary div to render the HTML content for html2canvas
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.width = '700px';
            tempDiv.innerHTML = receiptContent;
            document.body.appendChild(tempDiv);

            try {
                const canvas = await html2canvas(tempDiv, { scale: 2 }); // Scale for better quality
                const imgData = canvas.toDataURL('image/png');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`rent-receipt-${tenant.name.replace(/\s/g, '-')}-${tenant.houseNumber}.pdf`);
                showNotification(`Invoice for ${tenant.name} downloaded successfully.`, 'success');
            } catch (err) {
                console.error("Error generating PDF:", err);                
                showNotification(`Failed to generate PDF for ${tenant.name}.`, 'error');
            } finally {
                document.body.removeChild(tempDiv); // Clean up temporary div
            }
        }


        // Delete Bill Handler
        function handleDeleteBill(billId) {
            const billToDelete = bills.find(b => b.id === billId);
            if (!billToDelete) {
                showNotification("Could not find the bill to delete.", "error");
                return;
            }

            showModal("Confirm Deletion", `Are you sure you want to delete this bill for '${billToDelete.tenantName}' for the period '${billToDelete.billingPeriod}'? This action will also adjust their outstanding balance.`, 'confirm', () => {
                try {
                    deleteData('bills', billId);
                    bills = bills.filter(b => b.id !== billId);

                    // Adjust tenant's balance
                    const tenantToUpdate = tenants.find(t => t.id === billToDelete.tenantId);
                    if (tenantToUpdate) {
                        const newBalance = tenantToUpdate.outstandingBalance - billToDelete.amount;
                        updateData('tenants', tenantToUpdate.id, { outstandingBalance: newBalance }).then(() => {
                            tenantToUpdate.outstandingBalance = newBalance;
                        });
                    }

                    showModal("Success", "Bill deleted and tenant balance adjusted successfully.");
                    if (activeTab === 'tenants') renderAllTenantsList();
                    updatePropertiesList(); // Re-render properties section to update balance display
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting bill: ", e);
                    showNotification("Failed to delete the bill. Please try again.", "error");
                }
            });
        }

        // Render Financial Section
        function renderFinancialSection(parentEl) {
            // Recalculate totals every time this function runs
            const totalRentExpected = tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0);
            const totalBilled = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalOutstandingBalance = totalBilled - totalPaid;

            parentEl.innerHTML = `
                <section class="bg-white/50 dark:bg-gray-900/40 backdrop-blur-lg border border-white/20 dark:border-gray-700/50 rounded-2xl shadow-lg p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Financial Overview</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        ${renderStatCard(icons.DollarSign, "Total Rent Expected (Monthly)", `Ksh ${totalRentExpected.toFixed(2)}`)}
                        ${renderStatCard(icons.FileText, "Total Billed Amount", `Ksh ${totalBilled.toFixed(2)}`)}
                        ${renderStatCard(icons.Wallet, "Total Paid Amount", `Ksh ${totalPaid.toFixed(2)}`)}
                        ${renderStatCard(icons.DollarSign, "Total Outstanding Balance", `Ksh ${totalOutstandingBalance.toFixed(2)}`)}
                    </div>

                    <div class="mt-8 border-t border-gray-200/50 dark:border-gray-700/50 pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Payment History</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mb-4">
                            <select id="financePropertyFilter" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Filter by Property</option>
                                ${properties.map(p => `<option value="${p.id}" ${selectedPropertyForFinanceFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="paymentHistoryList" class="space-y-4">
                            <!-- Payment list will be rendered here -->
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('financePropertyFilter').addEventListener('change', (e) => {
                selectedPropertyForFinanceFilter = e.target.value;
                updatePaymentHistoryList();
            });

            updatePaymentHistoryList();
        }

        function updatePaymentHistoryList() {
            const paymentHistoryListDiv = document.getElementById('paymentHistoryList');
            if (!paymentHistoryListDiv) return;

            let filteredPayments = payments;
            if (selectedPropertyForFinanceFilter) {
                filteredPayments = payments.filter(payment => payment.propertyId === selectedPropertyForFinanceFilter);
            }

            // Sort payments by payment date (newest first)
            filteredPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            if (filteredPayments.length === 0) {
                paymentHistoryListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No payments found for the selected property.</p>`;
                return;
            }

            paymentHistoryListDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 dark:bg-gray-800/50">
                            <tr>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Tenant</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Property</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Amount Paid</th>
                                <th class="py-4 px-6 text-left text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wider">Payment Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            ${filteredPayments.map(payment => {
                                const property = properties.find(p => p.id === payment.propertyId)?.name || 'N/A';
                                const paymentDate = new Date(payment.paymentDate).toLocaleDateString();
                                return `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200">
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${payment.tenantName}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${property}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-gray-200">${formatCurrency(payment.amount)}</td>
                                        <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">${paymentDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Chart initialization
        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx) {
                const monthlyData = getMonthlyRevenueData();
                charts.revenue = createChart('revenueChart', {
                    type: 'line',
                    data: {
                        labels: monthlyData.labels,
                        datasets: [{
                            label: 'Revenue', 
                            data: monthlyData.data, 
                            borderColor: 'rgb(79, 70, 229)', // indigo-600
                            backgroundColor: 'rgba(79, 70, 229, 0.1)', // indigo-600
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Property Distribution Chart
            const propertyCtx = document.getElementById('propertyChart');
            if (propertyCtx) {
                const propertyData = getPropertyDistributionData();
                charts.property = createChart('propertyChart', {
                    type: 'doughnut',
                    data: {
                        labels: propertyData.labels,
                        datasets: [{
                            data: propertyData.data, 
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(79, 172, 254, 0.8)',
                                'rgba(67, 233, 123, 0.8)',
                                'rgba(240, 147, 251, 0.8)',
                                'rgba(255, 193, 7, 0.8)'
                            ],
                            borderWidth: 0 
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function getMonthlyRevenueData() {
            const last6Months = [];
            const revenueData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthYear = date.toISOString().substring(0, 7);
                
                last6Months.push(date.toLocaleDateString('en-KE', { month: 'short', year: 'numeric' }));
                
                const monthlyRevenue = payments
                    .filter(payment => payment.paymentDate.startsWith(monthYear))
                    .reduce((sum, payment) => sum + payment.amount, 0);
                
                revenueData.push(monthlyRevenue);
            }
            
            return {
                labels: last6Months,
                data: revenueData
            };
        }

        function getPropertyDistributionData() {
            const propertyTenantCounts = {};
            
            tenants.forEach(tenant => {
                const property = properties.find(p => p.id === tenant.propertyId);
                if (property) {
                    propertyTenantCounts[property.name] = (propertyTenantCounts[property.name] || 0) + 1;
                }
            });
            
            return {
                labels: Object.keys(propertyTenantCounts),
                data: Object.values(propertyTenantCounts)
            };
        }

        // --- Main Execution ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();            
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        });
    </script>
</body>
</html>
 
