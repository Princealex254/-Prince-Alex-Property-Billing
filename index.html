<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Property Billing System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">\
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 48rem; /* Increased max-width for better layout */
            transform: scale(1);
            opacity: 1;
            transition: all 0.3s ease-out;
            overflow: hidden; /* Ensure content inside doesn't overflow rounded corners */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-body {
            padding: 1rem;
        }
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .loading-spinner {
            border-top-color: #3b82f6; /* Blue-500 */
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-inter antialiased bg-gray-50 min-h-screen">
    <div id="app">
        <!-- Content will be dynamically loaded here by JavaScript -->
        <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="text-center">
                <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-lg text-gray-700">Loading application...</p>
            </div>
        </div>
    </div>

    <!-- Libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="module">
        // Lucide Icons (as SVG strings for direct embedding)
        const icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            Users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            Building: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9.5 16h5"/><path d="M9.5 12h5"/><path d="M9.5 8h5"/><path d="M12 22V2"/></svg>`,
            Receipt: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2h-2.5a2 2 0 0 1-2-2H6.5a2 2 0 0 1-2 2H4Z"/><path d="M18 6H8"/><path d="M18 10H8"/><path d="M18 14H8"/><path d="M18 18H8"/></svg>`,
            PlusCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
            Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            LogOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            HomeIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`, // Reusing Home for HomeIcon
            Wallet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h12a2 2 0 0 0 2-2v-3"/><path d="M22 7V4a1 1 0 0 0-1-1H3a2 2 0 0 0 0 4h18a1 1 0 0 0 1-1Z"/></svg>`,
            Search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            DollarSign: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            Menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`
        };


        // Global State
        let user = { displayName: "Admin" };
        // User ID is no longer relevant for local storage, but kept for display consistency
        let userId = "local-user-for-testing";
        let currentPage = 'dashboard';
        let properties = [];
        let tenants = [];
        let bills = [];
        let payments = []; // New array for payment records
        let activeTab = 'summary'; // 'summary', 'properties', 'billing', 'finance'
        let billingTenantSearchQuery = ''; // New state for tenant search in billing tab
        let selectedPropertyForBillingFilter = ''; // New state for billing property filter
        let billingHistoryFilterMonth = new Date().toISOString().substring(0, 7); // YYYY-MM format, default to current month
        let selectedPropertyForFinanceFilter = ''; // New state for finance property filter
        let isSidebarOpen = false; // New state for sidebar visibility on mobile
        let propertyTenantSearchQueries = {}; // New state to store search queries per property

        const houseTypes = ['Apartment', 'Bungalow', 'Mansionette', 'Commercial Space', 'Shop'];
        const WATER_PRICE_PER_UNIT = 50; // Example: Ksh 50 per water unit

        // --- Local Storage Functions ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function saveToLocalStorage() {
            localStorage.setItem('properties', JSON.stringify(properties));
            localStorage.setItem('tenants', JSON.stringify(tenants));
            localStorage.setItem('bills', JSON.stringify(bills));
            localStorage.setItem('payments', JSON.stringify(payments));
        }

        function loadFromLocalStorage() {
            try {
                properties = JSON.parse(localStorage.getItem('properties')) || [];
                tenants = JSON.parse(localStorage.getItem('tenants')) || [];
                bills = JSON.parse(localStorage.getItem('bills')) || [];
                payments = JSON.parse(localStorage.getItem('payments')) || [];
            } catch (e) {
                console.error("Error loading from local storage:", e);
                // Clear corrupted data if parsing fails
                properties = [];
                tenants = [];
                bills = [];
                payments = [];
                saveToLocalStorage(); // Save empty arrays to clear corrupted data
                showModal("Data Error", "Corrupted local storage data detected and cleared. Please try adding data again.");
            }
        }

        // Custom Modal Functions (replaces alert and confirm)
        function showModal(title, content, type = 'alert', onConfirm = null) {
            const appDiv = document.getElementById('app');
            let modalOverlay = document.querySelector('.modal-overlay');

            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                appDiv.appendChild(modalOverlay);
            }

            // Ensure content is a DOM element if it's not a string
            const contentElement = typeof content === 'string' ? `<p class="text-gray-700">${content}</p>` : content.outerHTML || '';

            modalOverlay.innerHTML = `
                <div class="modal-content max-w-xl">
                    <div class="modal-header">
                        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                        <button class="text-gray-500 hover:text-gray-700 transition duration-200 modal-close-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body p-4">
                        ${contentElement}
                    </div>
                    <div class="modal-footer">
                        ${type === 'confirm' ? `
                            <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 modal-cancel-btn">
                                Cancel
                            </button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 modal-confirm-btn">
                                Confirm
                            </button>
                        ` : `
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 modal-close-btn">
                                OK
                            </button>
                        `}
                    </div>
                </div>
            `;
            modalOverlay.style.display = 'flex'; // Ensure it's visible

            // If content was a DOM element, re-append it so event listeners work
            if (typeof content !== 'string') {
                const modalBody = modalOverlay.querySelector('.modal-body');
                modalBody.innerHTML = ''; // Clear the innerHTML from the template
                modalBody.appendChild(content); // Append the actual DOM element
            }


            const closeModal = () => {
                modalOverlay.style.display = 'none';
                modalOverlay.innerHTML = ''; // Clear content
            };

            modalOverlay.querySelector('.modal-close-btn').addEventListener('click', closeModal);

            if (type === 'confirm') {
                modalOverlay.querySelector('.modal-cancel-btn').addEventListener('click', closeModal);
                modalOverlay.querySelector('.modal-confirm-btn').addEventListener('click', () => {
                    if (onConfirm) onConfirm();
                    closeModal();
                });
            }
        }


        // Initialize Application Data (from local storage)
        function initializeAppData() {
            loadFromLocalStorage();
            currentPage = 'dashboard';
            renderDashboardPage();
        }

        // Render Functions
        function renderApp() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Clear existing content
            renderDashboardPage();
        }

        function renderDashboardPage() {
            const appDiv = document.getElementById('app');
            const userName = user?.displayName || "User";
            const totalProperties = properties.length;
            const totalTenants = tenants.length;
            const billsGenerated = bills.length;

            appDiv.innerHTML = `
                <div class="flex h-screen bg-gray-100">
                    <!-- Sidebar Navigation -->
                    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 text-white flex flex-col p-4 shadow-lg transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out">
                        <div class="flex items-center mb-8">
                            <img src="https://placehold.co/40x40/4F46E5/FFFFFF?text=P" alt="Logo" class="rounded-full mr-3" />
                            <h1 class="text-2xl font-bold">Prince Alex</h1>
                        </div>
                        <nav class="flex-grow">
                            <ul>
                                <li class="mb-2">
                                    <button id="navSummary"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'summary' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Home} <span class="ml-3">Dashboard Overview</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navProperties"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'properties' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Building} <span class="ml-3">Your Properties</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navBilling"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'billing' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Receipt} <span class="ml-3">Billing & Receipts</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navFinance"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'finance' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.DollarSign} <span class="ml-3">Financial Overview</span>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div class="mt-auto">
                            <!-- Removed logout button as authentication is bypassed for testing -->
                            <p class="text-xs text-gray-400 mt-4 break-all">User ID: ${userId || 'N/A'}</p>
                        </div>
                    </aside>

                    <!-- Main Content Area -->
                    <main class="flex-1 overflow-auto p-8 ${isSidebarOpen ? 'lg:ml-64' : 'lg:ml-0'} transition-all duration-300 ease-in-out">
                        <!-- Header -->
                        <header class="bg-white rounded-xl shadow-md p-6 mb-8 flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-800">Welcome, ${userName}!</h2>
                            <button id="menuToggleBtn" class="p-2 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                ${isSidebarOpen ? icons.X : icons.Menu}
                            </button>
                            <div class="hidden lg:flex space-x-4">
                                <div class="flex items-center text-gray-600">
                                    ${icons.Calendar}
                                    <span class="ml-2">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                            </div>
                        </header>

                        <!-- Content Section based on activeTab -->
                        <div id="contentSection"></div>
                    </main>
                </div>
            `;

            // Add event listeners for navigation
            document.getElementById('navSummary').addEventListener('click', () => { activeTab = 'summary'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navProperties').addEventListener('click', () => { activeTab = 'properties'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navBilling').addEventListener('click', () => { activeTab = 'billing'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navFinance').addEventListener('click', () => { activeTab = 'finance'; isSidebarOpen = false; renderDashboardPage(); });
            // Removed logout button event listener
            // document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Add event listener for the new hamburger menu button
            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                renderDashboardPage(); // Re-render to apply sidebar class change
            });


            // Render content based on active tab
            const contentSection = document.getElementById('contentSection');
            if (contentSection) { // Ensure contentSection exists before rendering into it
                if (activeTab === 'summary') {
                    contentSection.innerHTML = renderSummarySection(totalProperties, totalTenants, billsGenerated);
                } else if (activeTab === 'properties') {
                    renderPropertiesSection(contentSection);
                } else if (activeTab === 'billing') {
                    renderBillingSection(contentSection);
                } else if (activeTab === 'finance') {
                    renderFinancialSection(contentSection);
                }
            }
        }

        function renderSummarySection(totalProperties, totalUnits, billsGenerated) {
            return `
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${renderStatCard(icons.Building, "Total Properties", totalProperties)}
                    ${renderStatCard(icons.HomeIcon, "Total Units", totalUnits)}
                    ${renderStatCard(icons.Users, "Total Tenants", tenants.length)}
                    ${renderStatCard(icons.Receipt, "Bills Generated", billsGenerated)}
                </section>
            `;
        }

        function renderStatCard(icon, title, value) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                    <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                        ${icon}
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm font-medium">${title}</p>
                        <h3 class="text-2xl font-bold text-gray-900">${value}</h3>
                    </div>
                </div>
            `;
        }

        function renderPropertiesSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Your Properties</h3>
                        <button id="addPropertyBtn"
                            class="bg-blue-600 text-white px-5 py-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-200 shadow-md">
                            ${icons.PlusCircle} <span class="ml-2">Add Property</span>
                        </button>
                    </div>

                    <div id="propertiesList" class="space-y-6">
                        ${properties.length === 0 ? `
                            <p class="text-gray-600 text-center py-8">No properties added yet. Click "Add Property" to get started!</p>
                        ` : ''}
                    </div>
                </section>
            `;

            document.getElementById('addPropertyBtn').addEventListener('click', () => showAddPropertyModal());
            updatePropertiesList();
        }

        function updatePropertiesList() {
            const propertiesListDiv = document.getElementById('propertiesList');
            if (!propertiesListDiv) return;

            if (properties.length === 0) {
                propertiesListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No properties added yet. Click "Add Property" to get started!</p>`;
                return;
            }

            propertiesListDiv.innerHTML = properties.map(property => {
                const currentPropertySearchQuery = propertyTenantSearchQueries[property.id]?.toLowerCase() || '';
                const tenantsForProperty = tenants.filter(t => t.propertyId === property.id && (currentPropertySearchQuery === '' || t.name.toLowerCase().includes(currentPropertySearchQuery) || t.houseNumber.toLowerCase().includes(currentPropertySearchQuery))
                );

                return `
                    <div class="border border-gray-200 rounded-lg p-5 bg-gray-50 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-semibold text-gray-700">${property.name}</h4>
                            <div class="flex space-x-2">
                                <button data-property-id="${property.id}" class="add-tenant-btn bg-green-500 text-white px-4 py-2 rounded-lg text-sm flex items-center hover:bg-green-600 transition duration-200">
                                    ${icons.PlusCircle} <span class="ml-1">Add Tenant</span>
                                </button>
                                <button data-property-id="${property.id}" class="delete-property-btn bg-red-500 text-white px-4 py-2 rounded-lg text-sm flex items-center hover:bg-red-600 transition duration-200">
                                    ${icons.Trash2} <span class="ml-1">Delete Property</span>
                                </button>
                            </div>
                        </div>

                        <div class="relative mb-4">
                            <input type="text" id="tenantSearchInput-${property.id}" data-property-id="${property.id}" placeholder="Search tenants by name or house number in ${property.name}..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${currentPropertySearchQuery}">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                ${icons.Search}
                            </div>
                        </div>
                        <p class="text-gray-600 mb-3">Tenants in ${property.name}:</p>
                        ${tenantsForProperty.length === 0 ? `
                            <p class="text-gray-500 text-sm italic ml-4">No tenants added for this property yet or no matching tenants found.</p>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white rounded-lg shadow-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Name</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${tenantsForProperty.map(tenant => {
                                            const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600 font-semibold' : 'text-green-600';
                                            const balanceText = tenant.outstandingBalance > 0 ? `Ksh ${tenant.outstandingBalance.toFixed(2)} Due` : 'Paid';
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.name}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.houseNumber}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.houseType}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${tenant.amountCharged.toFixed(2)}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm ${balanceColor}">${balanceText}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.phoneNumber}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm">
                                                        <div class="flex space-x-2">
                                                            <button data-tenant-id="${tenant.id}" class="payment-btn text-purple-600 hover:text-purple-800 transition duration-200" title="Record Payment">
                                                                ${icons.Wallet}
                                                            </button>
                                                            <button data-tenant-id="${tenant.id}" class="edit-tenant-btn text-blue-600 hover:text-blue-800 transition duration-200" title="Edit Tenant">
                                                                ${icons.Edit}
                                                            </button>
                                                            <button data-tenant-id="${tenant.id}" class="delete-tenant-btn text-red-600 hover:text-red-800 transition duration-200" title="Delete Tenant">
                                                                ${icons.Trash2}
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
            // Attach event listeners after rendering
            propertiesListDiv.querySelectorAll('.add-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.propertyId;
                    const selectedProperty = properties.find(p => p.id === propertyId);
                    if (selectedProperty) showAddEditTenantModal(selectedProperty);
                });
            });

            propertiesListDiv.querySelectorAll('.delete-property-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.propertyId;
                    handleDeleteProperty(propertyId);
                });
            });

            propertiesListDiv.querySelectorAll('.edit-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    const tenantToEdit = tenants.find(t => t.id === tenantId);
                    if (tenantToEdit) showAddEditTenantModal(properties.find(p => p.id === tenantToEdit.propertyId), tenantToEdit);
                });
            });

            propertiesListDiv.querySelectorAll('.delete-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    handleDeleteTenant(tenantId);
                });
            });

            propertiesListDiv.querySelectorAll('.payment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    const tenant = tenants.find(t => t.id === tenantId);
                    if (tenant) showPaymentModal(tenant);
                });
            });
            // Attach event listeners for per-property search inputs
            propertiesListDiv.querySelectorAll('input[id^="tenantSearchInput-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const propertyId = e.target.dataset.propertyId;
                    propertyTenantSearchQueries[propertyId] = e.target.value;
                    updatePropertiesList(); // Re-render the list for the specific property
                });
            });

        }

        // Add Property Modal
        function showAddPropertyModal(propertyToEdit = null) {
            const isEditing = !!propertyToEdit;
            const title = isEditing ? 'Edit Property' : 'Add New Property';
            const buttonText = isEditing ? 'Save Changes' : 'Add Property';

            const formContent = `
                <form id="addEditPropertyForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="propertyName">Property Name</label>
                        <input type="text" id="propertyName" name="propertyName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${propertyToEdit ? propertyToEdit.name : ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="propertyLocation">Location</label>
                        <input type="text" id="propertyLocation" name="propertyLocation" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${propertyToEdit ? propertyToEdit.location : ''}" required>
                    </div>
                </form>
            `;

            showModal(title, formContent, 'confirm', () => {
                const form = document.getElementById('addEditPropertyForm');
                const newPropertyData = {
                    id: isEditing ? propertyToEdit.id : generateUniqueId(),
                    name: form.elements['propertyName'].value,
                    location: form.elements['propertyLocation'].value,
                    createdAt: new Date().toISOString()
                };

                try {
                    if (isEditing) {
                        const index = properties.findIndex(p => p.id === propertyToEdit.id);
                        if (index !== -1) {
                            properties[index] = newPropertyData;
                        }
                        showModal("Success", "Property updated successfully!");
                    } else {
                        properties.push(newPropertyData);
                        showModal("Success", "Property added successfully!");
                    }
                    saveToLocalStorage();
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantDropdown(); // Update dropdowns that depend on properties
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error saving property: ", e);
                    showModal("Error", `Failed to save property: ${e.message}`);
                }
            });
        }

        // Delete Property Handler
        function handleDeleteProperty(propertyId) {
            const propertyToDelete = properties.find(p => p.id === propertyId);
            if (!propertyToDelete) {
                showModal("Error", "Property not found.");
                return;
            }
            showModal("Confirm Deletion", `Are you sure you want to delete the property '${propertyToDelete.name}'? This will also delete all associated tenants and bills.`, 'confirm', () => {
                try {
                    // Filter out the property
                    properties = properties.filter(p => p.id !== propertyId);
                    // Filter out associated tenants
                    tenants = tenants.filter(t => t.propertyId !== propertyId);
                    // Filter out associated bills
                    bills = bills.filter(b => b.propertyId !== propertyId);
                    // Filter out associated payments
                    payments = payments.filter(p => p.propertyId !== propertyId);

                    saveToLocalStorage();
                    showModal("Success", `Property '${propertyToDelete.name}' and all associated data deleted successfully.`);
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantDropdown(); // Update dropdowns
                    updateGeneratedBillsList(); // Update bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting property: ", e);
                    showModal("Error", `Failed to delete property: ${e.message}`);
                }
            });
        }

        // Add/Edit Tenant Modal
        function showAddEditTenantModal(property, tenantToEdit = null) {
            const isEditing = !!tenantToEdit;
            const title = isEditing ? 'Edit Tenant Details' : `Add New Tenant to ${property.name}`;
            const buttonText = isEditing ? 'Save Changes' : 'Add Tenant';

            const formContent = `
                <form id="addEditTenantForm" class="space-y-4">
                    <input type="hidden" id="propertyId" name="propertyId" value="${property.id}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="tenantName">Tenant Name</label>
                        <input type="text" id="tenantName" name="tenantName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${tenantToEdit ? tenantToEdit.name : ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="houseNumber">House/Unit Number</label>
                        <input type="text" id="houseNumber" name="houseNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${tenantToEdit ? tenantToEdit.houseNumber : ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="houseType">House Type</label>
                        <select id="houseType" name="houseType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Select a house type</option>
                            ${houseTypes.map(type => `<option value="${type}" ${tenantToEdit && tenantToEdit.houseType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="amountCharged">Rent Amount (Ksh)</label>
                        <input type="number" id="amountCharged" name="amountCharged" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${tenantToEdit ? tenantToEdit.amountCharged : ''}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${tenantToEdit ? tenantToEdit.phoneNumber : ''}" required>
                    </div>
                </form>
            `;

            showModal(title, formContent, 'confirm', () => {
                const form = document.getElementById('addEditTenantForm');
                const tenantData = {
                    id: isEditing ? tenantToEdit.id : generateUniqueId(),
                    propertyId: property.id,
                    name: form.elements['tenantName'].value,
                    houseNumber: form.elements['houseNumber'].value,
                    houseType: form.elements['houseType'].value,
                    amountCharged: parseFloat(form.elements['amountCharged'].value),
                    phoneNumber: form.elements['phoneNumber'].value,
                    outstandingBalance: isEditing ? tenantToEdit.outstandingBalance : 0, // Preserve balance on edit
                    lastBilledDate: isEditing ? tenantToEdit.lastBilledDate : null, // Preserve last billed date
                    lastPaidDate: isEditing ? tenantToEdit.lastPaidDate : null, // Preserve last paid date
                    createdAt: isEditing ? tenantToEdit.createdAt : new Date().toISOString()
                };

                try {
                    if (isEditing) {
                        const index = tenants.findIndex(t => t.id === tenantToEdit.id);
                        if (index !== -1) {
                            tenants[index] = tenantData;
                        }
                        showModal("Success", "Tenant details updated successfully!");
                    } else {
                        tenants.push(tenantData);
                        showModal("Success", "New tenant added successfully!");
                    }
                    saveToLocalStorage();
                    updatePropertiesList(); // Re-render properties section (which includes tenants)
                    updateBillingTenantList(); // Re-render billing tenant list
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error saving tenant: ", e);
                    showModal("Error", `Failed to save tenant: ${e.message}`);
                }
            });
        }


        // Delete Tenant Handler
        function handleDeleteTenant(tenantId) {
            const tenantToDelete = tenants.find(t => t.id === tenantId);
            if (!tenantToDelete) {
                showModal("Error", "Tenant not found.");
                return;
            }
            showModal("Confirm Deletion", `Are you sure you want to delete the tenant '${tenantToDelete.name}' from house '${tenantToDelete.houseNumber}'? This action cannot be undone.`, 'confirm', () => {
                try {
                    tenants = tenants.filter(t => t.id !== tenantId);
                    // Also remove associated bills and payments for this tenant
                    bills = bills.filter(b => b.tenantId !== tenantId);
                    payments = payments.filter(p => p.tenantId !== tenantId);

                    saveToLocalStorage();
                    showModal("Success", "Tenant deleted successfully!");
                    updatePropertiesList(); // Re-render properties section
                    updateBillingTenantList(); // Re-render billing tenant list
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting tenant: ", e);
                    showModal("Error", `Failed to delete tenant: ${e.message}`);
                }
            });
        }


        // Payment Modal
        function showPaymentModal(tenant) {
            const formContent = `
                <form id="paymentForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tenant Name</label>
                        <p class="mt-1 text-lg font-semibold text-gray-900">${tenant.name}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Outstanding Balance</label>
                        <p class="mt-1 text-lg font-semibold text-red-600">Ksh ${tenant.outstandingBalance.toFixed(2)}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="paymentAmount">Payment Amount (Ksh)</label>
                        <input type="number" id="paymentAmount" name="paymentAmount" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" step="0.01" min="0" value="${tenant.outstandingBalance.toFixed(2)}" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="paymentDate">Date of Payment</label>
                        <input type="date" id="paymentDate" name="paymentDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${new Date().toISOString().substring(0, 10)}" required>
                    </div>
                </form>
            `;

            showModal("Record Payment", formContent, 'confirm', () => {
                const form = document.getElementById('paymentForm');
                const paymentAmount = parseFloat(form.elements['paymentAmount'].value);
                const paymentDate = form.elements['paymentDate'].value;

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showModal("Error", "Please enter a valid payment amount.");
                    return;
                }

                try {
                    const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                    if (tenantIndex !== -1) {
                        tenants[tenantIndex].outstandingBalance -= paymentAmount;
                        tenants[tenantIndex].lastPaidDate = new Date(paymentDate).toISOString();
                    }

                    // Add a new payment record
                    const paymentRecord = {
                        id: generateUniqueId(),
                        tenantId: tenant.id,
                        tenantName: tenant.name,
                        propertyId: tenant.propertyId,
                        houseNumber: tenant.houseNumber,
                        amount: paymentAmount,
                        paymentDate: new Date(paymentDate).toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    payments.push(paymentRecord);

                    saveToLocalStorage();
                    showModal("Success", `Payment of Ksh ${paymentAmount.toFixed(2)} recorded successfully! New balance is Ksh ${tenants[tenantIndex].outstandingBalance.toFixed(2)}.`);
                    updatePropertiesList(); // Re-render properties section to update balance display
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error recording payment: ", e);
                    showModal("Error", `Failed to record payment: ${e.message}`);
                }
            });
        }


        // Render Billing Section
        function renderBillingSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Generate Bills</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                            <div class="relative w-full md:w-auto">
                                <input type="text" id="billingTenantSearch" placeholder="Search tenants..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${billingTenantSearchQuery}">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    ${icons.Search}
                                </div>
                            </div>
                            <select id="billingPropertyFilter" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Filter by Property</option>
                                ${properties.map(p => `<option value="${p.id}" ${selectedPropertyForBillingFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <button id="generateBillsBtn"
                                class="bg-blue-600 text-white px-5 py-2 rounded-lg flex items-center justify-center hover:bg-blue-700 transition duration-200 shadow-md">
                                ${icons.PlusCircle} <span class="ml-2">Generate Bills</span>
                            </button>
                        </div>
                    </div>
                    <div id="tenantsToBillList" class="space-y-4">
                        <!-- Tenant list will be rendered here -->
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Bills History</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mb-4">
                            <input type="month" id="billingHistoryMonthFilter" value="${billingHistoryFilterMonth}" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button id="showAllBillsBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200">Show All Bills</button>
                        </div>
                        <div id="billsHistoryList" class="space-y-4">
                            <!-- Bills history will be rendered here -->
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('billingTenantSearch').addEventListener('input', (e) => {
                billingTenantSearchQuery = e.target.value;
                updateBillingTenantList();
            });

            document.getElementById('billingPropertyFilter').addEventListener('change', (e) => {
                selectedPropertyForBillingFilter = e.target.value;
                updateBillingTenantList();
            });

            document.getElementById('generateBillsBtn').addEventListener('click', handleGenerateBills);
            document.getElementById('billingHistoryMonthFilter').addEventListener('change', (e) => {
                billingHistoryFilterMonth = e.target.value;
                updateGeneratedBillsList();
            });
            document.getElementById('showAllBillsBtn').addEventListener('click', () => {
                billingHistoryFilterMonth = '';
                document.getElementById('billingHistoryMonthFilter').value = '';
                updateGeneratedBillsList();
            });

            updateBillingTenantList();
            updateGeneratedBillsList();
        }

        function updateBillingTenantList() {
            const tenantsToBillListDiv = document.getElementById('tenantsToBillList');
            if (!tenantsToBillListDiv) return;

            const filteredTenants = tenants.filter(tenant => {
                const matchesSearch = tenant.name.toLowerCase().includes(billingTenantSearchQuery.toLowerCase()) || tenant.houseNumber.toLowerCase().includes(billingTenantSearchQuery.toLowerCase());
                const matchesProperty = selectedPropertyForBillingFilter === '' || tenant.propertyId === selectedPropertyForBillingFilter;
                return matchesSearch && matchesProperty;
            });

            if (filteredTenants.length === 0) {
                tenantsToBillListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No matching tenants found to bill.</p>`;
                return;
            }

            tenantsToBillListDiv.innerHTML = `
                <p class="text-gray-600">Select tenants to generate a bill for the current month:</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">
                                    <input type="checkbox" id="selectAllTenants" class="form-checkbox h-4 w-4 text-blue-600">
                                </th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Last Billed</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredTenants.map(tenant => {
                                const lastBilledDate = tenant.lastBilledDate ? new Date(tenant.lastBilledDate).toLocaleDateString() : 'Never';
                                const property = properties.find(p => p.id === tenant.propertyId)?.name || 'N/A';
                                const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600' : 'text-green-600';
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm">
                                            <input type="checkbox" name="tenantToBill" value="${tenant.id}" class="form-checkbox h-4 w-4 text-blue-600">
                                        </td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.name}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.houseNumber}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm font-medium ${balanceColor}">Ksh ${tenant.outstandingBalance.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500">${lastBilledDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Add event listener for "select all" checkbox
            document.getElementById('selectAllTenants').addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('input[name="tenantToBill"]');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
        }

        async function handleGenerateBills() {
            const selectedTenantIds = Array.from(document.querySelectorAll('input[name="tenantToBill"]:checked')).map(cb => cb.value);

            if (selectedTenantIds.length === 0) {
                showModal("Error", "Please select at least one tenant to bill.");
                return;
            }

            const currentMonthYear = new Date().toISOString().substring(0, 7); // e.g., "2024-05"

            // Check if bills have already been generated for this month
            const alreadyBilledTenants = bills.filter(bill =>
                selectedTenantIds.includes(bill.tenantId) && bill.billingPeriod === currentMonthYear
            ).map(bill => tenants.find(t => t.id === bill.tenantId)?.name || 'Unknown Tenant');

            if (alreadyBilledTenants.length > 0) {
                showModal("Warning", `Bills have already been generated for the current month for the following tenants: ${alreadyBilledTenants.join(', ')}. Please unselect them to avoid double billing.`);
                return;
            }

            // Show a confirmation modal before generating bills
            showModal("Confirm Bill Generation", `Are you sure you want to generate bills for the current month for ${selectedTenantIds.length} selected tenant(s)?`, 'confirm', () => {
                try {
                    const tenantsToBill = tenants.filter(t => selectedTenantIds.includes(t.id));

                    for (const tenant of tenantsToBill) {
                        const tenantIndex = tenants.findIndex(t => t.id === tenant.id);
                        if (tenantIndex !== -1) {
                            tenants[tenantIndex].outstandingBalance += tenant.amountCharged;
                            tenants[tenantIndex].lastBilledDate = new Date().toISOString();
                        }

                        // Add new bill record
                        const newBill = {
                            id: generateUniqueId(),
                            tenantId: tenant.id,
                            tenantName: tenant.name,
                            propertyId: tenant.propertyId,
                            houseNumber: tenant.houseNumber,
                            amount: tenant.amountCharged,
                            billingPeriod: currentMonthYear,
                            createdAt: new Date().toISOString()
                        };
                        bills.push(newBill);
                    }

                    saveToLocalStorage();
                    showModal("Success", `Bills generated successfully for ${tenantsToBill.length} tenant(s)!`);
                    updatePropertiesList(); // Re-render properties section to update balance display
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error generating bills: ", e);
                    showModal("Error", `Failed to generate bills: ${e.message}`);
                }
            });
        }

        function updateGeneratedBillsList() {
            const billsHistoryListDiv = document.getElementById('billsHistoryList');
            if (!billsHistoryListDiv) return;

            let filteredBills = bills;
            if (billingHistoryFilterMonth) {
                filteredBills = bills.filter(bill => bill.billingPeriod === billingHistoryFilterMonth);
            }

            // Sort bills by creation date (newest first)
            filteredBills.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (filteredBills.length === 0) {
                billsHistoryListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No bills found for the selected period.</p>`;
                return;
            }

            billsHistoryListDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Billed</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated On</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredBills.map(bill => {
                                const property = properties.find(p => p.id === bill.propertyId)?.name || 'N/A';
                                const generatedDate = new Date(bill.createdAt).toLocaleDateString();
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.tenantName}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.houseNumber}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${bill.amount.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.billingPeriod}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${generatedDate}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm">
                                            <div class="flex space-x-2">
                                                <button data-bill-id="${bill.id}" class="generate-pdf-btn text-blue-600 hover:text-blue-800 transition duration-200" title="Generate PDF">
                                                    ${icons.FileText}
                                                </button>
                                                <button data-bill-id="${bill.id}" class="delete-bill-btn text-red-600 hover:text-red-800 transition duration-200" title="Delete Bill">
                                                    ${icons.Trash2}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            billsHistoryListDiv.querySelectorAll('.delete-bill-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.billId;
                    handleDeleteBill(billId);
                });
            });

            billsHistoryListDiv.querySelectorAll('.generate-pdf-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.billId;
                    const billToGenerate = bills.find(b => b.id === billId);
                    if (billToGenerate) {
                        generateReceiptPdf(billToGenerate);
                    } else {
                        showModal("Error", "Bill not found for PDF generation.");
                    }
                });
            });
        }

        // Generate PDF for a single receipt
        async function generateReceiptPdf(bill) {
            const tenant = tenants.find(t => t.id === bill.tenantId);
            const property = properties.find(p => p.id === bill.propertyId);

            if (!tenant || !property) {
                showModal("Error", "Tenant or Property information missing for this bill. Cannot generate receipt.");
                return;
            }

            const receiptDate = new Date(bill.createdAt).toLocaleDateString('en-KE', { year: 'numeric', month: 'long', day: 'numeric' });
            const billingPeriodFormatted = new Date(bill.billingPeriod).toLocaleDateString('en-KE', { year: 'numeric', month: 'long' });
            const outstandingBalance = tenant.outstandingBalance.toFixed(2);

            const receiptContent = `
                <div style="font-family: 'Inter', sans-serif; padding: 20px; max-width: 600px; margin: auto; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h2 style="text-align: center; color: #1f2937; margin-bottom: 20px; font-size: 24px;">Rent Receipt</h2>
                    <div style="border-bottom: 1px dashed #d1d5db; padding-bottom: 15px; margin-bottom: 15px;">
                        <p style="font-size: 14px; color: #4b5563; margin-bottom: 5px;"><strong>Receipt Date:</strong> ${receiptDate}</p>
                        <p style="font-size: 14px; color: #4b5563; margin-bottom: 5px;"><strong>Receipt ID:</strong> ${bill.id}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; color: #1f2937; margin-bottom: 10px;">Tenant Details:</h3>
                        <p style="font-size: 14px; color: #4b5563; margin-bottom: 5px;"><strong>Name:</strong> ${tenant.name}</p>
                        <p style="font-size: 14px; color: #4b5563; margin-bottom: 5px;"><strong>House No:</strong> ${tenant.houseNumber}</p>
                        <p style="font-size: 14px; color: #4b5563; margin-bottom: 5px;"><strong>Property:</strong> ${property.name}</p>
                        <p style="font-size: 14px; color: #4b5563; margin-bottom: 5px;"><strong>Phone:</strong> ${tenant.phoneNumber}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 18px; color: #1f2937; margin-bottom: 10px;">Billing Summary:</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #4b5563;">Billing Period:</td>
                                <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #4b5563;">${billingPeriodFormatted}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #4b5563;">Monthly Rent:</td>
                                <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #4b5563;">Ksh ${tenant.amountCharged.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #4b5563;">Amount Billed:</td>
                                <td style="padding: 8px 0; border-bottom: 1px solid #e5e7eb; text-align: right; font-size: 14px; color: #4b5563;">Ksh ${bill.amount.toFixed(2)}</td>
                            </tr>
                            <tr style="font-weight: bold;">
                                <td style="padding: 8px 0; font-size: 16px; color: #1f2937;">Current Outstanding Balance:</td>
                                <td style="padding: 8px 0; text-align: right; font-size: 16px; color: ${outstandingBalance > 0 ? '#dc2626' : '#16a34a'};">Ksh ${outstandingBalance}</td>
                            </tr>
                        </table>
                    </div>

                    <p style="text-align: center; font-size: 12px; color: #6b7280; margin-top: 30px;">Thank you for your payment!</p>
                    <p style="text-align: center; font-size: 12px; color: #6b7280;">Prince Alex Property Management</p>
                </div>
            `;

            // Create a temporary div to render the HTML content for html2canvas
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px'; // Position off-screen
            tempDiv.style.width = '600px'; // Set a fixed width for consistent rendering
            tempDiv.innerHTML = receiptContent;
            document.body.appendChild(tempDiv);

            try {
                const canvas = await html2canvas(tempDiv, { scale: 2 }); // Scale for better quality
                const imgData = canvas.toDataURL('image/png');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`rent-receipt-${tenant.name.replace(/\s/g, '-')}-${tenant.houseNumber}.pdf`);
                showModal("Receipt Generated", `Receipt for ${tenant.name} (${tenant.houseNumber}) downloaded successfully.`);
            } catch (err) {
                console.error("Error generating PDF:", err);
                showModal("Error", `Failed to generate PDF receipt for ${tenant.name}. Please try again.`);
            } finally {
                document.body.removeChild(tempDiv); // Clean up temporary div
            }
        }


        // Delete Bill Handler
        function handleDeleteBill(billId) {
            const billToDelete = bills.find(b => b.id === billId);
            if (!billToDelete) {
                showModal("Error", "Bill not found.");
                return;
            }

            showModal("Confirm Deletion", `Are you sure you want to delete this bill for '${billToDelete.tenantName}' for the period '${billToDelete.billingPeriod}'? This action will also adjust their outstanding balance.`, 'confirm', () => {
                try {
                    // Remove the bill from the array
                    bills = bills.filter(b => b.id !== billId);

                    // Adjust tenant's balance
                    const tenantIndex = tenants.findIndex(t => t.id === billToDelete.tenantId);
                    if (tenantIndex !== -1) {
                        tenants[tenantIndex].outstandingBalance -= billToDelete.amount;
                    }

                    saveToLocalStorage();
                    showModal("Success", "Bill deleted and tenant balance adjusted successfully.");
                    updatePropertiesList(); // Re-render properties section to update balance display
                    updateGeneratedBillsList(); // Re-render bills history
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section
                } catch (e) {
                    console.error("Error deleting bill: ", e);
                    showModal("Error", `Failed to delete bill: ${e.message}`);
                }
            });
        }

        // Render Financial Section
        function renderFinancialSection(parentEl) {
            // Recalculate totals every time this function runs
            const totalRentExpected = tenants.reduce((sum, tenant) => sum + tenant.amountCharged, 0);
            const totalBilled = bills.reduce((sum, bill) => sum + bill.amount, 0);
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalOutstandingBalance = totalBilled - totalPaid;

            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Financial Overview</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        ${renderStatCard(icons.DollarSign, "Total Rent Expected (Monthly)", `Ksh ${totalRentExpected.toFixed(2)}`)}
                        ${renderStatCard(icons.FileText, "Total Billed Amount", `Ksh ${totalBilled.toFixed(2)}`)}
                        ${renderStatCard(icons.Wallet, "Total Paid Amount", `Ksh ${totalPaid.toFixed(2)}`)}
                        ${renderStatCard(icons.DollarSign, "Total Outstanding Balance", `Ksh ${totalOutstandingBalance.toFixed(2)}`)}
                    </div>

                    <div class="mt-8 border-t pt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Payment History</h3>
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mb-4">
                            <select id="financePropertyFilter" class="w-full md:w-auto border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Filter by Property</option>
                                ${properties.map(p => `<option value="${p.id}" ${selectedPropertyForFinanceFilter === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="paymentHistoryList" class="space-y-4">
                            <!-- Payment list will be rendered here -->
                        </div>
                    </div>
                </section>
            `;

            document.getElementById('financePropertyFilter').addEventListener('change', (e) => {
                selectedPropertyForFinanceFilter = e.target.value;
                updatePaymentHistoryList();
            });

            updatePaymentHistoryList();
        }

        function updatePaymentHistoryList() {
            const paymentHistoryListDiv = document.getElementById('paymentHistoryList');
            if (!paymentHistoryListDiv) return;

            let filteredPayments = payments;
            if (selectedPropertyForFinanceFilter) {
                filteredPayments = payments.filter(payment => payment.propertyId === selectedPropertyForFinanceFilter);
            }

            // Sort payments by payment date (newest first)
            filteredPayments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

            if (filteredPayments.length === 0) {
                paymentHistoryListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No payments found for the selected property.</p>`;
                return;
            }

            paymentHistoryListDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Payment Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredPayments.map(payment => {
                                const property = properties.find(p => p.id === payment.propertyId)?.name || 'N/A';
                                const paymentDate = new Date(payment.paymentDate).toLocaleDateString();
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${payment.tenantName}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${property}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${payment.amount.toFixed(2)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${paymentDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- Main Execution ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppData(); // Call the new initialization function
        });
    </script>
</body>
</html>
