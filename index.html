<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Property Billing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            z-index: 60;
        }

        /* Styles for property card animation */
        .property-card {
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc, onSnapshot, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase Configuration (Replace with your actual config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let user = null;
        let userId = null;
        let properties = [];
        let tenants = [];
        let bills = [];
        let payments = [];
        let activeTab = 'summary'; // 'summary', 'properties', 'billing', 'finance'
        let isSidebarOpen = false; // New state for mobile sidebar visibility

        // Icons (SVG strings)
        const icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
            Building: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M12 2v9"></path><path d="M12 2h7a2 2 0 0 1 2 2v3"></path><path d="M12 2H5a2 2 0 0 0-2 2v3"></path><line x1="12" y1="22" x2="12" y2="11"></line></svg>`,
            Receipt: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>`,
            DollarSign: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>`,
            LogOut: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
            PlusCircle: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>`,
            Edit: `<svg xmlns="http://www.w3.org/2000/0000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
            Trash: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            Eye: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            Check: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
            Download: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
            Search: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`
        };

        // --- Utility Functions ---
        function showModal(title, content, onConfirm = null, showCancel = false, confirmText = "OK") {
            const appDiv = document.getElementById('app');
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content p-6 rounded-lg shadow-xl text-center max-w-sm w-full relative">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">${title}</h3>
                    <p class="text-gray-600 mb-6">${content}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="modalConfirmBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            ${confirmText}
                        </button>
                        ${showCancel ? `<button id="modalCancelBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-400 transition duration-200">Cancel</button>` : ''}
                    </div>
                    <button id="modalCloseBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            appDiv.appendChild(modalOverlay);

            const closeModal = () => {
                appDiv.removeChild(modalOverlay);
            };

            document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
            document.getElementById('modalConfirmBtn').addEventListener('click', () => {
                if (onConfirm) onConfirm();
                closeModal();
            });
            if (showCancel) {
                document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
            }

            // Close modal on outside click (only if it's not a confirm/cancel action)
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
        }


        // --- Authentication Functions ---
        function renderLoginPage() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                        <div class="flex justify-center mb-6">
                            <img src="https://placehold.co/80x80/4F46E5/FFFFFF?text=P" alt="Logo" class="rounded-full" />
                        </div>
                        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Welcome Back!</h2>
                        <form id="loginForm">
                            <div class="mb-4">
                                <label for="email" class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
                                <input type="email" id="email" name="email"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="your@example.com" required autocomplete="email">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                                <input type="password" id="password" name="password"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="••••••••" required autocomplete="current-password">
                            </div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                                Login
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                user = userCredential.user;
                userId = user.uid; // Set userId upon successful login
                showModal("Success", "Logged in successfully!");
                await fetchDataAndRenderDashboard(); // Fetch data and render dashboard on successful login
            } catch (error) {
                console.error("Login error:", error);
                showModal("Login Failed", error.message);
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                user = null;
                userId = null;
                properties = [];
                tenants = [];
                bills = [];
                payments = [];
                activeTab = 'summary'; // Reset active tab
                renderLoginPage();
                showModal("Success", "Logged out successfully!");
            } catch (error) {
                console.error("Logout error:", error);
                showModal("Logout Failed", error.message);
            }
        }

        // --- Data Fetching ---
        async function fetchData() {
            if (!userId) {
                console.warn("No user ID available for data fetching.");
                return;
            }

            try {
                const propertiesCol = collection(db, `users/${userId}/properties`);
                const propertiesSnapshot = await getDocs(propertiesCol);
                properties = propertiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const tenantsCol = collection(db, `users/${userId}/tenants`);
                const tenantsSnapshot = await getDocs(tenantsCol);
                tenants = tenantsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const billsCol = collection(db, `users/${userId}/bills`);
                const billsSnapshot = await getDocs(billsCol);
                bills = billsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const paymentsCol = collection(db, `users/${userId}/payments`);
                const paymentsSnapshot = await getDocs(paymentsCol);
                payments = paymentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log("Data fetched:", { properties, tenants, bills, payments });
            } catch (error) {
                console.error("Error fetching data:", error);
                showModal("Data Fetch Error", `Failed to load data: ${error.message}`);
            }
        }

        async function fetchDataAndRenderDashboard() {
            await fetchData(); // Ensure data is fetched before rendering
            renderDashboardPage();
        }

        // --- Dashboard Rendering ---
        function renderDashboardPage() {
            const appDiv = document.getElementById('app');
            const userName = user?.displayName || "User";
            const totalProperties = properties.length;
            const totalTenants = tenants.length;
            const billsGenerated = bills.length;

            appDiv.innerHTML = `
                <div class="flex h-screen bg-gray-100">
                    <aside id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col p-4 shadow-lg
                        fixed inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}
                        md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-50">
                        <div class="flex items-center mb-8">
                            <img src="https://placehold.co/40x40/4F46E5/FFFFFF?text=P" alt="Logo" class="rounded-full mr-3" />
                            <h1 class="text-2xl font-bold">Prince Alex</h1>
                        </div>
                        <nav class="flex-grow">
                            <ul>
                                <li class="mb-2">
                                    <button id="navSummary"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'summary' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Home} <span class="ml-3">Dashboard Overview</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navProperties"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'properties' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Building} <span class="ml-3">Your Properties</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navBilling"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'billing' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Receipt} <span class="ml-3">Billing & Receipts</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navFinance"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'finance' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.DollarSign} <span class="ml-3">Financial Overview</span>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div class="mt-auto">
                            <button id="logoutBtn"
                                class="flex items-center w-full p-3 rounded-lg bg-red-600 hover:bg-red-700 transition duration-200 text-white">
                                ${icons.LogOut} <span class="ml-3">Logout</span>
                            </button>
                            <p class="text-xs text-gray-400 mt-4 break-all">User ID: ${userId || 'N/A'}</p>
                        </div>
                    </aside>

                    ${isSidebarOpen ? `<div id="sidebarOverlay" class="fixed inset-0 bg-black opacity-50 z-40 md:hidden"></div>` : ''}

                    <main class="flex-1 overflow-auto p-8">
                        <header class="bg-white rounded-xl shadow-md p-6 mb-8 flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-800">Welcome, ${userName}!</h2>
                            <button id="mobileMenuBtn" class="md:hidden p-2 rounded-md text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                </svg>
                            </button>
                            <div class="hidden md:flex space-x-4"> <div class="flex items-center text-gray-600">
                                    ${icons.Calendar}
                                    <span class="ml-2">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                            </div>
                        </header>

                        <div id="contentSection"></div>
                    </main>
                </div>
            `;

            // Add event listeners for navigation
            document.getElementById('navSummary').addEventListener('click', () => { activeTab = 'summary'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navProperties').addEventListener('click', () => { activeTab = 'properties'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navBilling').addEventListener('click', () => { activeTab = 'billing'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navFinance').addEventListener('click', () => { activeTab = 'finance'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Add event listener for mobile menu button
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                renderDashboardPage(); // Re-render to apply new sidebar state
            });

            // Add event listener for sidebar overlay (to close sidebar when clicking outside)
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    isSidebarOpen = false;
                    renderDashboardPage(); // Re-render to close sidebar
                });
            }

            // Render content based on active tab
            const contentSection = document.getElementById('contentSection');
            if (activeTab === 'summary') {
                contentSection.innerHTML = renderSummarySection(totalProperties, totalTenants, billsGenerated);
            } else if (activeTab === 'properties') {
                renderPropertiesSection(contentSection);
            } else if (activeTab === 'billing') {
                renderBillingSection(contentSection);
            } else if (activeTab === 'finance') {
                renderFinancialSection(contentSection);
            }
        }

        function renderSummarySection(totalProperties, totalTenants, billsGenerated) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between transition transform hover:scale-105 duration-300">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase mb-2">Total Properties</h3>
                            <p class="text-3xl font-bold text-gray-900">${totalProperties}</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full text-blue-600">
                            ${icons.Building}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between transition transform hover:scale-105 duration-300">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase mb-2">Total Tenants</h3>
                            <p class="text-3xl font-bold text-gray-900">${totalTenants}</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full text-green-600">
                            ${icons.Check}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 flex items-center justify-between transition transform hover:scale-105 duration-300">
                        <div>
                            <h3 class="text-gray-500 text-sm font-medium uppercase mb-2">Bills Generated</h3>
                            <p class="text-3xl font-bold text-gray-900">${billsGenerated}</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full text-purple-600">
                            ${icons.Receipt}
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="addPropertyBtn" class="flex items-center justify-center bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition duration-200">
                            ${icons.PlusCircle} <span class="ml-2 font-medium">Add New Property</span>
                        </button>
                        <button id="addTenantBtn" class="flex items-center justify-center bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200">
                            ${icons.PlusCircle} <span class="ml-2 font-medium">Add New Tenant</span>
                        </button>
                        <button id="recordPaymentBtn" class="flex items-center justify-center bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition duration-200">
                            ${icons.DollarSign} <span class="ml-2 font-medium">Record Payment</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Activity</h3>
                    <p class="text-gray-600">No recent activity to display yet.</p>
                </div>
            `;
        }

        // --- Properties Section ---
        function renderPropertiesSection(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Your Properties</h2>
                    <button id="addNewPropertyBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-200">
                        ${icons.PlusCircle} <span class="ml-2">Add Property</span>
                    </button>
                </div>

                <div id="propertiesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${properties.length > 0 ? properties.map((property, index) => `
                        <div class="property-card bg-white rounded-xl shadow-md p-6 flex flex-col justify-between" style="animation-delay: ${index * 0.1}s;">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800 mb-2">${property.name}</h3>
                                <p class="text-gray-600 mb-1">Location: ${property.location}</p>
                                <p class="text-gray-600 mb-4">Units: ${property.units}</p>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button data-id="${property.id}" class="edit-property-btn bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition duration-200 flex items-center">
                                    ${icons.Edit}
                                </button>
                                <button data-id="${property.id}" class="delete-property-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-200 flex items-center">
                                    ${icons.Trash}
                                </button>
                                <button data-id="${property.id}" class="view-tenants-btn bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-200 flex items-center">
                                    ${icons.Eye} <span class="ml-1">Tenants</span>
                                </button>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-600">No properties added yet. Click "Add Property" to get started.</p>'}
                </div>
            `;

            document.getElementById('addNewPropertyBtn').addEventListener('click', () => showAddEditPropertyModal());

            document.querySelectorAll('.edit-property-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.id;
                    const propertyToEdit = properties.find(p => p.id === propertyId);
                    if (propertyToEdit) {
                        showAddEditPropertyModal(propertyToEdit);
                    }
                });
            });

            document.querySelectorAll('.delete-property-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.id;
                    showModal("Confirm Delete", "Are you sure you want to delete this property? This action cannot be undone.",
                        () => deleteProperty(propertyId), true, "Delete");
                });
            });

            document.querySelectorAll('.view-tenants-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.id;
                    showTenantsForPropertyModal(propertyId);
                });
            });

            // Re-attach quick action buttons from summary tab if present
            document.getElementById('addPropertyBtn')?.addEventListener('click', () => showAddEditPropertyModal());
            document.getElementById('addTenantBtn')?.addEventListener('click', () => showAddEditTenantModal());
            document.getElementById('recordPaymentBtn')?.addEventListener('click', () => showRecordPaymentModal());
        }

        function showAddEditPropertyModal(property = null) {
            const isEdit = property !== null;
            const title = isEdit ? "Edit Property" : "Add New Property";
            const buttonText = isEdit ? "Update Property" : "Add Property";

            const formContent = `
                <form id="propertyForm" class="p-6">
                    <div class="mb-4">
                        <label for="propertyName" class="block text-gray-700 text-sm font-semibold mb-2">Property Name</label>
                        <input type="text" id="propertyName" name="propertyName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${property ? property.name : ''}" required>
                    </div>
                    <div class="mb-4">
                        <label for="propertyLocation" class="block text-gray-700 text-sm font-semibold mb-2">Location</label>
                        <input type="text" id="propertyLocation" name="propertyLocation"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${property ? property.location : ''}" required>
                    </div>
                    <div class="mb-6">
                        <label for="propertyUnits" class="block text-gray-700 text-sm font-semibold mb-2">Number of Units</label>
                        <input type="number" id="propertyUnits" name="propertyUnits"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${property ? property.units : ''}" min="1" required>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        ${buttonText}
                    </button>
                </form>
            `;

            showModal(title, formContent);

            document.getElementById('propertyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('propertyName').value;
                const location = document.getElementById('propertyLocation').value;
                const units = parseInt(document.getElementById('propertyUnits').value, 10);

                if (isEdit) {
                    await updateProperty(property.id, { name, location, units });
                } else {
                    await addProperty({ name, location, units });
                }
                // Modal will be closed by showModal's default confirm action
            });
        }

        async function addProperty(propertyData) {
            try {
                const docRef = await addDoc(collection(db, `users/${userId}/properties`), propertyData);
                showModal("Success", "Property added successfully!");
                await fetchDataAndRenderDashboard(); // Re-fetch and re-render
            } catch (e) {
                console.error("Error adding property: ", e);
                showModal("Error", "Failed to add property: " + e.message);
            }
        }

        async function updateProperty(id, propertyData) {
            try {
                const propertyRef = doc(db, `users/${userId}/properties`, id);
                await updateDoc(propertyRef, propertyData);
                showModal("Success", "Property updated successfully!");
                await fetchDataAndRenderDashboard(); // Re-fetch and re-render
            } catch (e) {
                console.error("Error updating property: ", e);
                showModal("Error", "Failed to update property: " + e.message);
            }
        }

        async function deleteProperty(id) {
            try {
                await deleteDoc(doc(db, `users/${userId}/properties`, id));
                showModal("Success", "Property deleted successfully!");
                await fetchDataAndRenderDashboard(); // Re-fetch and re-render
            } catch (e) {
                console.error("Error deleting property: ", e);
                showModal("Error", "Failed to delete property: " + e.message);
            }
        }

        function showTenantsForPropertyModal(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;

            const tenantsInProperty = tenants.filter(t => t.propertyId === propertyId);

            const tenantListHtml = tenantsInProperty.length > 0 ? tenantsInProperty.map(tenant => `
                <div class="flex justify-between items-center p-3 border-b last:border-b-0">
                    <div>
                        <p class="font-semibold">${tenant.name}</p>
                        <p class="text-sm text-gray-600">Unit: ${tenant.houseNumber}</p>
                        <p class="text-sm text-gray-600">Rent: Ksh ${tenant.monthlyRent.toLocaleString()}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button data-id="${tenant.id}" class="edit-tenant-btn text-yellow-600 hover:text-yellow-800">
                            ${icons.Edit}
                        </button>
                        <button data-id="${tenant.id}" class="delete-tenant-btn text-red-600 hover:text-red-800">
                            ${icons.Trash}
                        </button>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-600 text-center py-4">No tenants for this property yet.</p>';

            const content = `
                <div class="p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl font-bold text-gray-800">${property.name} Tenants</h4>
                        <button id="addTenantToPropertyBtn" data-property-id="${propertyId}" class="bg-blue-600 text-white px-3 py-1 rounded-lg flex items-center text-sm hover:bg-blue-700">
                            ${icons.PlusCircle} <span class="ml-1">Add Tenant</span>
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-2 max-h-60 overflow-y-auto">
                        ${tenantListHtml}
                    </div>
                </div>
            `;

            showModal(`Tenants for ${property.name}`, content);

            document.getElementById('addTenantToPropertyBtn').addEventListener('click', (e) => {
                showAddEditTenantModal(null, e.currentTarget.dataset.propertyId);
            });

            document.querySelectorAll('.modal-content .edit-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.id;
                    const tenantToEdit = tenants.find(t => t.id === tenantId);
                    if (tenantToEdit) {
                        showAddEditTenantModal(tenantToEdit);
                    }
                });
            });

            document.querySelectorAll('.modal-content .delete-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.id;
                    showModal("Confirm Delete", "Are you sure you want to delete this tenant?",
                        () => deleteTenant(tenantId), true, "Delete");
                });
            });
        }


        // --- Billing & Receipts Section ---
        function renderBillingSection(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Billing & Receipts</h2>
                    <div class="flex space-x-4">
                        <button id="generateBillBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-green-700 transition duration-200">
                            ${icons.PlusCircle} <span class="ml-2">Generate Bill</span>
                        </button>
                        <button id="downloadSelectedReceiptsBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-purple-700 transition duration-200">
                            ${icons.Download} <span class="ml-2">Download Selected Receipts</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="mb-4 flex items-center">
                        <label for="tenantSearchBill" class="sr-only">Search Tenant</label>
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                ${icons.Search}
                            </div>
                            <input type="text" id="tenantSearchBill" placeholder="Search by tenant name or house number"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllBills" class="form-checkbox h-4 w-4 text-blue-600">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Due</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billsTableBody" class="bg-white divide-y divide-gray-200">
                                ${renderBillsTable(bills)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('generateBillBtn').addEventListener('click', () => showGenerateBillModal());
            document.getElementById('downloadSelectedReceiptsBtn').addEventListener('click', handleDownloadSelectedReceipts);
            document.getElementById('tenantSearchBill').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredBills = bills.filter(bill =>
                    bill.tenantName.toLowerCase().includes(searchTerm) ||
                    bill.houseNumber.toLowerCase().includes(searchTerm)
                );
                document.getElementById('billsTableBody').innerHTML = renderBillsTable(filteredBills);
                attachBillTableEventListeners();
            });

            attachBillTableEventListeners();
        }

        function renderBillsTable(billsToRender) {
            if (billsToRender.length === 0) {
                return `<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No bills generated yet.</td></tr>`;
            }
            return billsToRender.map(bill => {
                const propertyName = properties.find(p => p.id === bill.propertyId)?.name || 'N/A';
                const statusClass = bill.status === 'Paid' ? 'text-green-600' : (bill.status === 'Overdue' ? 'text-red-600' : 'text-yellow-600');
                const isPaidOrReceiptGenerated = bill.status === 'Paid' || bill.receiptGenerated; // Assuming receiptGenerated flag
                return `
                    <tr data-id="${bill.id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="bill-checkbox h-4 w-4 text-blue-600" ${isPaidOrReceiptGenerated ? '' : 'disabled'}>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${bill.tenantName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${bill.houseNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${propertyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(bill.billDate).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(bill.dueDate).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">Ksh ${bill.amountDue.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${statusClass}">${bill.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${bill.id}" class="edit-bill-btn text-yellow-600 hover:text-yellow-800 ml-2">
                                ${icons.Edit}
                            </button>
                            <button data-id="${bill.id}" class="delete-bill-btn text-red-600 hover:text-red-800 ml-2">
                                ${icons.Trash}
                            </button>
                            ${bill.status === 'Paid' && !bill.receiptGenerated ? `
                            <button data-id="${bill.id}" class="generate-single-receipt-btn bg-blue-500 text-white p-1 rounded-lg text-xs hover:bg-blue-600 ml-2">
                                Generate Receipt
                            </button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function attachBillTableEventListeners() {
            document.querySelectorAll('.edit-bill-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.id;
                    const billToEdit = bills.find(b => b.id === billId);
                    if (billToEdit) {
                        showGenerateBillModal(billToEdit);
                    }
                });
            });

            document.querySelectorAll('.delete-bill-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.id;
                    showModal("Confirm Delete", "Are you sure you want to delete this bill?",
                        () => deleteBill(billId), true, "Delete");
                });
            });

            document.querySelectorAll('.generate-single-receipt-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const billId = e.currentTarget.dataset.id;
                    const billToGenerate = bills.find(b => b.id === billId);
                    if (billToGenerate) {
                        generateReceiptsPDF([billToGenerate]);
                    }
                });
            });

            document.getElementById('selectAllBills')?.addEventListener('change', (e) => {
                document.querySelectorAll('.bill-checkbox:not(:disabled)').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });
        }


        function showGenerateBillModal(bill = null) {
            const isEdit = bill !== null;
            const title = isEdit ? "Edit Bill" : "Generate New Bill";
            const buttonText = isEdit ? "Update Bill" : "Generate Bill";

            const tenantOptions = tenants.map(t => `<option value="${t.id}" ${bill && bill.tenantId === t.id ? 'selected' : ''}>${t.name} - ${t.houseNumber} (${properties.find(p => p.id === t.propertyId)?.name || 'N/A'})</option>`).join('');

            const formContent = `
                <form id="billForm" class="p-6">
                    <div class="mb-4">
                        <label for="billTenant" class="block text-gray-700 text-sm font-semibold mb-2">Select Tenant</label>
                        <select id="billTenant" name="billTenant"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required>
                            <option value="">-- Select a Tenant --</option>
                            ${tenantOptions}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="billAmount" class="block text-gray-700 text-sm font-semibold mb-2">Amount Due (Ksh)</label>
                        <input type="number" id="billAmount" name="billAmount"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${bill ? bill.amountDue : ''}" min="0" required>
                    </div>
                    <div class="mb-4">
                        <label for="billDate" class="block text-gray-700 text-sm font-semibold mb-2">Bill Date</label>
                        <input type="date" id="billDate" name="billDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${bill ? new Date(bill.billDate).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="mb-6">
                        <label for="billDueDate" class="block text-gray-700 text-sm font-semibold mb-2">Due Date</label>
                        <input type="date" id="billDueDate" name="billDueDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${bill ? new Date(bill.dueDate).toISOString().split('T')[0] : ''}" required>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        ${buttonText}
                    </button>
                </form>
            `;

            showModal(title, formContent);

            // Prefill tenant monthly rent if it's a new bill
            if (!isEdit) {
                document.getElementById('billTenant').addEventListener('change', (e) => {
                    const selectedTenantId = e.target.value;
                    const selectedTenant = tenants.find(t => t.id === selectedTenantId);
                    if (selectedTenant) {
                        document.getElementById('billAmount').value = selectedTenant.monthlyRent;
                        // Set due date to end of current month
                        const today = new Date();
                        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        document.getElementById('billDueDate').value = lastDayOfMonth.toISOString().split('T')[0];
                    }
                });
            }

            document.getElementById('billForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const tenantId = document.getElementById('billTenant').value;
                const amountDue = parseFloat(document.getElementById('billAmount').value);
                const billDate = document.getElementById('billDate').value;
                const dueDate = document.getElementById('billDueDate').value;

                const selectedTenant = tenants.find(t => t.id === tenantId);
                if (!selectedTenant) {
                    showModal("Error", "Selected tenant not found.");
                    return;
                }

                const billData = {
                    tenantId: selectedTenant.id,
                    tenantName: selectedTenant.name,
                    houseNumber: selectedTenant.houseNumber,
                    propertyId: selectedTenant.propertyId,
                    amountDue,
                    billDate,
                    dueDate,
                    status: 'Unpaid', // Default status
                    receiptGenerated: false // Track if receipt has been generated
                };

                if (isEdit) {
                    await updateBill(bill.id, billData);
                } else {
                    await addBill(billData);
                }
            });
        }

        async function addBill(billData) {
            try {
                const docRef = await addDoc(collection(db, `users/${userId}/bills`), billData);
                showModal("Success", "Bill generated successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error adding bill: ", e);
                showModal("Error", "Failed to generate bill: " + e.message);
            }
        }

        async function updateBill(id, billData) {
            try {
                const billRef = doc(db, `users/${userId}/bills`, id);
                await updateDoc(billRef, billData);
                showModal("Success", "Bill updated successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error updating bill: ", e);
                showModal("Error", "Failed to update bill: " + e.message);
            }
        }

        async function deleteBill(id) {
            try {
                await deleteDoc(doc(db, `users/${userId}/bills`, id));
                showModal("Success", "Bill deleted successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error deleting bill: ", e);
                showModal("Error", "Failed to delete bill: " + e.message);
            }
        }

        async function handleDownloadSelectedReceipts() {
            const selectedBillIds = Array.from(document.querySelectorAll('.bill-checkbox:checked'))
                                       .map(checkbox => checkbox.closest('tr').dataset.id);

            if (selectedBillIds.length === 0) {
                showModal("No Bills Selected", "Please select at least one paid bill to generate receipts.");
                return;
            }

            const billsToGenerate = bills.filter(bill => selectedBillIds.includes(bill.id) && bill.status === 'Paid');

            if (billsToGenerate.length === 0) {
                showModal("No Paid Bills Selected", "Selected bills are not marked as 'Paid'. Only paid bills can have receipts generated.");
                return;
            }

            await generateReceiptsPDF(billsToGenerate);
        }

        // Include jsPDF and html2canvas libraries (CDNs should be in your HTML head)
        // <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        // <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        async function generateReceiptsPDF(billsToGenerate) {
            if (typeof jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                showModal("Error", "PDF generation libraries not loaded. Please check your internet connection or script tags.");
                return;
            }

            for (const bill of billsToGenerate) {
                const tenant = tenants.find(t => t.id === bill.tenantId);
                const property = properties.find(p => p.id === bill.propertyId);
                const payment = payments.find(p => p.billId === bill.id && p.status === 'Completed'); // Assuming a completed payment exists

                if (!tenant || !property || !payment) {
                    console.warn(`Skipping receipt for bill ${bill.id}: Missing tenant, property, or completed payment data.`);
                    showModal("Warning", `Could not generate receipt for ${bill.tenantName} - ${bill.houseNumber} due to missing data (tenant, property, or payment).`);
                    continue;
                }

                // Create a temporary div to render the receipt content for PDF generation
                const tempDiv = document.createElement('div');
                tempDiv.style.width = '210mm'; // A4 width
                tempDiv.style.padding = '10mm';
                tempDiv.style.backgroundColor = 'white';
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px'; // Hide it from view
                document.body.appendChild(tempDiv);

                tempDiv.innerHTML = `
                    <div style="font-family: 'Inter', sans-serif; color: #333; line-height: 1.6;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 28px; font-weight: bold; color: #1f2937;">RENT RECEIPT</h1>
                            <p style="font-size: 16px; color: #4b5563;">Prince Alex Property Billing System</p>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div>
                                <p><strong>Receipt No:</strong> ${bill.id.substring(0, 8).toUpperCase()}</p>
                                <p><strong>Date:</strong> ${new Date(payment.paymentDate).toLocaleDateString()}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Property:</strong> ${property.name}</p>
                                <p><strong>Location:</strong> ${property.location}</p>
                            </div>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h2 style="font-size: 20px; font-weight: bold; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-bottom: 15px;">Tenant Details</h2>
                            <p><strong>Name:</strong> ${tenant.name}</p>
                            <p><strong>House/Unit No:</strong> ${tenant.houseNumber}</p>
                            <p><strong>Contact:</strong> ${tenant.contact || 'N/A'}</p>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h2 style="font-size: 20px; font-weight: bold; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-bottom: 15px;">Payment Details</h2>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                                <thead>
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: left;">Description</th>
                                        <th style="padding: 10px; border: 1px solid #e5e7eb; text-align: right;">Amount (Ksh)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb;">Monthly Rent for ${new Date(bill.billDate).toLocaleString('en-KE', { month: 'long', year: 'numeric' })}</td>
                                        <td style="padding: 10px; border: 1px solid #e5e7eb; text-align: right;">${bill.amountDue.toLocaleString()}</td>
                                    </tr>
                                    </tbody>
                            </table>
                            <div style="text-align: right; font-size: 18px; font-weight: bold; padding-top: 10px; border-top: 2px solid #e5e7eb;">
                                Total Paid: Ksh ${payment.amount.toLocaleString()}
                            </div>
                            <p style="text-align: right; margin-top: 10px; font-size: 14px; color: #4b5563;">
                                Payment Method: ${payment.method}
                            </p>
                        </div>

                        <div style="text-align: center; margin-top: 50px; border-top: 1px dashed #d1d5db; padding-top: 20px;">
                            <p style="font-size: 14px; color: #4b5563;">Thank you for your payment!</p>
                            <p style="font-size: 12px; color: #6b7280;">Prince Alex Property Billing System | Contact: [Your Contact Info]</p>
                        </div>
                    </div>
                `;

                try {
                    const canvas = await html2canvas(tempDiv, { scale: 2 }); // Higher scale for better quality
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(`rent-receipt-${bill.tenantName.replace(/\s/g, '-')}-${bill.houseNumber}.pdf`);

                    // Update bill status to indicate receipt generated
                    await updateDoc(doc(db, `users/${userId}/bills`, bill.id), { receiptGenerated: true });
                    // Re-fetch and re-render to update the UI
                    await fetchDataAndRenderDashboard();

                } catch (err) {
                    console.error("Error generating PDF for receipt:", err);
                    showModal("Error", `Failed to generate PDF for ${bill.tenantName}. Please try again.`);
                } finally {
                    document.body.removeChild(tempDiv); // Clean up temporary div
                }
            }
            showModal("Receipts Generated", "All selected receipts have been generated and downloaded.");
        }


        // --- Financial Overview Section ---
        function renderFinancialSection(container) {
            // Calculate totals
            const totalRentExpected = tenants.reduce((sum, tenant) => sum + tenant.monthlyRent, 0);
            const totalPaymentsReceived = payments.filter(p => p.status === 'Completed').reduce((sum, p) => sum + p.amount, 0);
            const totalOutstandingBills = bills.filter(bill => bill.status !== 'Paid').reduce((sum, bill) => sum + bill.amountDue, 0);

            // Get recent payments
            const recentPayments = payments
                .filter(p => p.status === 'Completed')
                .sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate))
                .slice(0, 5); // Get latest 5 payments

            container.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Financial Overview</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-md p-6 transition transform hover:scale-105 duration-300">
                        <h3 class="text-gray-500 text-sm font-medium uppercase mb-2">Total Rent Expected (Monthly)</h3>
                        <p class="text-3xl font-bold text-gray-900">Ksh ${totalRentExpected.toLocaleString()}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 transition transform hover:scale-105 duration-300">
                        <h3 class="text-gray-500 text-sm font-medium uppercase mb-2">Total Payments Received</h3>
                        <p class="text-3xl font-bold text-gray-900">Ksh ${totalPaymentsReceived.toLocaleString()}</p>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 transition transform hover:scale-105 duration-300">
                        <h3 class="text-gray-500 text-sm font-medium uppercase mb-2">Outstanding Bills</h3>
                        <p class="text-3xl font-bold text-gray-900">Ksh ${totalOutstandingBills.toLocaleString()}</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Payments</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${recentPayments.length > 0 ? recentPayments.map(payment => {
                                    const tenant = tenants.find(t => t.id === payment.tenantId);
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">${tenant ? tenant.name : 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${tenant ? tenant.houseNumber : 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">Ksh ${payment.amount.toLocaleString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${new Date(payment.paymentDate).toLocaleDateString()}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">${payment.method}</td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No recent payments.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showRecordPaymentModal() {
            const unpaidBills = bills.filter(bill => bill.status !== 'Paid');
            const billOptions = unpaidBills.map(bill => {
                const tenant = tenants.find(t => t.id === bill.tenantId);
                const property = properties.find(p => p.id === bill.propertyId);
                return `<option value="${bill.id}" data-amount="${bill.amountDue}">${tenant?.name} - ${tenant?.houseNumber} (${property?.name}) - Ksh ${bill.amountDue.toLocaleString()}</option>`;
            }).join('');

            const formContent = `
                <form id="paymentForm" class="p-6">
                    <div class="mb-4">
                        <label for="paymentBill" class="block text-gray-700 text-sm font-semibold mb-2">Select Bill</label>
                        <select id="paymentBill" name="paymentBill"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required>
                            <option value="">-- Select an Unpaid Bill --</option>
                            ${billOptions}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="paymentAmount" class="block text-gray-700 text-sm font-semibold mb-2">Amount Paid (Ksh)</label>
                        <input type="number" id="paymentAmount" name="paymentAmount"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            min="0" required>
                    </div>
                    <div class="mb-4">
                        <label for="paymentDate" class="block text-gray-700 text-sm font-semibold mb-2">Payment Date</label>
                        <input type="date" id="paymentDate" name="paymentDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="mb-6">
                        <label for="paymentMethod" class="block text-gray-700 text-sm font-semibold mb-2">Payment Method</label>
                        <select id="paymentMethod" name="paymentMethod"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required>
                            <option value="M-Pesa">M-Pesa</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        Record Payment
                    </button>
                </form>
            `;

            showModal("Record Payment", formContent);

            document.getElementById('paymentBill').addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const amountDue = selectedOption.dataset.amount;
                document.getElementById('paymentAmount').value = amountDue;
            });

            document.getElementById('paymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const billId = document.getElementById('paymentBill').value;
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                const paymentDate = document.getElementById('paymentDate').value;
                const method = document.getElementById('paymentMethod').value;

                const bill = bills.find(b => b.id === billId);
                if (!bill) {
                    showModal("Error", "Selected bill not found.");
                    return;
                }
                if (amount < bill.amountDue) {
                    showModal("Error", "Amount paid is less than amount due. Please record full payment.");
                    return;
                }
                if (amount > bill.amountDue) {
                    showModal("Error", "Amount paid is more than amount due. Please enter the exact amount due.");
                    return;
                }


                const paymentData = {
                    billId: bill.id,
                    tenantId: bill.tenantId,
                    propertyId: bill.propertyId,
                    amount: amount,
                    paymentDate,
                    method,
                    status: 'Completed'
                };

                await addPayment(paymentData, bill.id);
            });
        }

        async function addPayment(paymentData, billId) {
            try {
                await addDoc(collection(db, `users/${userId}/payments`), paymentData);
                // Update the associated bill's status to 'Paid'
                const billRef = doc(db, `users/${userId}/bills`, billId);
                await updateDoc(billRef, { status: 'Paid' });
                showModal("Success", "Payment recorded successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error adding payment: ", e);
                showModal("Error", "Failed to record payment: " + e.message);
            }
        }


        // --- Tenants Section (for managing all tenants, not just property-specific) ---
        function renderTenantsSection(container) {
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">All Tenants</h2>
                    <button id="addNewTenantBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-200">
                        ${icons.PlusCircle} <span class="ml-2">Add Tenant</span>
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="mb-4 flex items-center">
                        <label for="tenantSearch" class="sr-only">Search Tenant</label>
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                ${icons.Search}
                            </div>
                            <input type="text" id="tenantSearch" placeholder="Search by name or house number"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Rent</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tenantsTableBody" class="bg-white divide-y divide-gray-200">
                                ${renderTenantsTable(tenants)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('addNewTenantBtn').addEventListener('click', () => showAddEditTenantModal());
            document.getElementById('tenantSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredTenants = tenants.filter(tenant =>
                    tenant.name.toLowerCase().includes(searchTerm) ||
                    tenant.houseNumber.toLowerCase().includes(searchTerm)
                );
                document.getElementById('tenantsTableBody').innerHTML = renderTenantsTable(filteredTenants);
                attachTenantTableEventListeners(); // Re-attach event listeners after re-rendering
            });
            attachTenantTableEventListeners(); // Initial attachment
        }

        function renderTenantsTable(tenantsToRender) {
            if (tenantsToRender.length === 0) {
                return `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No tenants added yet.</td></tr>`;
            }
            return tenantsToRender.map(tenant => {
                const propertyName = properties.find(p => p.id === tenant.propertyId)?.name || 'N/A';
                return `
                    <tr data-id="${tenant.id}">
                        <td class="px-6 py-4 whitespace-nowrap">${tenant.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${propertyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${tenant.houseNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap">Ksh ${tenant.monthlyRent.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${tenant.contact || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${tenant.id}" class="edit-tenant-btn text-yellow-600 hover:text-yellow-800 ml-2">
                                ${icons.Edit}
                            </button>
                            <button data-id="${tenant.id}" class="delete-tenant-btn text-red-600 hover:text-red-800 ml-2">
                                ${icons.Trash}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function attachTenantTableEventListeners() {
            document.querySelectorAll('.edit-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.id;
                    const tenantToEdit = tenants.find(t => t.id === tenantId);
                    if (tenantToEdit) {
                        showAddEditTenantModal(tenantToEdit);
                    }
                });
            });

            document.querySelectorAll('.delete-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.id;
                    showModal("Confirm Delete", "Are you sure you want to delete this tenant? All associated bills and payments will remain.",
                        () => deleteTenant(tenantId), true, "Delete");
                });
            });

            // Re-attach quick action buttons from summary tab if present
            document.getElementById('addPropertyBtn')?.addEventListener('click', () => showAddEditPropertyModal());
            document.getElementById('addTenantBtn')?.addEventListener('click', () => showAddEditTenantModal());
            document.getElementById('recordPaymentBtn')?.addEventListener('click', () => showRecordPaymentModal());
        }

        function showAddEditTenantModal(tenant = null, preselectedPropertyId = null) {
            const isEdit = tenant !== null;
            const title = isEdit ? "Edit Tenant" : "Add New Tenant";
            const buttonText = isEdit ? "Update Tenant" : "Add Tenant";

            const propertyOptions = properties.map(p =>
                `<option value="${p.id}" ${
                    (isEdit && tenant.propertyId === p.id) || (!isEdit && preselectedPropertyId === p.id) ? 'selected' : ''
                }>${p.name}</option>`
            ).join('');

            const formContent = `
                <form id="tenantForm" class="p-6">
                    <div class="mb-4">
                        <label for="tenantName" class="block text-gray-700 text-sm font-semibold mb-2">Tenant Name</label>
                        <input type="text" id="tenantName" name="tenantName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${tenant ? tenant.name : ''}" required>
                    </div>
                    <div class="mb-4">
                        <label for="tenantProperty" class="block text-gray-700 text-sm font-semibold mb-2">Property</label>
                        <select id="tenantProperty" name="tenantProperty"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required>
                            <option value="">-- Select a Property --</option>
                            ${propertyOptions}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="houseNumber" class="block text-gray-700 text-sm font-semibold mb-2">House/Unit Number</label>
                        <input type="text" id="houseNumber" name="houseNumber"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${tenant ? tenant.houseNumber : ''}" required>
                    </div>
                    <div class="mb-4">
                        <label for="monthlyRent" class="block text-gray-700 text-sm font-semibold mb-2">Monthly Rent (Ksh)</label>
                        <input type="number" id="monthlyRent" name="monthlyRent"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${tenant ? tenant.monthlyRent : ''}" min="0" required>
                    </div>
                    <div class="mb-6">
                        <label for="contact" class="block text-gray-700 text-sm font-semibold mb-2">Contact Info (Phone/Email)</label>
                        <input type="text" id="contact" name="contact"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="${tenant ? tenant.contact : ''}">
                    </div>
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                        ${buttonText}
                    </button>
                </form>
            `;

            showModal(title, formContent);

            document.getElementById('tenantForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('tenantName').value;
                const propertyId = document.getElementById('tenantProperty').value;
                const houseNumber = document.getElementById('houseNumber').value;
                const monthlyRent = parseFloat(document.getElementById('monthlyRent').value);
                const contact = document.getElementById('contact').value;

                const tenantData = {
                    name,
                    propertyId,
                    houseNumber,
                    monthlyRent,
                    contact
                };

                if (isEdit) {
                    await updateTenant(tenant.id, tenantData);
                } else {
                    await addTenant(tenantData);
                }
            });
        }

        async function addTenant(tenantData) {
            try {
                const docRef = await addDoc(collection(db, `users/${userId}/tenants`), tenantData);
                showModal("Success", "Tenant added successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error adding tenant: ", e);
                showModal("Error", "Failed to add tenant: " + e.message);
            }
        }

        async function updateTenant(id, tenantData) {
            try {
                const tenantRef = doc(db, `users/${userId}/tenants`, id);
                await updateDoc(tenantRef, tenantData);
                showModal("Success", "Tenant updated successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error updating tenant: ", e);
                showModal("Error", "Failed to update tenant: " + e.message);
            }
        }

        async function deleteTenant(id) {
            try {
                await deleteDoc(doc(db, `users/${userId}/tenants`, id));
                showModal("Success", "Tenant deleted successfully!");
                await fetchDataAndRenderDashboard();
            } catch (e) {
                console.error("Error deleting tenant: ", e);
                showModal("Error", "Failed to delete tenant: " + e.message);
            }
        }


        // --- Firebase Auth State Listener ---
        onAuthStateChanged(auth, async (currentUser) => {
            user = currentUser;
            if (user) {
                userId = user.uid;
                await fetchDataAndRenderDashboard();
            } else {
                renderLoginPage();
            }
        });

        // Initial render when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if Firebase is already initialized
            if (!app._is></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
