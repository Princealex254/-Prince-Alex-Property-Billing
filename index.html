<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince Alex Property Billing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">\
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 48rem; /* Increased max-width for better layout */
            transform: scale(1);
            opacity: 1;
            transition: all 0.3s ease-out;
            overflow: hidden; /* Ensure content inside doesn't overflow rounded corners */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-body {
            padding: 1rem;
        }
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .loading-spinner {
            border-top-color: #3b82f6; /* Blue-500 */
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-inter antialiased bg-gray-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="text-center">
                <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-lg text-gray-700">Loading application...</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyB1rF-ATVbH04EYa0ADc9KtDVO9UigYwn8",
            authDomain: "prince-alex-property-billing.firebaseapp.com",
            projectId: "prince-alex-property-billing",
            storageBucket: "prince-alex-property-billing.firebasestorage.app",
            messagingSenderId: "622455148749",
            appId: "1:622455148749:web:b81c00836d6df828681984"
        });
    </script>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Lucide Icons (as SVG strings for direct embedding)
        const icons = {
            Home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            Users: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            Building: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9.5 16h5"/><path d="M9.5 12h5"/><path d="M9.5 8h5"/><path d="M12 22V2"/></svg>`,
            Receipt: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2h-2.5a2 2 0 0 1-2-2H6.5a2 2 0 0 1-2 2H4Z"/><path d="M18 6H8"/><path d="M18 10H8"/><path d="M18 14H8"/><path d="M18 18H8"/></svg>`,
            PlusCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
            Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>`,
            Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            LogOut: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="11" y1="12" y2="12"/></svg>`,
            FileText: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`,
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            HomeIcon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`, // Reusing Home for HomeIcon
            Wallet: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h12a2 2 0 0 0 2-2v-3"/><path d="M22 7V4a1 1 0 0 0-1-1H3a2 2 0 0 0 0 4h18a1 1 0 0 0 1-1Z"/></svg>`,
            Search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
            DollarSign: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            Menu: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            Download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`
        };


        // Global State
        let user = null; // Represents the logged-in user (for display name)
        let userId = null; // Firebase User ID
        let currentPage = 'login'; // 'login', 'dashboard'
        let properties = [];
        let tenants = [];
        let bills = [];
        let payments = []; // New array for payment records
        let activeTab = 'summary'; // 'summary', 'properties', 'billing', 'finance'
        // Removed global tenantSearchQuery, replaced by propertyTenantSearchQueries
        let billingTenantSearchQuery = ''; // New state for tenant search in billing tab
        let selectedPropertyForBillingFilter = ''; // New state for billing property filter
        let billingHistoryFilterMonth = new Date().toISOString().substring(0, 7); // YYYY-MM format, default to current month
        let selectedPropertyForFinanceFilter = ''; // New state for finance property filter
        let isSidebarOpen = false; // New state for sidebar visibility on mobile
        let propertyTenantSearchQueries = {}; // New state to store search queries per property

        const houseTypes = ['Apartment', 'Bungalow', 'Mansionette', 'Commercial Space', 'Shop'];
        const WATER_PRICE_PER_UNIT = 50; // Example: Ksh 50 per water unit

        // Firebase variables
        let firebaseApp;
        let db;
        let auth;

        // Collection paths (dynamic based on appId and userId)
        let propertyCollectionRef;
        let tenantCollectionRef;
        let billCollectionRef;
        let paymentCollectionRef;

        // Custom Modal Functions (replaces alert and confirm)
        function showModal(title, content, type = 'alert', onConfirm = null) {
            const appDiv = document.getElementById('app');
            let modalOverlay = document.querySelector('.modal-overlay');

            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                appDiv.appendChild(modalOverlay);
            }

            // Ensure content is a DOM element if it's not a string
            const contentElement = typeof content === 'string' ? `<p class="text-gray-700">${content}</p>` : content.outerHTML || '';

            modalOverlay.innerHTML = `
                <div class="modal-content max-w-xl">
                    <div class="modal-header">
                        <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                        <button class="text-gray-500 hover:text-gray-700 transition duration-200 modal-close-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body p-4">
                        ${contentElement}
                    </div>
                    <div class="modal-footer">
                        ${type === 'confirm' ? `
                            <button class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-200 modal-cancel-btn">
                                Cancel
                            </button>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 modal-confirm-btn">
                                Confirm
                            </button>
                        ` : `
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 modal-close-btn">
                                OK
                            </button>
                        `}
                    </div>
                </div>
            `;
            modalOverlay.style.display = 'flex'; // Ensure it's visible

            // If content was a DOM element, re-append it so event listeners work
            if (typeof content !== 'string') {
                const modalBody = modalOverlay.querySelector('.modal-body');
                modalBody.innerHTML = ''; // Clear the innerHTML from the template
                modalBody.appendChild(content); // Append the actual DOM element
            }


            const closeModal = () => {
                modalOverlay.style.display = 'none';
                modalOverlay.innerHTML = ''; // Clear content
            };

            modalOverlay.querySelector('.modal-close-btn').addEventListener('click', closeModal);

            if (type === 'confirm') {
                modalOverlay.querySelector('.modal-cancel-btn').addEventListener('click', closeModal);
                modalOverlay.querySelector('.modal-confirm-btn').addEventListener('click', () => {
                    if (onConfirm) onConfirm();
                    closeModal();
                });
            }
        }


        // Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Safely parse __firebase_config from window
                const rawConfigString = window.__firebase_config || '{}';
                let firebaseConfig = {};
                try {
                    firebaseConfig = JSON.parse(rawConfigString);
                } catch (e) {
                    console.error("Error parsing Firebase configuration string:", e);
                    showModal("Configuration Error", "Invalid Firebase configuration format. Please ensure it's a valid JSON string.");
                    renderLoginPage();
                    return;
                }

                // Crucial check: Ensure firebaseConfig has an apiKey before initializing
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase configuration is missing API Key. Cannot initialize Firebase.");
                    showModal("Configuration Error", "Firebase API Key is missing. Please ensure Firebase is correctly configured in the environment.");
                    renderLoginPage();
                    return;
                }

                // Initialize Firebase App
                try {
                    firebaseApp = initializeApp(firebaseConfig);
                } catch (e) {
                    console.error("Error initializing Firebase App:", e);
                    showModal("Firebase Initialization Error", `Failed to initialize Firebase App: ${e.message}. Please check your Firebase configuration.`);
                    renderLoginPage();
                    return;
                }

                // Ensure firebaseApp is valid before getting services
                if (!firebaseApp) {
                    console.error("Firebase App is null or undefined after initialization.");
                    showModal("Firebase Error", "Firebase App object is invalid. Cannot proceed with services.");
                    renderLoginPage();
                    return;
                }

                // Get Firestore and Auth instances
                try {
                    db = getFirestore(firebaseApp);
                    auth = getAuth(firebaseApp);
                } catch (e) {
                    console.error("Error getting Firebase services (Firestore/Auth):", e);
                    showModal("Firebase Service Error", `Failed to get Firebase services: ${e.message}. This might indicate a problem with your Firebase project setup.`);
                    renderLoginPage();
                    return; // Exit if auth fails to initialize
                }

                // Set up authentication listener
                // This will only run if 'auth' is successfully initialized
                onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        user = { displayName: currentUser.displayName || "Admin" };
                        userId = currentUser.uid;
                        // Define collection references after userId is available
                        propertyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/properties`);
                        tenantCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tenants`);
                        billCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/bills`);
                        paymentCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/payments`);
                        
                        await initializeFirestoreListeners(); // Start listening to data changes
                        currentPage = 'dashboard'; // Set page to dashboard after successful auth and listeners
                        renderDashboardPage(); // Render dashboard once authenticated and data listeners are set
                    } else {
                        user = null;
                        userId = null;
                        currentPage = 'login';
                        renderLoginPage();
                    }
                });

                // Always render login page initially, authentication will redirect to dashboard if successful
                renderLoginPage();

            } catch (error) {
                // This catch block will handle any other unexpected errors
                console.error("Unhandled error during Firebase setup:", error);
                let errorMessage = `An unexpected error occurred during Firebase setup: ${error.message}`;
                if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Network error. Please check your internet connection.";
                } else if (error.code === 'app/invalid-credential') {
                    errorMessage = "Firebase project credentials are invalid. Please check your Firebase configuration.";
                }
                showModal("Firebase Error", errorMessage);
                renderLoginPage();
            }
        }

        // Firestore Real-time Listeners
        async function initializeFirestoreListeners() {
            // Properties Listener
            onSnapshot(propertyCollectionRef, (snapshot) => {
                properties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Trigger re-render of relevant sections
                if (currentPage === 'dashboard') {
                    updatePropertiesList();
                    updateBillingTenantDropdown();
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section to update filters
                }
            }, (error) => {
                console.error("Error listening to properties:", error);
                showModal("Firestore Error", `Failed to load properties: ${error.message}`);
            });

            // Tenants Listener
            onSnapshot(tenantCollectionRef, (snapshot) => {
                tenants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Trigger re-render of relevant sections
                if (currentPage === 'dashboard') {
                    updatePropertiesList();
                    updateBillingTenantDropdown();
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section to update balances
                }
            }, (error) => {
                console.error("Error listening to tenants:", error);
                showModal("Firestore Error", `Failed to load tenants: ${error.message}`);
            });

            // Bills Listener
            onSnapshot(billCollectionRef, (snapshot) => {
                bills = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                bills.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); // Sort newest first
                // Trigger re-render of relevant sections
                if (currentPage === 'dashboard') {
                    updateGeneratedBillsList();
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section to update billed amounts
                }
            }, (error) => {
                console.error("Error listening to bills:", error);
                showModal("Firestore Error", `Failed to load bills: ${error.message}`);
            });

            // Payments Listener
            onSnapshot(paymentCollectionRef, (snapshot) => {
                payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                payments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate)); // Sort newest first
                // Trigger re-render of relevant sections
                if (currentPage === 'dashboard') {
                    renderFinancialSection(document.getElementById('contentSection')); // Re-render finance section to update paid amounts
                }
            }, (error) => {
                console.error("Error listening to payments:", error);
                showModal("Firestore Error", `Failed to load payments: ${error.message}`);
            });
        }


        // Render Functions
        function renderApp() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Clear existing content

            // Show initial loading spinner
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div class="text-center">
                        <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                        <p class="mt-4 text-lg text-gray-700">Loading application...</p>
                    </div>
                </div>
            `;

            // Firebase will handle rendering after authentication and data load
        }

        function renderLoginPage() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 hover:scale-105">
                        <div class="flex justify-center mb-6">
                            <img src="https://placehold.co/100x100/4F46E5/FFFFFF?text=Logo" alt="Prince Alex Property Logo" class="rounded-full shadow-lg" />
                        </div>
                        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Welcome to Prince Alex Property</h2>
                        <p class="text-center text-gray-600 mb-8">Property Billing System</p>
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="email">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    id="email"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                    placeholder="Enter your email"
                                    required
                                />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-semibold mb-2" for="password">
                                    Password
                                </label>
                                <input
                                    type="password"
                                    id="password"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                    placeholder="Enter your password"
                                    required
                                />
                            </div>
                            <p id="loginError" class="text-red-600 text-sm text-center hidden"></p>
                            <button
                                type="submit"
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg"
                            >
                                Login
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLoginSubmit);
        }

        function renderDashboardPage() {
            const appDiv = document.getElementById('app');
            const userName = user?.displayName || "User";
            const totalProperties = properties.length;
            const totalTenants = tenants.length;
            const billsGenerated = bills.length;

            appDiv.innerHTML = `
                <div class="flex h-screen bg-gray-100">
                    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 text-white flex flex-col p-4 shadow-lg transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out">
                        <div class="flex items-center mb-8">
                            <img src="https://placehold.co/40x40/4F46E5/FFFFFF?text=P" alt="Logo" class="rounded-full mr-3" />
                            <h1 class="text-2xl font-bold">Prince Alex</h1>
                        </div>
                        <nav class="flex-grow">
                            <ul>
                                <li class="mb-2">
                                    <button id="navSummary"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'summary' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Home} <span class="ml-3">Dashboard Overview</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navProperties"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'properties' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Building} <span class="ml-3">Your Properties</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navBilling"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'billing' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.Receipt} <span class="ml-3">Billing & Receipts</span>
                                    </button>
                                </li>
                                <li class="mb-2">
                                    <button id="navFinance"
                                        class="flex items-center w-full p-3 rounded-lg transition duration-200 ${activeTab === 'finance' ? 'bg-blue-600' : 'hover:bg-gray-700'}">
                                        ${icons.DollarSign} <span class="ml-3">Financial Overview</span>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div class="mt-auto">
                            <button id="logoutBtn"
                                class="flex items-center w-full p-3 rounded-lg bg-red-600 hover:bg-red-700 transition duration-200 text-white">
                                ${icons.LogOut} <span class="ml-3">Logout</span>
                            </button>
                            <p class="text-xs text-gray-400 mt-4 break-all">User ID: ${userId || 'N/A'}</p>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto p-8 ${isSidebarOpen ? 'lg:ml-64' : 'lg:ml-0'} transition-all duration-300 ease-in-out">
                        <header class="bg-white rounded-xl shadow-md p-6 mb-8 flex justify-between items-center">
                            <h2 class="text-3xl font-bold text-gray-800">Welcome, ${userName}!</h2>
                            <button id="menuToggleBtn" class="p-2 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg">
                                ${isSidebarOpen ? icons.X : icons.Menu}
                            </button>
                            <div class="hidden lg:flex space-x-4">
                                <div class="flex items-center text-gray-600">
                                    ${icons.Calendar}
                                    <span class="ml-2">${new Date().toLocaleDateString('en-KE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                </div>
                            </div>
                        </header>

                        <div id="contentSection"></div>
                    </main>
                </div>
            `;

            // Add event listeners for navigation
            document.getElementById('navSummary').addEventListener('click', () => { activeTab = 'summary'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navProperties').addEventListener('click', () => { activeTab = 'properties'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navBilling').addEventListener('click', () => { activeTab = 'billing'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('navFinance').addEventListener('click', () => { activeTab = 'finance'; isSidebarOpen = false; renderDashboardPage(); });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Add event listener for the new hamburger menu button
            document.getElementById('menuToggleBtn').addEventListener('click', () => {
                isSidebarOpen = !isSidebarOpen;
                renderDashboardPage(); // Re-render to apply sidebar class change
            });


            // Render content based on active tab
            const contentSection = document.getElementById('contentSection');
            if (contentSection) { // Ensure contentSection exists before rendering into it
                if (activeTab === 'summary') {
                    contentSection.innerHTML = renderSummarySection(totalProperties, totalTenants, billsGenerated);
                } else if (activeTab === 'properties') {
                    renderPropertiesSection(contentSection);
                } else if (activeTab === 'billing') {
                    renderBillingSection(contentSection);
                } else if (activeTab === 'finance') {
                    renderFinancialSection(contentSection);
                }
            }
        }

        function renderSummarySection(totalProperties, totalUnits, billsGenerated) {
            return `
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${renderStatCard(icons.Building, "Total Properties", totalProperties)}
                    ${renderStatCard(icons.HomeIcon, "Total Units", totalUnits)}
                    ${renderStatCard(icons.Users, "Total Tenants", tenants.length)}
                    ${renderStatCard(icons.Receipt, "Bills Generated", billsGenerated)}
                </section>
            `;
        }

        function renderStatCard(icon, title, value) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                    <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                        ${icon}
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm font-medium">${title}</p>
                        <h3 class="text-2xl font-bold text-gray-900">${value}</h3>
                    </div>
                </div>
            `;
        }

        function renderPropertiesSection(parentEl) {
            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Your Properties</h3>
                        <button id="addPropertyBtn" class="bg-blue-600 text-white px-5 py-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-200 shadow-md">
                            ${icons.PlusCircle}
                            <span class="ml-2">Add Property</span>
                        </button>
                    </div>
                    <div id="propertiesList" class="space-y-6">
                        ${properties.length === 0 ? `
                            <p class="text-gray-600 text-center py-8">No properties added yet. Click "Add Property" to get started!</p>
                        ` : ''}
                    </div>
                </section>
            `;
            document.getElementById('addPropertyBtn').addEventListener('click', () => showAddPropertyModal());
            updatePropertiesList();
        }

        function updatePropertiesList() {
            const propertiesListDiv = document.getElementById('propertiesList');
            if (!propertiesListDiv) return; // Ensure the element exists

            if (properties.length === 0) {
                propertiesListDiv.innerHTML = `<p class="text-gray-600 text-center py-8">No properties added yet. Click "Add Property" to get started!</p>`;
                return;
            }

            propertiesListDiv.innerHTML = properties.map(property => {
                const currentPropertySearchQuery = propertyTenantSearchQueries[property.id]?.toLowerCase() || '';
                const tenantsForProperty = tenants.filter(t => 
                    t.propertyId === property.id && 
                    (currentPropertySearchQuery === '' || t.name.toLowerCase().includes(currentPropertySearchQuery) || t.houseNumber.toLowerCase().includes(currentPropertySearchQuery))
                );

                return `
                    <div class="border border-gray-200 rounded-lg p-5 bg-gray-50 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xl font-semibold text-gray-700">${property.name}</h4>
                            <div class="flex space-x-2">
                                <button data-property-id="${property.id}" class="add-tenant-btn bg-green-500 text-white px-4 py-2 rounded-lg text-sm flex items-center hover:bg-green-600 transition duration-200">
                                    ${icons.PlusCircle} <span class="ml-1">Add Tenant</span>
                                </button>
                                <button data-property-id="${property.id}" class="delete-property-btn bg-red-500 text-white px-4 py-2 rounded-lg text-sm flex items-center hover:bg-red-600 transition duration-200">
                                    ${icons.Trash2} <span class="ml-1">Delete Property</span>
                                </button>
                            </div>
                        </div>
                        <div class="relative mb-4">
                            <input type="text" id="tenantSearchInput-${property.id}" data-property-id="${property.id}" placeholder="Search tenants by name or house number in ${property.name}..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${currentPropertySearchQuery}">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                ${icons.Search}
                            </div>
                        </div>
                        <p class="text-gray-600 mb-3">Tenants in ${property.name}:</p>
                        ${tenantsForProperty.length === 0 ? `
                            <p class="text-gray-500 text-sm italic ml-4">No tenants added for this property yet or no matching tenants found.</p>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white rounded-lg shadow-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Name</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">House No.</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${tenantsForProperty.map(tenant => {
                                            const balanceColor = tenant.outstandingBalance > 0 ? 'text-red-600 font-semibold' : 'text-green-600';
                                            const balanceText = tenant.outstandingBalance > 0 ? `Ksh ${tenant.outstandingBalance.toFixed(2)} Due` : 'Paid';
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.name}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.houseNumber}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.houseType}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${tenant.amountCharged.toFixed(2)}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm ${balanceColor}">${balanceText}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${tenant.phoneNumber}</td>
                                                    <td class="py-3 px-4 whitespace-nowrap text-sm">
                                                        <div class="flex space-x-2">
                                                            <button data-tenant-id="${tenant.id}" class="payment-btn text-purple-600 hover:text-purple-800 transition duration-200" title="Record Payment">
                                                                ${icons.Wallet}
                                                            </button>
                                                            <button data-tenant-id="${tenant.id}" class="edit-tenant-btn text-blue-600 hover:text-blue-800 transition duration-200" title="Edit Tenant">
                                                                ${icons.Edit}
                                                            </button>
                                                            <button data-tenant-id="${tenant.id}" class="delete-tenant-btn text-red-600 hover:text-red-800 transition duration-200" title="Delete Tenant">
                                                                ${icons.Trash2}
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
            }).join('');

            // Add event listeners dynamically after updating the list
            document.querySelectorAll('.add-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.propertyId;
                    showAddTenantModal(propertyId);
                });
            });
            document.querySelectorAll('.delete-property-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const propertyId = e.currentTarget.dataset.propertyId;
                    showModal("Confirm Delete", "Are you sure you want to delete this property and all its associated tenants and bills? This action is irreversible.", "confirm", () => deleteProperty(propertyId));
                });
            });
            document.querySelectorAll('.edit-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    showEditTenantModal(tenantId);
                });
            });
            document.querySelectorAll('.delete-tenant-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    showModal("Confirm Delete", "Are you sure you want to delete this tenant and all their associated bills and payments? This action is irreversible.", "confirm", () => deleteTenant(tenantId));
                });
            });
            document.querySelectorAll('.payment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tenantId = e.currentTarget.dataset.tenantId;
                    showRecordPaymentModal(tenantId);
                });
            });
            document.querySelectorAll('input[id^="tenantSearchInput-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const propertyId = e.target.dataset.propertyId;
                    propertyTenantSearchQueries[propertyId] = e.target.value;
                    updatePropertiesList();
                });
            });
        }


        function renderBillingSection(parentEl) {
            const propertiesExist = properties.length > 0;
            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <h3 class="text-2xl font-bold text-gray-800">Billing & Receipts</h3>
                        <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                            <select id="propertyFilterForBilling" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Filter by Property</option>
                                ${properties.map(p => `<option value="${p.id}" ${p.id === selectedPropertyForBillingFilter ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <div class="relative w-full sm:w-auto">
                                <input type="text" id="billingTenantSearchInput" placeholder="Search bills by tenant..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${billingTenantSearchQuery}">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    ${icons.Search}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
                        <h4 class="text-xl font-bold text-gray-700 mb-4">Bulk Bill Generation</h4>
                        <p class="text-gray-600 mb-4">Generate a standard 'Rent + Garbage' bill for all tenants in a selected property.</p>
                        <div class="flex flex-col md:flex-row items-stretch md:items-end gap-4">
                            <div class="flex-grow">
                                <label for="bulkPropertySelect" class="block text-sm font-medium text-gray-700 mb-1">Select Property</label>
                                <select id="bulkPropertySelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    ${properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <button id="bulkGenerateBtn" class="w-full md:w-auto bg-green-600 text-white px-6 py-2 rounded-lg flex items-center justify-center hover:bg-green-700 transition duration-200 shadow-md ${!propertiesExist ? 'opacity-50 cursor-not-allowed' : ''}" ${!propertiesExist ? 'disabled' : ''}>
                                ${icons.PlusCircle}
                                <span class="ml-2">Generate Bills</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="createBillSection" class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
                        <h4 class="text-xl font-bold text-gray-700 mb-4">Create New Bill</h4>
                        <form id="billForm" class="space-y-4">
                            <div>
                                <label for="tenantSelect" class="block text-sm font-medium text-gray-700">Select Tenant</label>
                                <select id="tenantSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Select a Tenant --</option>
                                </select>
                            </div>
                            <div>
                                <label for="billType" class="block text-sm font-medium text-gray-700">Bill Type</label>
                                <select id="billType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Rent">Rent</option>
                                    <option value="Rent & Garbage">Rent & Garbage</option>
                                    <option value="Water">Water</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Miscellaneous">Miscellaneous</option>
                                </select>
                            </div>
                            <div>
                                <label for="billAmount" class="block text-sm font-medium text-gray-700">Amount (Ksh)</label>
                                <input type="number" id="billAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 10000" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center justify-center hover:bg-blue-700 transition duration-200 shadow-md">
                                ${icons.PlusCircle}
                                <span class="ml-2">Create Bill</span>
                            </button>
                        </form>
                    </div>

                    <div id="billHistorySection">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-bold text-gray-700">Bill History</h4>
                            <input type="month" id="billingHistoryMonthFilter" value="${billingHistoryFilterMonth}" class="px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div id="generatedBillsList" class="space-y-4">
                            </div>
                    </div>
                </section>
            `;
            // Add event listeners
            document.getElementById('propertyFilterForBilling').addEventListener('change', (e) => {
                selectedPropertyForBillingFilter = e.target.value;
                updateGeneratedBillsList();
            });
            document.getElementById('billingTenantSearchInput').addEventListener('input', (e) => {
                billingTenantSearchQuery = e.target.value;
                updateGeneratedBillsList();
            });
            document.getElementById('billingHistoryMonthFilter').addEventListener('change', (e) => {
                billingHistoryFilterMonth = e.target.value;
                updateGeneratedBillsList();
            });
            document.getElementById('billForm').addEventListener('submit', handleBillFormSubmit);
            document.getElementById('tenantSelect').addEventListener('change', handleTenantSelectChange);
            document.getElementById('bulkGenerateBtn').addEventListener('click', handleBulkBillGeneration);
            updateBillingTenantDropdown();
            updateGeneratedBillsList();
        }

        async function handleBulkBillGeneration() {
            const bulkGenerateBtn = document.getElementById('bulkGenerateBtn');
            const propertySelect = document.getElementById('bulkPropertySelect');
            const selectedPropertyId = propertySelect.value;
        
            if (!selectedPropertyId) {
                showModal("Error", "Please select a property to generate bills for.");
                return;
            }
        
            bulkGenerateBtn.disabled = true;
            bulkGenerateBtn.innerHTML = `<div class="loading-spinner h-5 w-5 border-2 rounded-full border-b-2 border-white animate-spin"></div><span class="ml-2">Generating...</span>`;
        
            try {
                const tenantsToBill = tenants.filter(t => t.propertyId === selectedPropertyId);
        
                if (tenantsToBill.length === 0) {
                    showModal("Info", "There are no tenants in the selected property to generate bills for.");
                    return;
                }
        
                // Get current date for bill creation
                const today = new Date();
                const billDate = today.toISOString().substring(0, 10); // YYYY-MM-DD
                const billingMonth = today.toISOString().substring(0, 7); // YYYY-MM
        
                const billPromises = tenantsToBill.map(tenant => {
                    // Check if a bill for this tenant for this month already exists
                    const existingBill = bills.find(b => b.tenantId === tenant.id && b.billingMonth === billingMonth);
                    if (existingBill) {
                        console.log(`Skipping bill for ${tenant.name} as one already exists for this month.`);
                        return Promise.resolve(); // Resolve immediately for existing bills
                    }

                    // Create the new bill object
                    const newBill = {
                        tenantId: tenant.id,
                        billType: 'Rent + Garbage',
                        rent: tenant.amountCharged,
                        water: 0,
                        garbage: tenant.garbageFee,
                        maintenance: 0,
                        miscellaneous: 0,
                        totalAmount: tenant.amountCharged + (tenant.garbageFee || 0),
                        date: billDate,
                        createdAt: new Date().toISOString(),
                        status: 'Unpaid',
                        tenantName: tenant.name,
                        houseNumber: tenant.houseNumber,
                        propertyName: tenant.propertyName,
                        billingMonth: billingMonth,
                    };
                    return addDoc(billCollectionRef, newBill);
                });
        
                await Promise.all(billPromises);
                showModal("Success", `Successfully generated standard bills for ${tenantsToBill.length} tenants in the selected property.`);
            } catch (error) {
                console.error("Error generating bulk bills:", error);
                showModal("Error", `Failed to generate bulk bills: ${error.message}`);
            } finally {
                bulkGenerateBtn.disabled = false;
                bulkGenerateBtn.innerHTML = `${icons.PlusCircle}<span class="ml-2">Generate Bills</span>`;
            }
        }

        function updateBillingTenantDropdown() {
            const tenantSelectEl = document.getElementById('tenantSelect');
            if (!tenantSelectEl) return;
            tenantSelectEl.innerHTML = `<option value="">-- Select a Tenant --</option>` + tenants.map(t => `<option value="${t.id}">${t.name} (${t.houseNumber})</option>`).join('');
        }

        async function handleBillFormSubmit(e) {
            e.preventDefault();
            const tenantId = document.getElementById('tenantSelect').value;
            const billType = document.getElementById('billType').value;
            const billAmount = parseFloat(document.getElementById('billAmount').value);
        
            if (!tenantId || isNaN(billAmount)) {
                showModal("Error", "Please select a tenant and enter a valid amount.");
                return;
            }
        
            const selectedTenant = tenants.find(t => t.id === tenantId);
            const selectedProperty = properties.find(p => p.id === selectedTenant.propertyId);
        
            const newBill = {
                tenantId: tenantId,
                billType: billType,
                rent: 0,
                water: 0,
                garbage: 0,
                maintenance: 0,
                miscellaneous: 0,
                totalAmount: billAmount,
                date: new Date().toISOString().substring(0, 10),
                createdAt: new Date().toISOString(),
                status: 'Unpaid',
                tenantName: selectedTenant.name,
                houseNumber: selectedTenant.houseNumber,
                propertyName: selectedProperty.name,
                billingMonth: new Date().toISOString().substring(0, 7)
            };
        
            // Assign amount to correct field
            if (billType === 'Rent' || billType === 'Rent & Garbage') {
                newBill.rent = billAmount;
                newBill.garbage = billType === 'Rent & Garbage' ? (selectedTenant.garbageFee || 0) : 0;
                newBill.totalAmount = newBill.rent + newBill.garbage;
            } else if (billType === 'Water') {
                newBill.water = billAmount;
            } else if (billType === 'Garbage') {
                newBill.garbage = billAmount;
            } else if (billType === 'Maintenance') {
                newBill.maintenance = billAmount;
            } else if (billType === 'Miscellaneous') {
                newBill.miscellaneous = billAmount;
            }
        
            try {
                await addDoc(billCollectionRef, newBill);
                showModal("Success", `New bill for ${selectedTenant.name} created successfully.`);
                document.getElementById('billForm').reset();
            } catch (e) {
                console.error("Error adding bill: ", e);
                showModal("Error", "Failed to create bill. Please try again.");
            }
        }
        
        function handleTenantSelectChange(e) {
            const tenantId = e.target.value;
            const billAmountInput = document.getElementById('billAmount');
            if (tenantId) {
                const selectedTenant = tenants.find(t => t.id === tenantId);
                if (selectedTenant) {
                    billAmountInput.value = selectedTenant.amountCharged;
                }
            } else {
                billAmountInput.value = '';
            }
        }


        function updateGeneratedBillsList() {
            const billsListEl = document.getElementById('generatedBillsList');
            if (!billsListEl) return;
            
            // Apply all filters
            const filteredBills = bills.filter(bill => {
                const tenant = tenants.find(t => t.id === bill.tenantId);
                const propertyMatch = !selectedPropertyForBillingFilter || (tenant && tenant.propertyId === selectedPropertyForBillingFilter);
                const tenantSearchMatch = !billingTenantSearchQuery || (bill.tenantName.toLowerCase().includes(billingTenantSearchQuery.toLowerCase()) || bill.houseNumber.toLowerCase().includes(billingTenantSearchQuery.toLowerCase()));
                const monthMatch = bill.billingMonth === billingHistoryFilterMonth;
                return propertyMatch && tenantSearchMatch && monthMatch;
            });

            if (filteredBills.length === 0) {
                billsListEl.innerHTML = `<p class="text-gray-600 text-center py-8">No bills found for the selected filters.</p>`;
                return;
            }

            billsListEl.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Tenant</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${filteredBills.map(bill => `
                                <tr class="hover:bg-gray-50">
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.tenantName} (${bill.houseNumber})</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.propertyName}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.billType}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">Ksh ${bill.totalAmount.toFixed(2)}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-800">${bill.date}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${bill.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${bill.status}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm">
                                        <div class="flex space-x-2">
                                            <button data-bill-id="${bill.id}" data-tenant-id="${bill.tenantId}" class="view-receipt-btn text-blue-600 hover:text-blue-800 transition duration-200" title="View Receipt">
                                                ${icons.FileText}
                                            </button>
                                            <button data-bill-id="${bill.id}" data-tenant-id="${bill.tenantId}" class="download-receipt-btn text-blue-600 hover:text-blue-800 transition duration-200" title="Download Receipt">
                                                ${icons.Download}
                                            </button>
                                            <button data-bill-id="${bill.id}" class="delete-bill-btn text-red-600 hover:text-red-800 transition duration-200" title="Delete Bill">
                                                ${icons.Trash2}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            // Add event listeners for new buttons
            document.querySelectorAll('.view-receipt-btn').forEach(btn => btn.addEventListener('click', (e) => showReceiptModal(e.currentTarget.dataset.billId)));
            document.querySelectorAll('.download-receipt-btn').forEach(btn => btn.addEventListener('click', (e) => generatePDF(e.currentTarget.dataset.billId)));
            document.querySelectorAll('.delete-bill-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const billId = e.currentTarget.dataset.billId;
                showModal("Confirm Delete", "Are you sure you want to delete this bill? This action is irreversible.", "confirm", () => deleteBill(billId));
            }));
        }
        
        // Render Finance Section
        function renderFinancialSection(parentEl) {
            const totalRent = bills.reduce((sum, bill) => sum + (bill.billType.includes('Rent') ? bill.rent : 0), 0);
            const totalWater = bills.reduce((sum, bill) => sum + (bill.water || 0), 0);
            const totalGarbage = bills.reduce((sum, bill) => sum + (bill.garbage || 0), 0);
            const totalMaintenance = bills.reduce((sum, bill) => sum + (bill.maintenance || 0), 0);
            const totalMiscellaneous = bills.reduce((sum, bill) => sum + (bill.miscellaneous || 0), 0);
            const totalBilled = totalRent + totalWater + totalGarbage + totalMaintenance + totalMiscellaneous;
            const totalPaid = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalOutstanding = totalBilled - totalPaid;
            
            parentEl.innerHTML = `
                <section class="bg-white rounded-xl shadow-md p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Financial Overview</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        ${renderFinanceCard(icons.Receipt, "Total Billed", totalBilled, "Ksh")}
                        ${renderFinanceCard(icons.Wallet, "Total Paid", totalPaid, "Ksh")}
                        ${renderFinanceCard(icons.DollarSign, "Outstanding Amount", totalOutstanding, "Ksh", totalOutstanding > 0 ? 'text-red-600' : 'text-green-600')}
                    </div>

                    <div class="space-y-6">
                        <div>
                            <h4 class="text-xl font-bold text-gray-700 mb-4">Summary by Category</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                ${renderCategoryCard("Rent Billed", totalRent, "Ksh")}
                                ${renderCategoryCard("Water Billed", totalWater, "Ksh")}
                                ${renderCategoryCard("Garbage Billed", totalGarbage, "Ksh")}
                                ${renderCategoryCard("Maintenance Billed", totalMaintenance, "Ksh")}
                                ${renderCategoryCard("Miscellaneous Billed", totalMiscellaneous, "Ksh")}
                            </div>
                        </div>

                        <div>
                            <h4 class="text-xl font-bold text-gray-700 mb-4">Tenant Balances</h4>
                            <div class="relative mb-4">
                                <input type="text" id="financeTenantSearchInput" placeholder="Search tenants by name..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    ${icons.Search}
                                </div>
                            </div>
                            <div id="tenantBalancesList" class="space-y-2">
                                </div>
                        </div>
                    </div>
                </section>
            `;
            updateTenantBalancesList();
            document.getElementById('financeTenantSearchInput').addEventListener('input', updateTenantBalancesList);
        }

        function renderFinanceCard(icon, title, value, unit, colorClass = 'text-gray-900') {
            return `
                <div class="bg-blue-50 p-6 rounded-xl shadow-inner flex items-center space-x-4">
                    <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                        ${icon}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">${title}</p>
                        <h3 class="text-2xl font-bold ${colorClass}">${unit} ${value.toFixed(2)}</h3>
                    </div>
                </div>
            `;
        }

        function renderCategoryCard(title, value, unit) {
            return `
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-gray-600">${title}</p>
                    <p class="text-lg font-semibold text-gray-800 mt-1">${unit} ${value.toFixed(2)}</p>
                </div>
            `;
        }

        function updateTenantBalancesList() {
            const tenantBalancesListEl = document.getElementById('tenantBalancesList');
            if (!tenantBalancesListEl) return;
            const searchQuery = document.getElementById('financeTenantSearchInput').value.toLowerCase();
            
            const tenantData = tenants.map(tenant => {
                const totalBilled = bills.filter(bill => bill.tenantId === tenant.id).reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
                const totalPaid = payments.filter(payment => payment.tenantId === tenant.id).reduce((sum, payment) => sum + (payment.amount || 0), 0);
                const outstandingBalance = totalBilled - totalPaid;

                return {
                    ...tenant,
                    totalBilled,
                    totalPaid,
                    outstandingBalance,
                };
            }).filter(t => t.name.toLowerCase().includes(searchQuery) || t.houseNumber.toLowerCase().includes(searchQuery));
            
            if (tenantData.length === 0) {
                 tenantBalancesListEl.innerHTML = `<p class="text-gray-600 text-center py-8">No tenants found matching the search criteria.</p>`;
                 return;
            }

            tenantBalancesListEl.innerHTML = tenantData.map(tenant => {
                const balanceClass = tenant.outstandingBalance > 0 ? 'text-red-600' : 'text-green-600';
                return `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-medium text-gray-900">${tenant.name} <span class="text-gray-500 text-sm">(${tenant.houseNumber})</span></p>
                            <p class="text-sm text-gray-500">${tenant.propertyName}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-gray-700">Total Billed: <span class="font-normal text-gray-600">Ksh ${tenant.totalBilled.toFixed(2)}</span></p>
                            <p class="text-sm font-semibold text-gray-700">Total Paid: <span class="font-normal text-gray-600">Ksh ${tenant.totalPaid.toFixed(2)}</span></p>
                            <p class="text-lg font-bold ${balanceClass}">Balance: Ksh ${tenant.outstandingBalance.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Action Handlers
        async function handleLoginSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');

            try {
                // Ensure auth is defined before calling its methods
                if (!auth) {
                    throw new Error("Firebase Auth service is not available.");
                }

                await signInWithEmailAndPassword(auth, email, password);
                // The onAuthStateChanged listener will handle the page redirect on success
            } catch (error) {
                console.error("Login failed:", error);
                let message = "Login failed. Please check your email and password.";
                if (error.code === 'auth/invalid-credential') {
                    message = "Invalid email or password. Please try again.";
                } else if (error.code === 'auth/network-request-failed') {
                    message = "Network error. Please check your internet connection.";
                } else if (error.code === 'auth/too-many-requests') {
                    message = "Too many failed login attempts. Please try again later.";
                }
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }
        }

        async function handleLogout() {
            try {
                if (auth) {
                    await auth.signOut();
                }
                // The onAuthStateChanged listener will handle the page redirect on success
            } catch (error) {
                console.error("Logout failed:", error);
                showModal("Logout Error", "Failed to log out. Please try again.");
            }
        }

        async function showAddPropertyModal() {
            const formHtml = `
                <form id="addPropertyForm" class="space-y-4">
                    <div>
                        <label for="propertyName" class="block text-sm font-medium text-gray-700">Property Name</label>
                        <input type="text" id="propertyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="e.g., Spring Valley Apartments" required>
                    </div>
                    <div>
                        <label for="propertyLocation" class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" id="propertyLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="e.g., Kilimani" required>
                    </div>
                    <div>
                        <label for="propertyUnits" class="block text-sm font-medium text-gray-700">Number of Units</label>
                        <input type="number" id="propertyUnits" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="e.g., 20" required min="1">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">Add Property</button>
                </form>
            `;

            showModal("Add New Property", formHtml);

            document.getElementById('addPropertyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const propertyName = document.getElementById('propertyName').value;
                const propertyLocation = document.getElementById('propertyLocation').value;
                const propertyUnits = parseInt(document.getElementById('propertyUnits').value, 10);
                
                if (isNaN(propertyUnits) || propertyUnits < 1) {
                    showModal("Error", "Please enter a valid number of units.");
                    return;
                }

                const newProperty = {
                    name: propertyName,
                    location: propertyLocation,
                    units: propertyUnits
                };

                try {
                    await addDoc(propertyCollectionRef, newProperty);
                    showModal("Success", "Property added successfully!");
                } catch (e) {
                    console.error("Error adding property: ", e);
                    showModal("Error", "Failed to add property. Please try again.");
                }
            });
        }

        async function deleteProperty(propertyId) {
            try {
                // Delete property document
                await deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/properties`, propertyId));
                
                // Get and delete all tenants associated with the property
                const qTenants = query(tenantCollectionRef, where("propertyId", "==", propertyId));
                const tenantSnapshot = await getDocs(qTenants);
                const tenantDeletePromises = tenantSnapshot.docs.map(tDoc => deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/tenants`, tDoc.id)));
                
                // Get and delete all bills associated with the property
                const qBills = query(billCollectionRef, where("propertyId", "==", propertyId));
                const billSnapshot = await getDocs(qBills);
                const billDeletePromises = billSnapshot.docs.map(bDoc => deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/bills`, bDoc.id)));
                
                // Get and delete all payments associated with the property
                const qPayments = query(paymentCollectionRef, where("propertyId", "==", propertyId));
                const paymentSnapshot = await getDocs(qPayments);
                const paymentDeletePromises = paymentSnapshot.docs.map(pDoc => deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/payments`, pDoc.id)));
                
                // Execute all deletion promises in parallel
                await Promise.all([...tenantDeletePromises, ...billDeletePromises, ...paymentDeletePromises]);

                showModal("Success", "Property and all associated data deleted successfully!");
            } catch (e) {
                console.error("Error deleting property: ", e);
                showModal("Error", "Failed to delete property. Please try again.");
            }
        }

        async function showAddTenantModal(propertyId) {
            const formHtml = `
                <form id="addTenantForm" class="space-y-4">
                    <input type="hidden" id="tenantPropertyId" value="${propertyId}">
                    <div>
                        <label for="tenantName" class="block text-sm font-medium text-gray-700">Tenant Name</label>
                        <input type="text" id="tenantName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="houseNumber" class="block text-sm font-medium text-gray-700">House Number/Unit</label>
                        <input type="text" id="houseNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="houseType" class="block text-sm font-medium text-gray-700">House Type</label>
                        <select id="houseType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                            ${houseTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="amountCharged" class="block text-sm font-medium text-gray-700">Monthly Rent (Ksh)</label>
                        <input type="number" id="amountCharged" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required min="0">
                    </div>
                    <div>
                        <label for="garbageFee" class="block text-sm font-medium text-gray-700">Monthly Garbage Fee (Ksh)</label>
                        <input type="number" id="garbageFee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" value="300" min="0">
                    </div>
                    <div>
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="phoneNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">Add Tenant</button>
                </form>
            `;
            const property = properties.find(p => p.id === propertyId);
            showModal(`Add Tenant to ${property.name}`, formHtml);

            document.getElementById('addTenantForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newTenant = {
                    name: document.getElementById('tenantName').value,
                    houseNumber: document.getElementById('houseNumber').value,
                    houseType: document.getElementById('houseType').value,
                    amountCharged: parseFloat(document.getElementById('amountCharged').value),
                    garbageFee: parseFloat(document.getElementById('garbageFee').value),
                    phoneNumber: document.getElementById('phoneNumber').value,
                    propertyId: document.getElementById('tenantPropertyId').value,
                    propertyName: property.name,
                    outstandingBalance: 0 // Initialize balance to zero
                };

                try {
                    await addDoc(tenantCollectionRef, newTenant);
                    showModal("Success", "Tenant added successfully!");
                } catch (e) {
                    console.error("Error adding tenant: ", e);
                    showModal("Error", "Failed to add tenant. Please try again.");
                }
            });
        }

        async function showEditTenantModal(tenantId) {
            const tenantToEdit = tenants.find(t => t.id === tenantId);
            if (!tenantToEdit) {
                showModal("Error", "Tenant not found.");
                return;
            }
            const formHtml = `
                <form id="editTenantForm" class="space-y-4">
                    <input type="hidden" id="editTenantId" value="${tenantToEdit.id}">
                    <div>
                        <label for="editTenantName" class="block text-sm font-medium text-gray-700">Tenant Name</label>
                        <input type="text" id="editTenantName" value="${tenantToEdit.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="editHouseNumber" class="block text-sm font-medium text-gray-700">House Number/Unit</label>
                        <input type="text" id="editHouseNumber" value="${tenantToEdit.houseNumber}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="editHouseType" class="block text-sm font-medium text-gray-700">House Type</label>
                        <select id="editHouseType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                            ${houseTypes.map(type => `<option value="${type}" ${tenantToEdit.houseType === type ? 'selected' : ''}>${type}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="editAmountCharged" class="block text-sm font-medium text-gray-700">Monthly Rent (Ksh)</label>
                        <input type="number" id="editAmountCharged" value="${tenantToEdit.amountCharged}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required min="0">
                    </div>
                    <div>
                        <label for="editGarbageFee" class="block text-sm font-medium text-gray-700">Monthly Garbage Fee (Ksh)</label>
                        <input type="number" id="editGarbageFee" value="${tenantToEdit.garbageFee}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" min="0">
                    </div>
                    <div>
                        <label for="editPhoneNumber" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="editPhoneNumber" value="${tenantToEdit.phoneNumber}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">Update Tenant</button>
                </form>
            `;
            showModal(`Edit Tenant: ${tenantToEdit.name}`, formHtml);

            document.getElementById('editTenantForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const updatedTenant = {
                    name: document.getElementById('editTenantName').value,
                    houseNumber: document.getElementById('editHouseNumber').value,
                    houseType: document.getElementById('editHouseType').value,
                    amountCharged: parseFloat(document.getElementById('editAmountCharged').value),
                    garbageFee: parseFloat(document.getElementById('editGarbageFee').value),
                    phoneNumber: document.getElementById('editPhoneNumber').value,
                };
                
                try {
                    const tenantRef = doc(db, `artifacts/default-app-id/users/${userId}/tenants`, tenantId);
                    await updateDoc(tenantRef, updatedTenant);
                    showModal("Success", "Tenant updated successfully!");
                } catch (e) {
                    console.error("Error updating tenant: ", e);
                    showModal("Error", "Failed to update tenant. Please try again.");
                }
            });
        }

        async function deleteTenant(tenantId) {
            try {
                // Delete tenant document
                await deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/tenants`, tenantId));
                
                // Delete all bills associated with the tenant
                const qBills = query(billCollectionRef, where("tenantId", "==", tenantId));
                const billSnapshot = await getDocs(qBills);
                const billDeletePromises = billSnapshot.docs.map(bDoc => deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/bills`, bDoc.id)));
                
                // Delete all payments associated with the tenant
                const qPayments = query(paymentCollectionRef, where("tenantId", "==", tenantId));
                const paymentSnapshot = await getDocs(qPayments);
                const paymentDeletePromises = paymentSnapshot.docs.map(pDoc => deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/payments`, pDoc.id)));
                
                await Promise.all([...billDeletePromises, ...paymentDeletePromises]);

                showModal("Success", "Tenant and all associated data deleted successfully!");
            } catch (e) {
                console.error("Error deleting tenant: ", e);
                showModal("Error", "Failed to delete tenant. Please try again.");
            }
        }

        async function showRecordPaymentModal(tenantId) {
            const tenantToPay = tenants.find(t => t.id === tenantId);
            if (!tenantToPay) {
                showModal("Error", "Tenant not found.");
                return;
            }
            const formHtml = `
                <form id="recordPaymentForm" class="space-y-4">
                    <p class="text-gray-700">Recording payment for: <span class="font-bold">${tenantToPay.name} (${tenantToPay.houseNumber})</span></p>
                    <div>
                        <label for="paymentAmount" class="block text-sm font-medium text-gray-700">Amount Paid (Ksh)</label>
                        <input type="number" id="paymentAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" placeholder="e.g., 10000" required min="0">
                    </div>
                    <div>
                        <label for="paymentDate" class="block text-sm font-medium text-gray-700">Payment Date</label>
                        <input type="date" id="paymentDate" value="${new Date().toISOString().substring(0, 10)}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition duration-200">Record Payment</button>
                </form>
            `;
            showModal("Record Payment", formHtml);

            document.getElementById('recordPaymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                const paymentDate = document.getElementById('paymentDate').value;
                const newPayment = {
                    tenantId: tenantToPay.id,
                    amount: paymentAmount,
                    paymentDate: paymentDate,
                    createdAt: new Date().toISOString(),
                    tenantName: tenantToPay.name,
                    houseNumber: tenantToPay.houseNumber,
                    propertyId: tenantToPay.propertyId,
                    propertyName: tenantToPay.propertyName,
                };
                try {
                    await addDoc(paymentCollectionRef, newPayment);
                    showModal("Success", `Payment of Ksh ${paymentAmount.toFixed(2)} recorded for ${tenantToPay.name}.`);
                } catch (e) {
                    console.error("Error recording payment: ", e);
                    showModal("Error", "Failed to record payment. Please try again.");
                }
            });
        }
        
        async function deleteBill(billId) {
            try {
                await deleteDoc(doc(db, `artifacts/default-app-id/users/${userId}/bills`, billId));
                showModal("Success", "Bill deleted successfully!");
            } catch (e) {
                console.error("Error deleting bill: ", e);
                showModal("Error", "Failed to delete bill. Please try again.");
            }
        }
        
        async function showReceiptModal(billId) {
            const bill = bills.find(b => b.id === billId);
            if (!bill) {
                showModal("Error", "Bill not found.");
                return;
            }
            
            const paymentsForBill = payments.filter(p => p.tenantId === bill.tenantId);
            const totalPaidForBill = paymentsForBill.reduce((sum, p) => sum + p.amount, 0);
            const outstandingBalance = bill.totalAmount - totalPaidForBill;
            
            const receiptHtml = `
                <div class="p-4 md:p-8">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Payment Receipt</h2>
                        <p class="text-gray-500 mt-2">Prince Alex Property</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-600"><strong>Receipt ID:</strong> ${bill.id.substring(0, 8).toUpperCase()}</p>
                        <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(bill.date).toLocaleDateString()}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
                        <h3 class="font-semibold text-lg mb-2 text-gray-800">Billed To:</h3>
                        <p class="text-gray-700">${bill.tenantName}</p>
                        <p class="text-gray-700">${bill.houseNumber} | ${bill.propertyName}</p>
                    </div>
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full">
                            <thead class="border-b-2">
                                <tr>
                                    <th class="text-left text-sm font-semibold text-gray-600 pb-2">Description</th>
                                    <th class="text-right text-sm font-semibold text-gray-600 pb-2">Amount (Ksh)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="py-2 text-sm text-gray-700">${bill.billType}</td>
                                    <td class="py-2 text-right text-sm text-gray-700">${bill.totalAmount.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mb-6">
                        <div class="text-right">
                            <p class="text-sm text-gray-700 font-semibold">Total Billed:</p>
                            <p class="text-2xl font-bold text-gray-800">Ksh ${bill.totalAmount.toFixed(2)}</p>
                            <p class="text-sm text-gray-700 font-semibold mt-2">Total Paid:</p>
                            <p class="text-xl font-bold text-green-600">Ksh ${totalPaidForBill.toFixed(2)}</p>
                            <p class="text-sm text-gray-700 font-semibold mt-2">Outstanding Balance:</p>
                            <p class="text-xl font-bold ${outstandingBalance > 0 ? 'text-red-600' : 'text-green-600'}">Ksh ${outstandingBalance.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="text-center text-gray-500 text-sm">
                        <p>Thank you for your payment!</p>
                    </div>
                </div>
            `;
            showModal(`Receipt for ${bill.tenantName}`, receiptHtml);
        }
        
        async function generatePDF(billId) {
            const bill = bills.find(b => b.id === billId);
            if (!bill) {
                showModal("Error", "Bill not found.");
                return;
            }

            const loadingModalContent = `<div class="text-center py-8"><div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div><p class="mt-4 text-lg text-gray-700">Generating PDF...</p></div>`;
            showModal("Generating PDF", loadingModalContent);
        
            try {
                // Fetch the content of the receipt modal
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.width = '210mm'; // A4 width
                tempDiv.style.padding = '20mm';
                tempDiv.innerHTML = `
                    <div class="p-4 md:p-8 bg-white" style="width: 100%;">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Payment Receipt</h2>
                            <p class="text-gray-500 mt-2">Prince Alex Property</p>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg mb-4">
                            <p class="text-sm text-gray-600"><strong>Receipt ID:</strong> ${bill.id.substring(0, 8).toUpperCase()}</p>
                            <p class="text-sm text-gray-600"><strong>Date:</strong> ${new Date(bill.date).toLocaleDateString()}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
                            <h3 class="font-semibold text-lg mb-2 text-gray-800">Billed To:</h3>
                            <p class="text-gray-700">${bill.tenantName}</p>
                            <p class="text-gray-700">${bill.houseNumber} | ${bill.propertyName}</p>
                        </div>
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full">
                                <thead class="border-b-2">
                                    <tr>
                                        <th class="text-left text-sm font-semibold text-gray-600 pb-2">Description</th>
                                        <th class="text-right text-sm font-semibold text-gray-600 pb-2">Amount (Ksh)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="border-b">
                                        <td class="py-2 text-sm text-gray-700">${bill.billType}</td>
                                        <td class="py-2 text-right text-sm text-gray-700">${bill.totalAmount.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="flex justify-end mb-6">
                            <div class="text-right">
                                <p class="text-sm text-gray-700 font-semibold">Total Billed:</p>
                                <p class="text-2xl font-bold text-gray-800">Ksh ${bill.totalAmount.toFixed(2)}</p>
                                <p class="text-sm text-gray-700 font-semibold mt-2">Total Paid:</p>
                                <p class="text-xl font-bold text-green-600">Ksh ${payments.filter(p => p.tenantId === bill.tenantId).reduce((sum, p) => sum + p.amount, 0).toFixed(2)}</p>
                                <p class="text-sm text-gray-700 font-semibold mt-2">Outstanding Balance:</p>
                                <p class="text-xl font-bold ${bill.totalAmount - payments.filter(p => p.tenantId === bill.tenantId).reduce((sum, p) => sum + p.amount, 0) > 0 ? 'text-red-600' : 'text-green-600'}">Ksh ${(bill.totalAmount - payments.filter(p => p.tenantId === bill.tenantId).reduce((sum, p) => sum + p.amount, 0)).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="text-center text-gray-500 text-sm">
                            <p>Thank you for your payment!</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(tempDiv);
        
                // Convert the temporary div to a canvas using html2canvas
                const canvas = await html2canvas(tempDiv, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
        
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
        
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
        
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save(`rent-receipt-${bill.tenantName.replace(/\s/g, '-')}-${bill.houseNumber}.pdf`);
                
                showModal("Receipt Generated", "The PDF receipt has been generated and downloaded.");
            } catch (err) {
                console.error("Error generating PDF for all receipts:", err);
                showModal("Error", `Failed to generate PDF for ${bill.tenantName}. Please try again.`);
            } finally {
                document.body.removeChild(tempDiv); // Clean up temporary div
            }
        }


        // Initial render when the page loads
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
